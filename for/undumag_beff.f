*CMZ :  2.03/00 22/08/2023  09.03.52  by  Michael Scheer
*CMZ :  2.02/02 26/02/2022  12.52.35  by  Michael Scheer
*CMZ :  2.02/01 10/11/2021  10.13.19  by  Michael Scheer
*CMZ :  2.02/00 29/03/2021  09.45.50  by  Michael Scheer
*CMZ :  2.01/08 15/08/2020  08.14.56  by  Michael Scheer
*CMZ :  2.01/05 05/06/2020  17.09.33  by  Michael Scheer
*CMZ :  2.01/04 29/07/2019  12.05.13  by  Michael Scheer
*CMZ :  2.01/03 16/07/2019  09.25.31  by  Michael Scheer
*CMZ :  2.01/02 27/04/2018  16.20.58  by  Michael Scheer
*CMZ :  2.00/03 19/04/2018  11.05.57  by  Michael Scheer
*CMZ :  2.00/01 16/04/2018  13.46.37  by  Michael Scheer
*CMZ :  1.25/05 05/04/2018  16.46.42  by  Michael Scheer
*CMZ :  1.25/04 03/04/2018  11.15.27  by  Michael Scheer
*CMZ :  1.25/03 03/04/2018  08.01.24  by  Michael Scheer
*CMZ :  1.25/02 21/03/2018  13.03.12  by  Michael Scheer
*CMZ :  1.25/01 20/03/2018  16.17.42  by  Michael Scheer
*CMZ :  1.25/00 14/03/2018  12.58.50  by  Michael Scheer
*CMZ :  1.24/01 13/10/2017  11.37.28  by  Michael Scheer
*CMZ :  1.24/00 12/10/2017  14.05.37  by  Michael Scheer
*CMZ :  1.23/04 05/10/2017  12.07.37  by  Michael Scheer
*CMZ :  1.23/03 25/09/2017  15.55.08  by  Michael Scheer
*CMZ :  1.23/02 18/09/2017  15.18.42  by  Michael Scheer
*CMZ :  1.22/02 04/08/2017  07.56.26  by  Michael Scheer
*CMZ :  1.22/01 20/07/2017  14.55.33  by  Michael Scheer
*CMZ :  1.22/00 05/07/2017  10.09.09  by  Michael Scheer
*CMZ :  1.20/03 29/06/2017  15.38.45  by  Michael Scheer
*CMZ :  1.20/01 22/06/2017  13.35.35  by  Michael Scheer
*CMZ :  1.20/00 21/06/2017  16.39.29  by  Michael Scheer
*CMZ :  1.19/00 20/06/2017  12.15.48  by  Michael Scheer
*CMZ :  1.18/03 14/06/2017  09.22.03  by  Michael Scheer
*CMZ :  1.18/01 07/06/2017  16.12.25  by  Michael Scheer
*CMZ :  1.18/00 02/06/2017  09.38.06  by  Michael Scheer
*CMZ :  1.17/08 30/05/2017  15.20.49  by  Michael Scheer
*CMZ :  1.17/07 24/05/2017  08.36.20  by  Michael Scheer
*CMZ :  1.17/06 18/05/2017  22.30.31  by  Michael Scheer
*CMZ :  1.15/12 04/05/2017  15.55.38  by  Michael Scheer
*CMZ :  1.15/11 24/04/2017  17.57.38  by  Michael Scheer
*CMZ :  1.15/10 19/04/2017  12.15.17  by  Michael Scheer
*CMZ :  1.15/09 07/04/2017  14.51.07  by  Michael Scheer
*CMZ :  1.15/08 06/04/2017  09.01.37  by  Michael Scheer
*CMZ :  1.15/07 04/04/2017  13.49.11  by  Michael Scheer
*CMZ :  1.15/05 03/04/2017  13.40.53  by  Michael Scheer
*CMZ :  1.15/04 03/04/2017  12.57.38  by  Michael Scheer
*CMZ :  1.15/03 02/04/2017  15.45.35  by  Michael Scheer
*CMZ :  1.15/02 02/04/2017  09.38.56  by  Michael Scheer
*CMZ :  1.15/01 28/03/2017  15.25.06  by  Michael Scheer
*CMZ :  1.15/00 27/03/2017  15.13.40  by  Michael Scheer
*CMZ :  1.14/00 21/03/2017  14.39.06  by  Michael Scheer
*CMZ :  1.13/03 10/03/2017  12.16.46  by  Michael Scheer
*CMZ :  1.13/01 08/03/2017  16.26.29  by  Michael Scheer
*CMZ :  1.11/05 22/02/2017  12.53.52  by  Michael Scheer
*CMZ :  1.11/04 23/01/2017  17.22.15  by  Michael Scheer
*CMZ :  1.11/03 17/01/2017  14.50.28  by  Michael Scheer
*CMZ :  1.11/00 07/12/2016  12.48.13  by  Michael Scheer
*CMZ :  1.10/02 24/11/2016  10.22.30  by  Michael Scheer
*CMZ :  1.10/01 18/11/2016  15.52.38  by  Michael Scheer
*CMZ :  1.10/00 18/11/2016  09.18.26  by  Michael Scheer
*CMZ :  1.09/01 06/10/2016  14.12.02  by  Michael Scheer
*CMZ :  1.07/03 27/09/2016  13.45.21  by  Michael Scheer
*CMZ :  1.07/02 25/09/2016  13.30.02  by  Michael Scheer
*CMZ :  1.07/01 25/09/2016  11.49.21  by  Michael Scheer
*CMZ :  1.07/00 24/09/2016  14.57.45  by  Michael Scheer
*CMZ :  1.06/01 21/09/2016  15.31.52  by  Michael Scheer
*CMZ :  1.06/00 20/09/2016  14.13.49  by  Michael Scheer
*CMZ :  1.02/01 09/09/2016  15.30.08  by  Michael Scheer
*CMZ :  1.02/00 29/08/2016  12.45.07  by  Michael Scheer
*CMZ :  1.01/00 21/08/2016  12.03.06  by  Michael Scheer
*CMZ :  1.00/00 19/08/2016  18.37.39  by  Michael Scheer
*CMZ :  0.00/13 16/08/2016  11.57.51  by  Michael Scheer
*CMZ :  0.00/11 18/07/2016  09.18.11  by  Michael Scheer
*CMZ :  0.00/10 13/07/2016  14.57.35  by  Michael Scheer
*CMZ :  0.00/09 28/06/2016  15.42.08  by  Michael Scheer
*CMZ :  0.00/06 16/06/2016  14.14.37  by  Michael Scheer
*CMZ :  0.00/05 13/06/2016  12.45.02  by  Michael Scheer
*CMZ :  0.00/02 30/04/2016  13.12.13  by  Michael Scheer
*CMZ :  0.00/01 26/04/2016  14.02.34  by  Michael Scheer
*CMZ :  1.17/11 05/04/2016  15.51.06  by  Michael Scheer
*CMZ :  1.17/08 04/04/2016  08.57.43  by  Michael Scheer
*CMZ :  1.17/07 03/04/2016  19.38.32  by  Michael Scheer
*CMZ :  1.17/06 01/04/2016  12.58.26  by  Michael Scheer
*CMZ :  1.17/05 27/03/2016  12.40.54  by  Michael Scheer
*CMZ :  1.17/04 24/03/2016  15.11.21  by  Michael Scheer
*CMZ :  1.17/03 22/03/2016  07.59.20  by  Michael Scheer
*CMZ :  1.17/02 07/03/2016  16.32.54  by  Michael Scheer
*-- Author :    Michael Scheer   07/03/2016
      subroutine undumag_beff(xminbeff,xmaxbeff,bmnbeff,bmxbeff,beff,dkeff,
     &  bmnbeffnor,bmxbeffnor,beffnor,dkeffnor,modus)

      use bpolyederf90m
      use undumagf90m
      use commandlinef90m

      implicit none

*KEEP,seqdebug.
      include 'seqdebug.cmn'
*KEEP,random.
      include 'random.cmn'
*KEND.

      double precision, dimension (:,:,:,:), allocatable :: bmap
      double precision, dimension (:,:), allocatable :: hmvoxel,hmagvox
      double precision, dimension (:), allocatable ::
     &  xint,bxa,bya,byz,bza,bint,bint2,xinti,bxai,byai,bzai,bym,bzm,
     &  binti,bint2i,xintnor,bxanor,byanor,bzanor,bintnor,bint2nor,
     &  ws1,ws2,ws3,ws4,coef,byzanor

      integer, dimension (:), allocatable :: kfailbeff

      double precision bmnbeff,bmxbeff,beff,dkeff,bp(3),a(3),x,xx,y,z,
     &  xmaxbeff,xminbeff,dxkbmode,dx,yopt,yp(3),
     &  quadperlen,xopt,halfperlen,by,bx,bz,b,bprog,a3(3),x3(3),dkeffz,bmaxp,
     &  dkeffznor,dkeffnor,dum,bmxbeffnor,xbeffo,
     &  b3(3),beffnor,bmnbeffnor,bmaxbeffnor,bmaxbeff

      real g(3)

      integer modus,lun,idis,ixbeff,ixbeffnor,irecover,itry,ix,kfail,ibmax,
     &  ifail,ifail77,ibmin,i

      allocate (
     &  xintnor(nxbeff),bintnor(nxbeff),bint2nor(nxbeff),bxanor(nxbeff),
     &  byanor(nxbeff),bzanor(nxbeff),xint(nxbeff),bint(nxbeff),bint2(nxbeff),
     &  bxa(nxbeff),bya(nxbeff),bza(nxbeff),byz(nxbeff),
     &  ws1(nxbeff),ws2(nxbeff),ws3(nxbeff),ws4(nxbeff),coef(nxbeff),
     &  kfailbeff(nxbeff),byzanor(nxbeff))

      halfperlen=perlen/2.0d0
      quadperlen=perlen/4.0d0

      dx=(xmaxbeff-xminbeff)/(nxbeff-1)
      x=xminbeff-dx
      dxkbmode=abs(kbeffmode)*dx

      if (modus.eq.0) then
        call util_zeit_kommentar(lun6,"Writing undumag_bzeff.dat")
        open(newunit=lun,file="undumag_bzeff.dat")
      else
        call util_zeit_kommentar(lun6,"Writing undumag_byeff.dat")
        open(newunit=lun,file="undumag_byeff.dat")
      endif

      idis=0
      ixbeff=0
      ixbeffnor=0
      irecover=0
      itry=0

      do ix=1,nxbeff

12      x=xminbeff+(ix-1)*dx

        call util_random(3,g)
        g=g-0.5
        if (abs(g(1)).lt.randox10) then
          if (g(1).gt.0.0d0) then
            g(1)=g(1)+randox10
          else
            g(1)=g(1)-randox10
          endif
        endif
        if (abs(g(2)).lt.randoy10) then
          if (g(2).gt.0.0d0) then
            g(2)=g(2)+randoy10
          else
            g(2)=g(2)-randoy10
          endif
        endif
        if (abs(g(3)).lt.randoz10) then
          if (g(3).gt.0.0d0) then
            g(3)=g(3)+randoz10
          else
            g(3)=g(3)-randoz10
          endif
        endif

        if (randox.ge.0.0d0) then
          x=x+g(1)*randoxa ! millimeter!
        else
          x=x+randoxa ! millimeter!
        endif
        xint(ix)=x
        if (randoy.ge.0.0d0) then
          y=g(2)*randoya
        else
          y=randoya
        endif
        if (randoz.ge.0.0d0) then
          z=g(3)*randoza
        else
          z=randoza
        endif

        if (kbeffmode.eq.0) then

          ifail=0

          call undumag_field(x/1000.0d0,y/1000.0d0,z/1000.0d0,
     &      bxa(ix),bya(ix),bza(ix),ifail)

        else

          if (abs(abs(x-xbeff)-quadperlen).lt.dxkbmode) then
            cycle
          endif

          if (abs(x-xbeff).le.quadperlen) then

            call undumag_field(x/1000.0d0,y/1000.0d0,z/1000.0d0,
     &        bxa(ix),bya(ix),bza(ix),ifail)

          else if (x.lt.xbeff) then

            ifail=0

            call undumag_field((x+halfperlen)/1000.0d0,y/1000.0d0,z/1000.0d0,
     &        bxa(ix),bya(ix),bza(ix),ifail)

            bxa(ix)=-bxa(ix)
            bya(ix)=-bya(ix)
            bza(ix)=-bza(ix)

          else

            ifail=0

            call undumag_field((x-halfperlen)/1000.0d0,y/1000.0d0,z/1000.0d0,
     &        bxa(ix),bya(ix),bza(ix),ifail)

            bxa(ix)=-bxa(ix)
            bya(ix)=-bya(ix)
            bza(ix)=-bza(ix)

          endif

        endif !kbeffmode

        if (ifail.ne.0.and.itry.lt.10.and.ifail.ne.-1) then
          itry=itry+1
          goto 12
        endif

        itry=0

        if (ifail.gt.0) then
          if (modus.eq.0) then
            write(lun6,*)"Undumag_field returned failure for Bzeff calculation at point ",ix,xint(ix)
          else
            write(lun6,*)"Undumag_field returned failure for Byeff calculation at point ",ix,xint(ix)
          endif
        else
          if (ifail.lt.0) then
            irecover=irecover+1
          endif

          ixbeff=ixbeff+1
          kfailbeff(ixbeff)=ifail
          xint(ixbeff)=xint(ix)

          bxa(ixbeff)=bxa(ix)
          bya(ixbeff)=bya(ix)
          bza(ixbeff)=bza(ix)

          if (ifail.eq.0.or.ifail.eq.-1) then
            ixbeffnor=ixbeffnor+1
            xintnor(ixbeffnor)=xint(ix)
            bxanor(ixbeffnor)=bxa(ix)
            byanor(ixbeffnor)=bya(ix)
            bzanor(ixbeffnor)=bza(ix)
          endif
        endif
      enddo

      if (irecover.ne.0) then
        write(lun6,*)
        if (modus.eq.0) then
          write(lun6,*)"*** Warning in undumag_beff:  BzEff calculations with ",irecover, " recovered errors ***"
        else
          write(lun6,*)"*** Warning in undumag_beff:  ByEff calculations with ",irecover, " recovered errors ***"
        endif
        write(lun6,*)
      endif

c{ BEff with recovered points
      if (ixbeff.gt.0) then

        x3=xint(1:3)
        b3=bya(1:3)
        call parabel_short(x3,b3,a3)
        xint(1)=xminbeff
        bya(1)=a3(1)+a3(2)*xint(1)+a3(3)*xint(1)**2
        b3=bza(1:3)
        call parabel_short(x3,b3,a3)
        bza(1)=a3(1)+a3(2)*xint(1)+a3(3)*xint(1)**2

        x3=xint(ixbeff-2:ixbeff)
        b3=bya(ixbeff-2:ixbeff)
        call parabel_short(x3,b3,a3)
        xint(ixbeff)=xmaxbeff
        bya(ixbeff)=a3(1)+a3(2)*xint(ixbeff)+a3(3)*xint(ixbeff)**2
        b3=bza(ixbeff-2:ixbeff)
        call parabel_short(x3,b3,a3)
        bza(ixbeff)=a3(1)+a3(2)*xint(ixbeff)+a3(3)*xint(ixbeff)**2

        do i=1,ixbeff
          write(lun,*)i,xint(i),bya(i),bza(i),kfailbeff(i)
        enddo

        if (modus.eq.0) then
          byz=bza
          byzanor=bzanor
        else
          byz=bya
          byzanor=byanor
        endif

        if (isimpson.eq.0) then
          call util_spline_running_integral(xint,byz,ixbeff,bint,coef,
     &      ws1,ws2,ws3,ws4)
        else
          call util_simpson_running_integral(ixbeff,xint,byz,bint)
        endif

        bmnbeff=1.0d30
        bmxbeff=-1.0d30
        bmaxbeff=-1.0d30

        do i=1,ixbeff
          if (byz(i).gt.bmxbeff) then
            bmxbeff=byz(i)
          endif
          if (byz(i).lt.bmnbeff) then
            bmnbeff=byz(i)
          endif
          if (abs(byz(i)).gt.bmaxbeff) then
            bmaxbeff=abs(byz(i))
            ibmax=i
          endif
          bint(i)=bint(i)**2
        enddo !i=1,ixbeff

        if (ibmax.eq.1) ibmax=2
        if (ibmax.eq.ixbeff) ibmax=ixbeff-1

        yp(1)=1.0d0
        yp(2)=2.0d0
        yp(3)=3.0d0

        bp(1)=abs(byz(ibmax-1))
        bp(2)=abs(byz(ibmax))
        bp(3)=abs(byz(ibmax+1))

        call util_max_parabel(3,yp,bp,dum,bmaxp,ws1,ws2,ifail)
        if (ifail.eq.0) bmaxbeff=bmaxp

        if (isimpson.eq.0) then
          call util_spline_running_integral(xint,bint,ixbeff,bint2,coef,
     &      ws1,ws2,ws3,ws4)
        else
          call util_simpson_running_integral(ixbeff,xint,bint,bint2)
        endif

        beff= sqrt(bint2(ixbeff)/(xint(ixbeff)-xint(1)))

c Correct for endpole effects
        if (bmaxbeff.ne.0.0d0) then
          beff=beff*(bmxbeff-bmnbeff)/2.0d0/bmaxbeff
        endif

        bmaxbeff=(bmxbeff-bmnbeff)/2.0d0

        dkeff = beff * sqrt(2.0d0)  * 3.0d8 / 0.511d6 / 1000.0d0
        beff = dkeff / ((xint(ixbeff)-xint(1))*100.0d0) / 0.934d0 * 1000.0d0

      else

        write(lun6,*)
        if (modus.eq.0) then
          write(lun6,*)"*** Warning in undumag_beff: No field data for BzEff *** "
        else
          write(lun6,*)"*** Warning in undumag_beff: No field data for ByEff *** "
        endif

      endif

      flush(lun)
      close(lun)
c} BEff with recovered points

c{ BEff without recovered points
      if (ixbeffnor.gt.0) then

        x3=xintnor(1:3)
        b3=byzanor(1:3)
        call parabel_short(x3,b3,a3)
        xintnor(1)=xminbeff
        byzanor(1)=a3(1)+a3(2)*xintnor(1)+a3(3)*xintnor(1)**2

        x3=xintnor(ixbeffnor-2:ixbeffnor)
        b3=byzanor(ixbeffnor-2:ixbeffnor)
        call parabel_short(x3,b3,a3)

        xintnor(ixbeffnor)=xmaxbeff
        byzanor(ixbeffnor)=a3(1)+a3(2)*xintnor(ixbeffnor)+
     &    a3(3)*xintnor(ixbeffnor)**2

        if (isimpson.eq.0) then
          call util_spline_running_integral(xintnor,byzanor,ixbeffnor,bintnor,
     &      coef,ws1,ws2,ws3,ws4)
        else
          call util_simpson_running_integral(ixbeffnor,xintnor,byzanor,bintnor)
        endif

        bmnbeffnor=1.0d30
        bmxbeffnor=-1.0d30
        bmaxbeffnor=-1.0d30

        do i=1,ixbeffnor
          if (byzanor(i).gt.bmxbeffnor) then
            bmxbeffnor=byzanor(i)
          endif
          if (byzanor(i).lt.bmnbeffnor) then
            bmnbeffnor=byzanor(i)
          endif
          if (abs(byzanor(i)).gt.bmaxbeffnor) then
            bmaxbeffnor=abs(byzanor(i))
            ibmax=i
          endif
          bintnor(i)=bintnor(i)**2
        enddo

        if (ibmax.eq.1) ibmax=2
        if (ibmax.eq.ixbeffnor) ibmax=ixbeffnor-1

        yp(1)=1.0d0
        yp(2)=2.0d0
        yp(3)=3.0d0

        bp(1)=abs(byzanor(ibmax-1))
        bp(2)=abs(byzanor(ibmax))
        bp(3)=abs(byzanor(ibmax+1))

        call util_max_parabel(3,yp,bp,dum,bmaxp,ws1,ws2,ifail)
        if (ifail.eq.0) bmaxbeffnor=bmaxp

        if (isimpson.eq.0) then
          call util_spline_running_integral(xintnor,bintnor,ixbeffnor,bint2nor,
     &      coef,ws1,ws2,ws3,ws4)
        else
          call util_simpson_running_integral(ixbeffnor,xintnor,bintnor,bint2nor)
        endif

        beffnor= sqrt(bint2(ixbeffnor)/(xintnor(ixbeffnor)-xintnor(1)))

c Correct for endpole effects

        if (bmaxbeffnor.ne.0.0d0) then
          beffnor=beffnor*(bmxbeffnor-bmnbeffnor)/2.0d0/bmaxbeffnor
        endif

        bmaxbeffnor=(bmxbeffnor-bmnbeffnor)/2.0d0
        dkeffnor = beffnor * sqrt(2.0d0)  * 3.0d8 / 0.511d6 / 1000.0d0
        beffnor = dkeffnor / ((xintnor(ixbeffnor)-xintnor(1))*
     &    100.0d0) / 0.934d0 * 1000.0d0

        bmnbeffnor=bmnbeffnor
        bmxbeffnor=bmxbeffnor
        beffnor=beffnor
        dkeffznor=dkeffnor

      else

        write(lun6,*)
        if (modus.eq.0) then
          write(lun6,*)"*** Warning in undumag_beff: No field data for BzEffNOR *** "
        else
          write(lun6,*)"*** Warning in undumag_beff: No field data for ByEffNOR *** "
        endif

      endif

c} Beff with recovered without points

      ! Check for discontinuities

      idis=0

      do ix=4,ixbeffnor

        ifail77=0
        x=xintnor(ix)

        call util_parabel(xintnor(ix-3),byzanor(ix-3),
     &    a,yp,xopt,yopt,kfail)

        b=a(1)+a(2)*x+a(3)*x*x

        if (kfail.ne.0.or.abs(b-byzanor(ix)).gt.rcvthron) then
          ifail77=1
        endif

        if (ifail77.eq.1) then
          if (modus.eq.0) then
            write(lun6,*)"Discontinuity or numerical problems for calc. of Bzeff discovered, check rcvthron, x, dB, randox etc."
          else
            write(lun6,*)"Discontinuity or numerical problems for calc. of Byeff discovered, check rcvthron, x, dB, randox etc."
          endif
          bprog=byzanor(ix)
          write(lun6,*)"x, B, Bexpected, dB:",x,b,bprog,
     &      abs((b-bprog)/(b+bprog))
          idis=1
        endif

      enddo !ix=1,ixbeffnor

      deallocate (
     &  xintnor,bintnor,bint2nor,bxanor,byanor,bzanor,xint,bint,bint2,bxa,bya,
     &  bza,ws1,ws2,ws3,ws4,coef,kfailbeff,byzanor)

      return
      end
