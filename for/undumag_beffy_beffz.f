*CMZ :  2.03/00 25/07/2022  09.39.12  by  Michael Scheer
*CMZ :  2.02/02 26/02/2022  12.52.35  by  Michael Scheer
*CMZ :  2.02/01 10/11/2021  10.13.19  by  Michael Scheer
*CMZ :  2.02/00 29/03/2021  09.45.50  by  Michael Scheer
*CMZ :  2.01/08 15/08/2020  08.14.56  by  Michael Scheer
*CMZ :  2.01/05 05/06/2020  17.09.33  by  Michael Scheer
*CMZ :  2.01/04 29/07/2019  12.05.13  by  Michael Scheer
*CMZ :  2.01/03 16/07/2019  09.25.31  by  Michael Scheer
*CMZ :  2.01/02 27/04/2018  16.20.58  by  Michael Scheer
*CMZ :  2.00/03 19/04/2018  11.05.57  by  Michael Scheer
*CMZ :  2.00/01 16/04/2018  13.46.37  by  Michael Scheer
*CMZ :  1.25/05 05/04/2018  16.46.42  by  Michael Scheer
*CMZ :  1.25/04 03/04/2018  11.15.27  by  Michael Scheer
*CMZ :  1.25/03 03/04/2018  08.01.24  by  Michael Scheer
*CMZ :  1.25/02 21/03/2018  13.03.12  by  Michael Scheer
*CMZ :  1.25/01 20/03/2018  16.17.42  by  Michael Scheer
*CMZ :  1.25/00 14/03/2018  12.58.50  by  Michael Scheer
*CMZ :  1.24/01 13/10/2017  11.37.28  by  Michael Scheer
*CMZ :  1.24/00 12/10/2017  14.05.37  by  Michael Scheer
*CMZ :  1.23/04 05/10/2017  12.07.37  by  Michael Scheer
*CMZ :  1.23/03 25/09/2017  15.55.08  by  Michael Scheer
*CMZ :  1.23/02 18/09/2017  15.18.42  by  Michael Scheer
*CMZ :  1.22/02 04/08/2017  07.56.26  by  Michael Scheer
*CMZ :  1.22/01 20/07/2017  14.55.33  by  Michael Scheer
*CMZ :  1.22/00 05/07/2017  10.09.09  by  Michael Scheer
*CMZ :  1.20/03 29/06/2017  15.38.45  by  Michael Scheer
*CMZ :  1.20/01 22/06/2017  13.35.35  by  Michael Scheer
*CMZ :  1.20/00 21/06/2017  16.39.29  by  Michael Scheer
*CMZ :  1.19/00 20/06/2017  12.15.48  by  Michael Scheer
*CMZ :  1.18/03 14/06/2017  09.22.03  by  Michael Scheer
*CMZ :  1.18/01 07/06/2017  16.12.25  by  Michael Scheer
*CMZ :  1.18/00 02/06/2017  09.38.06  by  Michael Scheer
*CMZ :  1.17/08 30/05/2017  15.20.49  by  Michael Scheer
*CMZ :  1.17/07 24/05/2017  08.36.20  by  Michael Scheer
*CMZ :  1.17/06 18/05/2017  22.30.31  by  Michael Scheer
*CMZ :  1.15/12 04/05/2017  15.55.38  by  Michael Scheer
*CMZ :  1.15/11 24/04/2017  17.57.38  by  Michael Scheer
*CMZ :  1.15/10 19/04/2017  12.15.17  by  Michael Scheer
*CMZ :  1.15/09 07/04/2017  14.51.07  by  Michael Scheer
*CMZ :  1.15/08 06/04/2017  09.01.37  by  Michael Scheer
*CMZ :  1.15/07 04/04/2017  13.49.11  by  Michael Scheer
*CMZ :  1.15/05 03/04/2017  13.40.53  by  Michael Scheer
*CMZ :  1.15/04 03/04/2017  12.57.38  by  Michael Scheer
*CMZ :  1.15/03 02/04/2017  15.45.35  by  Michael Scheer
*CMZ :  1.15/02 02/04/2017  09.38.56  by  Michael Scheer
*CMZ :  1.15/01 28/03/2017  15.25.06  by  Michael Scheer
*CMZ :  1.15/00 27/03/2017  15.13.40  by  Michael Scheer
*CMZ :  1.14/00 21/03/2017  14.39.06  by  Michael Scheer
*CMZ :  1.13/03 10/03/2017  12.16.46  by  Michael Scheer
*CMZ :  1.13/01 08/03/2017  16.26.29  by  Michael Scheer
*CMZ :  1.11/05 22/02/2017  12.53.52  by  Michael Scheer
*CMZ :  1.11/04 23/01/2017  17.22.15  by  Michael Scheer
*CMZ :  1.11/03 17/01/2017  14.50.28  by  Michael Scheer
*CMZ :  1.11/00 07/12/2016  12.48.13  by  Michael Scheer
*CMZ :  1.10/02 24/11/2016  10.22.30  by  Michael Scheer
*CMZ :  1.10/01 18/11/2016  15.52.38  by  Michael Scheer
*CMZ :  1.10/00 18/11/2016  09.18.26  by  Michael Scheer
*CMZ :  1.09/01 06/10/2016  14.12.02  by  Michael Scheer
*CMZ :  1.07/03 27/09/2016  13.45.21  by  Michael Scheer
*CMZ :  1.07/02 25/09/2016  13.30.02  by  Michael Scheer
*CMZ :  1.07/01 25/09/2016  11.49.21  by  Michael Scheer
*CMZ :  1.07/00 24/09/2016  14.57.45  by  Michael Scheer
*CMZ :  1.06/01 21/09/2016  15.31.52  by  Michael Scheer
*CMZ :  1.06/00 20/09/2016  14.13.49  by  Michael Scheer
*CMZ :  1.02/01 09/09/2016  15.30.08  by  Michael Scheer
*CMZ :  1.02/00 29/08/2016  12.45.07  by  Michael Scheer
*CMZ :  1.01/00 21/08/2016  12.03.06  by  Michael Scheer
*CMZ :  1.00/00 19/08/2016  18.37.39  by  Michael Scheer
*CMZ :  0.00/13 16/08/2016  11.57.51  by  Michael Scheer
*CMZ :  0.00/11 18/07/2016  09.18.11  by  Michael Scheer
*CMZ :  0.00/10 13/07/2016  14.57.35  by  Michael Scheer
*CMZ :  0.00/09 28/06/2016  15.42.08  by  Michael Scheer
*CMZ :  0.00/06 16/06/2016  14.14.37  by  Michael Scheer
*CMZ :  0.00/05 13/06/2016  12.45.02  by  Michael Scheer
*CMZ :  0.00/02 30/04/2016  13.12.13  by  Michael Scheer
*CMZ :  0.00/01 26/04/2016  14.02.34  by  Michael Scheer
*CMZ :  1.17/11 05/04/2016  15.51.06  by  Michael Scheer
*CMZ :  1.17/08 04/04/2016  08.57.43  by  Michael Scheer
*CMZ :  1.17/07 03/04/2016  19.38.32  by  Michael Scheer
*CMZ :  1.17/06 01/04/2016  12.58.26  by  Michael Scheer
*CMZ :  1.17/05 27/03/2016  12.40.54  by  Michael Scheer
*CMZ :  1.17/04 24/03/2016  15.11.21  by  Michael Scheer
*CMZ :  1.17/03 22/03/2016  07.59.20  by  Michael Scheer
*CMZ :  1.17/02 07/03/2016  16.32.54  by  Michael Scheer
*-- Author :    Michael Scheer   07/03/2016
      subroutine undumag_beffy_beffz(
     &  byint1f,bzint1f,
     &  byint2f,bzint2f,
     &  byint1inf,bzint1inf,
     &  byint1fnor,bzint1fnor,
     &  byint2fnor,bzint2fnor,
     &  byexint,bzexint)

      use bpolyederf90m
      use undumagf90m
      use commandlinef90m

      implicit none

*KEEP,seqdebug.
      include 'seqdebug.cmn'
*KEEP,random.
      include 'random.cmn'
*KEEP,mshplt.
      include 'mshplt.cmn'
*KEND.

      double precision, dimension (:,:,:,:), allocatable :: bmap
      double precision, dimension (:,:), allocatable :: hmvoxel,hmagvox
      double precision, dimension (:), allocatable ::
     &  xint,bxa,bya,bza,
     &  byint,bzint,byint2,bzint2,
     &  xinti,bxai,byai,bzai,bym,bzm,
     &  byinti,bzinti,byint2i,bzint2i,
     &  xintnor,bxanor,byanor,bzanor,
     &  byintnor,bzintnor,byint2nor,bzint2nor,
     &  xintd,bxad,byad,bzad,
     &  byintd,bzintd,byint2d,bzint2d,
     &  ws1,ws2,ws3,ws4,coef

      integer, dimension (:), allocatable :: kfailbeff,kfailbyeff,kfailbzeff

      double precision bmnbeff,bmxbeff,beff,dkeff,bp(3),a(3),x,xx,y,z,
     &  xminbeffnor,xmaxbeffnor,xmaxbeff,xminbeff,dxkbmode,dx,yopt,yp(3),
     &  quadperlen,xopt,halfperlen,by,bx,bz,b,bprog,a3(3),x3(3),dkeffz,bmaxp,
     &  dkeffznor,dkeffnor,dum,bmxbeffznor,bmnbeffznor,bmxbeffz,bmxbeffnor,
     &  bmnbeffz,b3(3),beffnor,beffz,beffznor,bmnbeffnor,bmaxbeffnor,bmaxbeff,
     &  bmnbeffy,bmxbeffy,dkeffy,byint2fnor,bmnbeffynor,bmxbeffynor,dkeffynor

      double precision beffy,beffynor,byexint,bzexint,byint1f,
     &  byint1fnor,byint1inf,byint2f,bymaxbeff,bzint1f,bzint1fnor,
     &  bzint1inf,bzint2f,bzint2fnor,bzmaxbeff,xbeffo,xbymax,xbzmax

      real g(3),xpl(2),ypl(2),dxpl,yplmin,yplmax,xplmin,xplmax,dypl

      integer modus,lun,idis,ixbeff,ixbeffnor,irecover,itry,ix,kfail,ibmax,
     &  ifail,ibmin,i,nfirst,nlast

      character(64) ctitle,cline
      character(24) cbeff,cbint

      allocate (
     &  xintnor(nxbeff),
     &  byintnor(nxbeff),bzintnor(nxbeff),
     &  byint2nor(nxbeff),bzint2nor(nxbeff),
     &  bxanor(nxbeff),byanor(nxbeff),bzanor(nxbeff),
     &  xint(nxbeff),
     &  byint(nxbeff),bzint(nxbeff),
     &  byint2(nxbeff),bzint2(nxbeff),
     &  bxa(nxbeff),bya(nxbeff),bza(nxbeff),
     &  ws1(nxbeff),ws2(nxbeff),ws3(nxbeff),ws4(nxbeff),coef(nxbeff),
     &  kfailbeff(nxbeff))

c      if (xbeff.eq.9999.0d0) xbeff=xconv(nxconv/2+1)
      if (xbeff.eq.9999.0d0) xbeff=xcenter
      if (xbeff.eq.-9999.0d0) xbeff=(xmapmin+xmapmax)/2.0d0

      xbeffo=xbeff

      halfperlen=perlen/2.0d0
      quadperlen=perlen/4.0d0

      bymaxbeff=-1.0d30
      bzmaxbeff=-1.0d30

      if (kbeffmode.eq.0) then
        xminbeff=xbeff-perlen*0.51
        xmaxbeff=xbeff+perlen*0.51
        dx=(xmaxbeff-xminbeff)/(nxbeff-1)
        xminbeffnor=xminbeff
        xmaxbeffnor=xmaxbeff
        dxkbmode=abs(kbeffmode)*dx
      else
        xminbeff=xbeff-quadperlen
        xmaxbeff=xbeff+quadperlen
        dx=(xmaxbeff-xminbeff)/(nxbeff-1)
        dxkbmode=abs(kbeffmode)*dx
        xminbeffnor=xminbeff
        xmaxbeffnor=xmaxbeff
      endif

      xbymax=xbeff
      xbzmax=xbeff

      do ix=1,nxbeff

        x=xminbeff+(ix-1)*dx
        xx=x

        if (kbeffmode.ne.0.and.abs(abs(x-xbeff)-quadperlen).lt.dxkbmode) then
          cycle
        endif

        call util_random(3,g)
        g=g-0.5
c+self,if=rando10.
        if (abs(g(1)).lt.randox10) then
          if (g(1).gt.0.0d0) then
            g(1)=g(1)+randox10
          else
            g(1)=g(1)-randox10
          endif
        endif
        if (abs(g(2)).lt.randoy10) then
          if (g(2).gt.0.0d0) then
            g(2)=g(2)+randoy10
          else
            g(2)=g(2)-randoy10
          endif
        endif
        if (abs(g(3)).lt.randoz10) then
          if (g(3).gt.0.0d0) then
            g(3)=g(3)+randoz10
          else
            g(3)=g(3)-randoz10
          endif
        endif

c+self.,if=rando10.
        if (randox.ge.0.0d0) then
          x=x+g(1)*randoxa ! millimeter!
        else
          x=x+randoxa ! millimeter!
        endif

        xint(ix)=x

        if (kbeffmode.ne.0.and.abs(abs(x-xbeff)-quadperlen).lt.dxkbmode) then
          if (x.lt.xbeff) then
            x=xx+abs(xx-x)
          else
            x=xx-abs(xx-x)
          endif
        endif

        if (randoy.ge.0.0d0) then
          y=g(2)*randoya
        else
          y=randoya
        endif
        if (randoz.ge.0.0d0) then
          z=g(3)*randoza
        else
          z=randoza
        endif

        if (kbeffmode.eq.0) then
          call undumag_field(x/1000.0d0,y/1000.0d0,z/1000.0d0,
     &      bx,by,bz,ifail)
        else
          if (abs(abs(x-xbeff)-quadperlen).lt.dxkbmode) then
            cycle
          endif
          if (abs(x-xbeff).le.quadperlen) then
            call undumag_field(x/1000.0d0,y/1000.0d0,z/1000.0d0,
     &        bx,by,bz,ifail)
          else if (x.lt.xbeff) then
            call undumag_field((x+halfperlen)/1000.0d0,y/1000.0d0,z/1000.0d0,
     &        bx,by,bz,ifail)
            bx=-bx
            by=-by
            bz=-bz
          else
            call undumag_field((x-halfperlen)/1000.0d0,y/1000.0d0,z/1000.0d0,
     &        bx,by,bz,ifail)
            bx=-bx
            by=-by
            bz=-bz
          endif
        endif !kbeffmode

        if (ifail.ne.0) cycle

        if (abs(by).gt.bymaxbeff) then
          bymaxbeff=abs(by)
          xbymax=xminbeff+(ix-1)*dx
        endif

        if (abs(bz).gt.bzmaxbeff) then
          bzmaxbeff=abs(bz)
          xbzmax=xminbeff+(ix-1)*dx
        endif

      enddo !ix

      if (bymaxbeff.lt.1.0d-4*bzmaxbeff) xbymax=xbzmax
      if (bzmaxbeff.lt.1.0d-4*bymaxbeff) xbzmax=xbymax

      xbeff=xbzmax
      xminbeff=xbeff-perlen/2.0d0
      xmaxbeff=xbeff+perlen/2.0d0

      if (abs(xbeffo-xminbeff).le.quadperlen) then
        xminbeff=xminbeff-halfperlen
        xmaxbeff=xmaxbeff-halfperlen
      else if (xbeffo-xminbeff.gt.halfperlen*1.001) then
        xminbeff=xminbeff+halfperlen
        xmaxbeff=xmaxbeff+halfperlen
      endif

      if (xbeffz.ne.-9999.0d0) then
        xbeff=xbeffz
        xminbeff=xbeff-perlen/2.0d0
        xmaxbeff=xbeff+perlen/2.0d0
      endif

      call undumag_beff(xminbeff,xmaxbeff,bmnbeffy,bmxbeffy,beffy,dkeffy,
     &  bmnbeffynor,bmxbeffynor,beffynor,dkeffynor,1)
      call undumag_beff(xminbeff,xmaxbeff,bmnbeffz,bmxbeffz,beffz,dkeffz,
     &  bmnbeffznor,bmxbeffznor,beffznor,dkeffznor,0)

      write(lun6,*)
      write(lun6,*)"XminBeff, XmaxBeff (with recovered points):",
     &  sngl(xminbeff),sngl(xmaxbeff)

      if (beffz.gt.0.0d0) then
        if (abs((bmxbeffz-bmnbeffz)/2.0d0/beffz-1.0d0).gt.0.1) then
          write(lun6,*)
          write(lun6,*)"*** WARNING: BzEff differs more than 10 percent from min/max-values of Bz ***"
          write(lun6,*)
        endif
      endif

      if (beffy.gt.0.0d0) then
        if (abs((bmxbeffy-bmnbeffy)/2.0d0/beffy-1.0d0).gt.0.1) then
          write(lun6,*)
          write(lun6,*)"*** WARNING: ByEff differs more than 10 percent from min/max values of By ***"
          write(lun6,*)
        endif
      endif

      write(lun6,*)"ByMin, ByMax, (ByMax-ByMin)/2, ByEff (with recovered points):",
     &  sngl(bmnbeffy),sngl(bmxbeffy),
     &  sngl((bmxbeffy-bmnbeffy)/2.0d0),sngl(beffy)

      write(lun6,*)"BzMin, BzMax, (BzMax-BzMin)/2, BzEff (with recovered points):",
     &  sngl(bmnbeffz),sngl(bmxbeffz),
     &  sngl((bmxbeffz-bmnbeffz)/2.0d0),sngl(beffz)

      dkeff=sqrt(dkeffy**2+dkeffz**2)
      beff=sqrt(beffy**2+beffz**2)

      write(lun6,*)
      write(lun6,*)"Beff = Sqrt( ByEff**2 + BzEff**2 ) (with recovered points):",
     &  sngl(beff)
      write(lun6,*)
      write(lun6,*)"Keff and first harmonic [eV] (with recovered points):",
     &  sngl(dkeff),sngl(950.0d0*ebeam**2/(1.0d0+dkeff**2/2.0d0)/(perlen/10.0d0))
      write(lun6,*)

      write(lun6,*)
      write(lun6,*)"XminBeff, XmaxBeff (without recovered points):",
     &  sngl(xminbeffnor),sngl(xmaxbeffnor)

      write(lun6,*)"ByMin, ByMax, (ByMax-ByMin)/2, ByEff (without recovered points):",
     &  sngl(bmnbeffynor),sngl(bmxbeffynor),
     &  sngl((bmxbeffynor-bmnbeffynor)/2.0d0),sngl(beffnor)

      write(lun6,*)"BzMin, BzMax, (BzMax-BzMin)/2, BzEff (without recovered points):",
     &  sngl(bmnbeffznor),sngl(bmxbeffznor),
     &  sngl((bmxbeffznor-bmnbeffznor)/2.0d0),sngl(beffznor)

      dkeffnor=sqrt(dkeffynor**2+dkeffznor**2)
      beffnor=sqrt(beffynor**2+beffznor**2)

      write(lun6,*)
      write(lun6,*)"Beff = Sqrt( ByEff**2 + BzEff**2 ) (without recovered points):",
     &  sngl(beffnor)
      write(lun6,*)
      write(lun6,*)"Keff and first harmonic [eV] (without recovered points):",
     &  sngl(dkeffnor),sngl(950.0d0*ebeam**2/(1.0d0+dkeffnor**2/2.0d0)/
     &  (perlen/10.0d0))
      write(lun6,*)

      call util_zeit_kommentar(lun6,"Writing undumag.beff")

      open(newunit=lun,file="undumag.beff")

      write(lun,*)"* Run:"
      write(lun,*)kundurun
      write(lun,*)"* XminBeff XmaxBeff:"
      write(lun,*)
     &  sngl(xminbeff),sngl(xmaxbeff)
      write(lun,*)"* ByMin, ByMax, (ByMax-ByMin)/2, ByEff:"
      write(lun,*)
     &  sngl(bmnbeffy),sngl(bmxbeffy),
     &  sngl((bmxbeffy-bmnbeffy)/2.0d0),sngl(beffy)
      write(lun,*)"* BzMin, BzMax, (BzMax-BzMin)/2, BzEff:"
      write(lun,*)
     &  sngl(bmnbeffz),sngl(bmxbeffz),
     &  sngl((bmxbeffz-bmnbeffz)/2.0d0),sngl(beffz)
      write(lun,*)"* Beff = Sqrt( ByEff**2 + BzEff**2 ), Keff, 1. Harm. [eV]:"
      write(lun,*) sngl(beff), sngl(dkeff)
     &  ,sngl(950.0d0*ebeam**2/(1.0d0+dkeff**2/2.0d0)/(perlen/10.0d0))
      write(lun,*)"* ByInt1, BzInt1, ByInt2, BzInt2:"
      write(lun,*)
     &  sngl(byint1f),sngl(bzint1f),
     &  sngl(byint2f),sngl(bzint2f)
      write(lun,*)"* ByInt1Inf, BzInt1Inf:"
      write(lun,*)
     &  sngl(byint1inf),sngl(bzint1inf)
      write(lun,*)"* ByMin, ByMax, (ByMax-ByMin)/2, ByEff, without recovered points:"
      write(lun,*)
     &  sngl(bmnbeffynor),sngl(bmxbeffynor),
     &  sngl((bmxbeffynor-bmnbeffynor)/2.0d0),sngl(beffynor)
      write(lun,*)"* BzMin, BzMax, (BzMax-BzMin)/2, BzEff, without recovered points:"
      write(lun,*)
     &  sngl(bmnbeffznor),sngl(bmxbeffznor),
     &  sngl((bmxbeffznor-bmnbeffznor)/2.0d0),sngl(beffznor)
      write(lun,*)"* Beff = Sqrt( ByEff**2 + BzEff**2 ), without recovered points:"
      write(lun,*)
     &  sngl(beffnor)
      write(lun,*)"* ByInt1, BzInt1, ByInt2, BzInt2, without recovered points:"
      write(lun,*)
     &  sngl(byint1fnor),sngl(bzint1fnor),
     &  sngl(byint2fnor),sngl(bzint2fnor)
      write(lun,*) "External field [T]:"
      write(lun,*) sngl(bxex),sngl(byex),sngl(bzex)
      write(lun,*)"1. Integrals ByI and BzI [Tmm] of external field:"
      write(lun,*)sngl(byexint),sngl(bzexint)
      flush(lun)
      close(lun)
c Calculate beff}

      call util_zeit_kommentar(lun6,"Writing undumag_beff.eps")

      call mshplt_init(20,15.,15.,25,25,600,600,
     &  'undumag_beff.eps','','',0.)

      if (kdate.eq.0) then
        call mplopt('NDAT',1)
      else
        call mplopt('DATE',1)
      endif
      if (krunnum.ne.0) then
        write(ctitle,*)kundurun
        call util_string_trim(ctitle,nfirst,nlast)
        ctitle=trim(usercom)//", Run: "//ctitle(nfirst:nlast)
      else
        ctitle=trim(usercom)
      endif

      if (kcomment.ne.0) call mtitle(trim(ctitle))
      call mshplt_hplset('YGTI',-0.5)

      gsiz_ps=0.4

      xplmin=xbeffo-perlen
      xplmax=xbeffo+perlen

! By
      yplmin=min(-beff,-sqrt(min(bmxbeffy**2,bmnbeffy**2)+bmxbeffz**2))
      yplmax=max(beff,sqrt(bmxbeffy**2+bmxbeffz**2))
      yplmin=-max(abs(bmnbeffy),abs(bmxbeffy),abs(bmnbeffz),abs(bmxbeffz))
      yplmax=-yplmin

      dxpl=xplmax-xplmin
      dypl=yplmax-yplmin

      if (dxpl.le.1.0e-9) dxpl=1.
      if (dypl.le.1.0e-9) dypl=1.

      call mshplt_set_pad(4.,19.,3.,18.)

      call mshplt_set_text_angle(90.)
      call mshplt_text_ndc(-0.1,0.9,'B [T]')
      call mshplt_set_text_angle(0.)
      call mshplt_text_ndc(0.85,-0.1,'x [mm]')

      call mgset('CHHE',0.5)
      cbeff="Beff = "
      write(cbeff(7:14),'(f6.3)')beff
      cbeff(15:15)="T"
      call mshplt_text_ndc(0.7,0.3,cbeff)
      cbeff="Keff = "
      write(cbeff(7:14),'(f6.3)')dkeff
      call mshplt_text_ndc(0.7,0.25,cbeff)

      call mshplt_set_text_color(0,1,0,0)

      cbeff="ByMax = "
      write(cbeff(7:14),'(f6.3)')bmxbeffy
      cbeff(15:15)="T"
      call mshplt_text_ndc(0.7,0.9,cbeff)
      cbeff="ByMin = "
      write(cbeff(7:14),'(f6.3)')bmnbeffy
      cbeff(15:15)="T"
      call mshplt_text_ndc(0.7,0.83,cbeff)

      call mshplt_set_text_color(0,0,0,1)

      cbeff="BzMax = "
      write(cbeff(7:14),'(f6.3)')bmxbeffz
      cbeff(15:15)="T"
      call mshplt_text_ndc(0.7,0.75,cbeff)

      cbeff="BzMin = "
      write(cbeff(7:14),'(f6.3)')bmnbeffz
      cbeff(15:15)="T"
      call mshplt_text_ndc(0.7,0.68,cbeff)

      call mshplt_set_text_color(1,0,0,0)
      call mgset('CHHE',0.4)

      call mshplt_frame(
     &  xplmin,
     &  xplmax,
     &  yplmin-dypl*0.1,
     &  yplmax+dypl*0.1,
     &  ' ',' ',' ')

      call mshplt_set_text_angle(0.)

      call mgset('PLCI',2.)
      open(newunit=lun,file="undumag_byeff.dat")

      read(lun,*,end=91)i,xpl(1),ypl(1),bz,i

      do ix=2,nxbeff
        read(lun,*,end=91)i,xpl(2),ypl(2),bz,i
        call mpl(2,xpl,ypl)
        xpl(1)=xpl(2)
        ypl(1)=ypl(2)
      enddo

91    close(lun)

      call mgset('PLCI',4.)
      open(newunit=lun,file="undumag_bzeff.dat")

      read(lun,*,end=92)i,xpl(1),by,ypl(1),i
      do ix=2,nxbeff
        read(lun,*,end=92)i,xpl(2),by,ypl(2),i
        call mpl(2,xpl,ypl)
        xpl(1)=xpl(2)
        ypl(1)=ypl(2)
      enddo

92    close(lun)

      call muwk(0,0)
      call mshplt_end

      return
      end
