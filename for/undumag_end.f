*CMZ :          06/02/2024  15.02.28  by  Michael Scheer
*CMZ :  2.05/02 02/11/2023  14.05.20  by  Michael Scheer
*CMZ :  2.05/01 22/10/2023  14.47.55  by  Michael Scheer
*CMZ :  2.04/12 30/08/2023  11.37.07  by  Michael Scheer
*CMZ :  2.04/06 22/08/2023  09.03.52  by  Michael Scheer
*CMZ :  2.04/03 04/03/2023  16.57.37  by  Michael Scheer
*CMZ :  2.04/01 20/01/2023  13.43.13  by  Michael Scheer
*CMZ :  2.04/00 16/01/2023  14.39.15  by  Michael Scheer
*CMZ :  2.03/00 01/09/2022  10.41.39  by  Michael Scheer
*CMZ :  2.02/02 26/02/2022  12.52.35  by  Michael Scheer
*CMZ :  2.02/01 10/11/2021  10.13.19  by  Michael Scheer
*CMZ :  2.02/00 29/03/2021  09.45.50  by  Michael Scheer
*CMZ :  2.01/08 15/08/2020  08.14.56  by  Michael Scheer
*CMZ :  2.01/05 05/06/2020  17.09.33  by  Michael Scheer
*CMZ :  2.01/04 29/07/2019  12.05.13  by  Michael Scheer
*CMZ :  2.01/03 16/07/2019  09.25.31  by  Michael Scheer
*CMZ :  2.01/02 27/04/2018  16.20.58  by  Michael Scheer
*CMZ :  2.00/03 19/04/2018  11.05.57  by  Michael Scheer
*CMZ :  2.00/01 16/04/2018  13.46.37  by  Michael Scheer
*CMZ :  1.25/05 05/04/2018  16.46.42  by  Michael Scheer
*CMZ :  1.25/04 03/04/2018  11.15.27  by  Michael Scheer
*CMZ :  1.25/03 03/04/2018  08.01.24  by  Michael Scheer
*CMZ :  1.25/02 21/03/2018  13.03.12  by  Michael Scheer
*CMZ :  1.25/01 20/03/2018  16.17.42  by  Michael Scheer
*CMZ :  1.25/00 14/03/2018  12.58.50  by  Michael Scheer
*CMZ :  1.24/01 13/10/2017  11.37.28  by  Michael Scheer
*CMZ :  1.24/00 12/10/2017  14.05.37  by  Michael Scheer
*CMZ :  1.23/04 05/10/2017  12.07.37  by  Michael Scheer
*CMZ :  1.23/03 25/09/2017  15.55.08  by  Michael Scheer
*CMZ :  1.23/02 18/09/2017  15.18.42  by  Michael Scheer
*CMZ :  1.22/02 04/08/2017  07.56.26  by  Michael Scheer
*CMZ :  1.22/01 20/07/2017  14.55.33  by  Michael Scheer
*CMZ :  1.22/00 05/07/2017  10.09.09  by  Michael Scheer
*CMZ :  1.20/03 29/06/2017  15.38.45  by  Michael Scheer
*CMZ :  1.20/01 22/06/2017  13.35.35  by  Michael Scheer
*CMZ :  1.20/00 21/06/2017  16.39.29  by  Michael Scheer
*CMZ :  1.19/00 20/06/2017  12.15.48  by  Michael Scheer
*CMZ :  1.18/03 14/06/2017  09.22.03  by  Michael Scheer
*CMZ :  1.18/01 07/06/2017  16.12.25  by  Michael Scheer
*CMZ :  1.18/00 02/06/2017  09.38.06  by  Michael Scheer
*CMZ :  1.17/08 30/05/2017  15.20.49  by  Michael Scheer
*CMZ :  1.17/07 24/05/2017  08.36.20  by  Michael Scheer
*CMZ :  1.17/06 18/05/2017  22.30.31  by  Michael Scheer
*CMZ :  1.15/12 04/05/2017  15.55.38  by  Michael Scheer
*CMZ :  1.15/11 24/04/2017  17.57.38  by  Michael Scheer
*CMZ :  1.15/10 19/04/2017  12.15.17  by  Michael Scheer
*CMZ :  1.15/09 07/04/2017  14.51.07  by  Michael Scheer
*CMZ :  1.15/08 06/04/2017  09.01.37  by  Michael Scheer
*CMZ :  1.15/07 04/04/2017  13.49.11  by  Michael Scheer
*CMZ :  1.15/05 03/04/2017  13.40.53  by  Michael Scheer
*CMZ :  1.15/04 03/04/2017  12.57.38  by  Michael Scheer
*CMZ :  1.15/03 02/04/2017  15.45.35  by  Michael Scheer
*CMZ :  1.15/02 02/04/2017  09.38.56  by  Michael Scheer
*CMZ :  1.15/01 28/03/2017  15.25.06  by  Michael Scheer
*CMZ :  1.15/00 27/03/2017  15.13.40  by  Michael Scheer
*CMZ :  1.14/00 21/03/2017  14.39.06  by  Michael Scheer
*CMZ :  1.13/03 10/03/2017  12.16.46  by  Michael Scheer
*CMZ :  1.13/01 08/03/2017  16.26.29  by  Michael Scheer
*CMZ :  1.11/05 22/02/2017  12.53.52  by  Michael Scheer
*CMZ :  1.11/04 23/01/2017  17.22.15  by  Michael Scheer
*CMZ :  1.11/03 17/01/2017  14.50.28  by  Michael Scheer
*CMZ :  1.11/00 07/12/2016  12.48.13  by  Michael Scheer
*CMZ :  1.10/02 24/11/2016  10.22.30  by  Michael Scheer
*CMZ :  1.10/01 18/11/2016  15.52.38  by  Michael Scheer
*CMZ :  1.10/00 18/11/2016  09.18.26  by  Michael Scheer
*CMZ :  1.09/01 06/10/2016  14.12.02  by  Michael Scheer
*CMZ :  1.07/03 27/09/2016  13.45.21  by  Michael Scheer
*CMZ :  1.07/02 25/09/2016  13.30.02  by  Michael Scheer
*CMZ :  1.07/01 25/09/2016  11.49.21  by  Michael Scheer
*CMZ :  1.07/00 24/09/2016  14.57.45  by  Michael Scheer
*CMZ :  1.06/01 21/09/2016  15.31.52  by  Michael Scheer
*CMZ :  1.06/00 20/09/2016  14.13.49  by  Michael Scheer
*CMZ :  1.02/01 09/09/2016  15.30.08  by  Michael Scheer
*CMZ :  1.02/00 29/08/2016  12.45.07  by  Michael Scheer
*CMZ :  1.01/00 21/08/2016  12.03.06  by  Michael Scheer
*CMZ :  1.00/00 19/08/2016  18.37.39  by  Michael Scheer
*CMZ :  0.00/13 16/08/2016  11.57.51  by  Michael Scheer
*CMZ :  0.00/11 18/07/2016  09.18.11  by  Michael Scheer
*CMZ :  0.00/10 13/07/2016  14.57.35  by  Michael Scheer
*CMZ :  0.00/09 28/06/2016  15.42.08  by  Michael Scheer
*CMZ :  0.00/06 16/06/2016  14.14.37  by  Michael Scheer
*CMZ :  0.00/05 13/06/2016  12.45.02  by  Michael Scheer
*CMZ :  0.00/02 30/04/2016  13.12.13  by  Michael Scheer
*CMZ :  0.00/01 26/04/2016  14.02.34  by  Michael Scheer
*CMZ :  1.17/11 05/04/2016  15.51.06  by  Michael Scheer
*CMZ :  1.17/08 04/04/2016  08.57.43  by  Michael Scheer
*CMZ :  1.17/07 03/04/2016  19.38.32  by  Michael Scheer
*CMZ :  1.17/06 01/04/2016  12.58.26  by  Michael Scheer
*CMZ :  1.17/05 27/03/2016  12.40.54  by  Michael Scheer
*CMZ :  1.17/04 24/03/2016  15.11.21  by  Michael Scheer
*CMZ :  1.17/03 22/03/2016  07.59.20  by  Michael Scheer
*CMZ :  1.17/02 07/03/2016  16.32.54  by  Michael Scheer
*-- Author :    Michael Scheer   07/03/2016
      subroutine undumag_end

      use bpolyederf90m
      use undumagf90m
      use commandlinef90m
      use magnets_structure

      implicit none

*KEEP,debugutil,T=F77.
      include 'debugutil.cmn'
*KEEP,random.
      include 'random.cmn'
*KEND.

      double precision, dimension (:,:,:,:), allocatable :: bmap
      double precision, dimension (:,:), allocatable :: hmvoxel,hmagvox
      double precision, dimension (:), allocatable ::
     &  xint,bxa,bya,bza,
     &  byint,bzint,byint2,bzint2,
     &  xinti,byai,bzai,
     &  byinti,bzinti,byint2i,bzint2i,
     &  xintnor,bxanor,byanor,bzanor,
     &  byintnor,bzintnor,byint2nor,bzint2nor,
     &  xintd,bxad,byad,bzad,
     &  byintd,bzintd,byint2d,bzint2d,
     &  ws1,ws2,ws3,ws4,coef

      double precision :: retval,undumag_variable_getval,br

      integer, dimension (:), allocatable :: kfailbyeff,kfailbzeff,kfailon

      double precision x,y,z,bx,by,bz,hx,hy,hz,bcx,bcy,bcz,b,bprog,h,
     &  bc,dx,dy,dz,vmaglab(3),a(3),xopt,yopt,yint,zint,
     &  xminbeff,xmaxbeff,dkeffzd,
     &  bymaxbeff,bzmaxbeff,xbymax,xbzmax,xbeffo,
     &  beffd,beffzd,dkeffd,xmaxbeffnor,xminbeffnor,
     &  yp(3),bp(3),dum,bmaxp,
     &  bmaxbeffd,bmnbeffd,bmxbeffd,bmnbeffzd,bmxbeffzd,
     &  y2z2,py,pz,pryz,zr,yr,cosa,sina,
     &  xx,yy,zz,quadperlen,halfperlen,dxkbmode,bdx,bdy,bdz,x3(3),b3(3),a3(3),
     &  zmin,
     &  byif,bzif,bcrecmax,bcrecmin,bcironmax,bcironmin,bn,
     &  hcon,easy(3),easyn

      double precision :: bxexint=0.0d0, byexint=0.0d0, bzexint=0.0d0

      real g(3),xplmin,xplmax,yplmin,yplmax,zplmin,zplmax,
     &  dxpl,dypl,dzpl,xpl(2),ypl(2),zpl(2),
     &  bzplmin,bzplmax,bziplmin,bziplmax,bziiplmin,bziiplmax,
     &  byplmin,byplmax,byiplmin,byiplmax,byiiplmin,byiiplmax,
     &  s0min,s1min,s2min,s3min,s0,s1,s2,s3,
     &  s0max,s1max,s2max,s3max,xlaboff,ylaboff,brn,
     &  zppl(1000),bypl(1000),bzpl(1000),hbmatmin,hbmatmax,
     &  bcmaxrec,bcminrec,hmaxrec,hminrec,hmaxiron

      integer luninf,luni,lun,kfail,ifail77,ifail,imoth,iron,kmag,ix,iy,iz,
     &  matmap2,matmap3,n,lunmag,lunst,lunmat,lmag,
     &  lunpost,idis,mat,mtyp,imat,
     &  iplan,nplan,i,ibmax,ixon,ixonnor,
     &  itry,ixbeff,ixbeffnor,nfirst,nlast,lunkill,irecover,
     &  lunw,icorn,ncorn,nper,ibrn,kbrn,kx,kproto

      integer :: jcharge=-1,nthstep=1

      integer nstepp,nphp,npawp
      parameter (nstepp=1000000,nphp=10001,npawp=10000)

      double precision
     &  gammai,dgamtot,powden,xexit,yexit,zexit,
     &  traxyz(14,nstepp),
     &  phener(nphp),stokes(4,nphp),vnxex,vnyex,vnzex,texit,
     &  byint1f,bzint1f,byint2f,bzint2f,
     &  byint1fnor,bzint1fnor,byint2fnor,bzint2fnor,
     &  byint1fd,bzint1fd,byint2fd,bzint2fd,
     &  bxint1inf,byint1inf,bzint1inf,byi,bzi,byint1infd,bzint1infd

      complex*16 aradx(nphp),arady(nphp),aradz(nphp)

      integer :: idebug=0

      integer ndim,istatus,ifreq,istep,lunz,nz
      real hpaw(npawp)
      common/pawc/hpaw

*KEEP,mshplt.
      include 'mshplt.cmn'
*KEEP,phyconparam.
      include 'phyconparam.cmn'
*KEND.

      character(64) ctitle,chtime,chrun
      character(32) cmag,cmoth,cmodule,cmagnet,ccopy
      character(24) cbint

      save

      call  util_random_get_seed(irnsize,irnseed)

      hcon=9999.0d0
      if (halt.ne.0.0d0) then
        call undumag_bconv(hcon)
        hcon=(hcon-halt)/halt
      endif

      open(newunit=lunst,file="undumag.sta")
      write(lunst,*)kundurun,konv,iwarnsum, kiter,iterrectot,iterirontot,hresidiron,hcon
      if (konv.eq.1) then
        write(lunst,*)"Convergence reached"
      else if (konv.eq.0) then
        if (maxiter.eq.0) then
          write(lunst,*)"No iterations done due to maxiter=0"
        else
          write(lunst,*)"Maximum number of iterations reached"
        endif
      else
        write(lunst,*)"Terminated with problems"
      endif

      write(lunst,*)"undumag_end"

      flush(lunst)
      close(lunst)

      if (idebug.eq.1) then
        i_debug=1
        !all util_break
      endif

      if (krunnum.ne.0) then
        write(chrun,*)kundurun
        if (usercom.ne.'') then
          ctitle=trim(usercom)//", Run: "//trim(chrun)
        else
          ctitle=", Run: "//trim(chrun)
        endif
      else
        ctitle=trim(usercom)
      endif

      nowarnugv=1
      retval=undumag_variable_getval("nPeriods")
      if (retval.ne.-9999.0d29) then
        nper=nint(retval)
      else
        nper=-1
      endif
      nowarnugv=0

      call util_zeit_kommentar(lun6,"Writing undumag.mh")

      open(newunit=lunmag,file="undumag.mh")
      write(lunmag,'(a)') '* ' // ctitle

      if (maxiter.eq.0.and.kpreset.eq.0) goto 9999

      if (nmag.eq.0.and.kbextern.eq.0.and.ncwires.eq.0) then
        write(lun6,*)
        write(lun6,*)"*** Warning in undumag_end: Returning, since there are no magnetic items ***"
        write(lun6,*)
        goto 9999
      endif

      if (maxiter.gt.1) then

        call util_zeit_kommentar(lun6,"Writing undumag.pst")

        open(newunit=lunpost,file='undumag.pst')

        bcrecmax=-1.0d30
        bcrecmin=+1.0d30
        bcironmax=-1.0d30
        bcironmin=1.0d30

        if (nrec.eq.0) then
          bcrecmax=+0.0d0
          bcrecmin=-0.0d0
        endif
        if (niron.eq.0) then
          bcironmax=+0.0d0
          bcironmin=-0.0d0
        endif

        do kmag=1,nmag

          bn=sqrt(bpebc(4,kmag)**2+bpebc(5,kmag)**2+bpebc(6,kmag)**2)

          if (kmag.le.nrec) then
            if (bn.gt.bcrecmax) bcrecmax=bn
            if (bn.lt.bcrecmin) bcrecmin=bn
          else
            if (bn.gt.bcironmax) bcironmax=bn
            if (bn.lt.bcironmin) bcironmin=bn
          endif

          nplan=ibpeplan(kmag)
          write(lunpost,*)nplan,bpebc(1:17,kmag)
          do iplan=1,nplan
            write(lunpost,*)bpemag(1:3,1,iplan,kmag),
     &        bpetm(1:3,8,iplan,kmag)
          enddo !iplan

        enddo
        flush(lunpost)
        close(lunpost)

      endif !(maxiter.gt.0) then

      if (idebug.eq.1) then
        i_debug=2
        !all util_break
      endif

      if (maxiter.gt.0.and.maxiteriron.gt.0) call undumag_residuals_iron

      write(lun6,*)
      write(lun6,*)"File undumag.pst written."
      write(lun6,*)

      write(lun6,*)
      write(lun6,*)"Minimum and maximum magnetization of magnets:",
     &  sngl(bcrecmin),sngl(bcrecmax)
      write(lun6,*)"Minimum and maximum magnetization of iron:",
     &  sngl(bcironmin),sngl(bcironmax)
      write(lun6,*)
      write(lun6,*)"RMS of iron magnetization residuals:",
     &  sngl(hresidiron)
      write(lun6,*)

      if (nxbeff.lt.5) nxbeff=5

      allocate (
     &  kfailbyeff(nxbeff),kfailbzeff(nxbeff),kfailon(nxmap),
     &  xintnor(nxmap),
     &  byintnor(nxmap),bzintnor(nxmap),
     &  byint2nor(nxmap),bzint2nor(nxmap),
     &  xint(nxmap),
     &  byint(nxmap),bzint(nxmap),
     &  byint2(nxmap),bzint2(nxmap),
     &  xintd(nxmap),
     &  byintd(nxmap),bzintd(nxmap),
     &  byint2d(nxmap),bzint2d(nxmap),
     &  bxa(nxmap),bya(nxmap),bza(nxmap),
     &  bxanor(nxmap),byanor(nxmap),bzanor(nxmap),
     &  bxad(nxmap),byad(nxmap),bzad(nxmap),
     &  ws1(nxmap),ws2(nxmap),ws3(nxmap),ws4(nxmap),coef(nxmap))

      if (nmag.eq.0.and.ncwires+nrace.eq.0.and.kbextern.eq.0) then
        xmapmin=0.1
        xmapmax=0.1
      endif

      if (nxmap.gt.1) then
        dx=(xmapmax-xmapmin)/(nxmap-1)
        x=xmapmin-dx
      else
        xmapmin=(xmapmax+xmapmin)/2.0d0
        dx=0.0d0
      endif

      if (nymap.gt.1) then
        dy=(ymapmax-ymapmin)/(nymap-1)
        y=ymapmin-dy
      else
        ymapmin=(ymapmax+ymapmin)/2.0d0
        dy=0.0d0
      endif

      if (nzmap.gt.1) then
        dz=(zmapmax-zmapmin)/(nzmap-1)
        z=zmapmin-dz
      else
        zmapmin=(zmapmax+zmapmin)/2.0d0
        dz=0.0d0
      endif

      if (kbextern.ne.0) then
        bxexint=bxex*(xmapmax-xmapmin)
        byexint=byex*(xmapmax-xmapmin)
        bzexint=bzex*(xmapmax-xmapmin)
      endif

      if (idipoles.ne.0) then
        call util_zeit_kommentar(lun6,"Calculating dipole map")
        do ix=1,nxmap
          x=xmapmin+(ix-1)*dx
          xintd(ix)=x
          call undumag_dipoles_field(x/1000.0d0,0.0d0,0.0d0,
     &      bxad(ix),byad(ix),bzad(ix),ifail)
          if (ifail.gt.0) then
            write(lun6,*)"Undumag_dipoles_field returned failure for on-axis field at point ",
     &        ix,x,y,z
          endif
        enddo
      endif !(idipoles.ne.0) then

      if (intmaglis.ne.0) then

        if (idipoles.ne.0) then
          do kmag=1,ndipoles
            if (dipoles(8,kmag).ne.0.0d0) then
              if (dipoles(8,kmag).eq.2.0d0) then
                dipoles(4,kmag)=-dipoles(4,kmag)
              endif
            else
              dipoles(8,kmag)=-1.0d0
            endif
          enddo
        endif !(idipoles.ne.0) then

        do kmag=1,nmag
          if (bpebc(17,kmag).ne.0.0d0) then
            if (bpebc(17,kmag).eq.2.0d0) then
              bpebc(4:6,kmag)=-bpebc(4:6,kmag)
              if(bpebc(8,kmag).eq.1) then !not rectangular nor cylindrical magnet
                vmaglab(1:3)=bpebc(4:6,kmag)
                nplan=iabs(ibpeplan(kmag))
                do iplan=1,nplan
                  bpetm(1,7,iplan,kmag)=
     &              vmaglab(1)*bpetm(1,8,iplan,kmag)+
     &              vmaglab(2)*bpetm(2,8,iplan,kmag)+
     &              vmaglab(3)*bpetm(3,8,iplan,kmag)
                enddo
              endif
            endif
          else
            bpebc(17,kmag)=-1.0d0
          endif
        enddo
      endif

      x=xmapmin-dx
      ixon=0
      ixonnor=0
      irecover=0
      itry=0

      call util_zeit_kommentar(lun6,"Calculating on-axis field")

      do ix=1,nxmap
        idis=0
11      x=xmapmin+(ix-1)*dx
        ! to avoid boundary effects:
        call util_random(3,g)
        g=g-0.5
        if (abs(g(1)).lt.randox10) then
          if (g(1).gt.0.0d0) then
            g(1)=g(1)+randox10
          else
            g(1)=g(1)-randox10
          endif
        endif
        if (abs(g(2)).lt.randoy10) then
          if (g(2).gt.0.0d0) then
            g(2)=g(2)+randoy10
          else
            g(2)=g(2)-randoy10
          endif
        endif
        if (abs(g(3)).lt.randoz10) then
          if (g(3).gt.0.0d0) then
            g(3)=g(3)+randoz10
          else
            g(3)=g(3)-randoz10
          endif
        endif

        if (itry.eq.0.and.randoz.gt.0.0d0) g=0.

        if (randox.ge.0.0d0) then
          x=x+g(1)*randoxa ! millimeter!
        else
          x=x+randoxa ! millimeter!
        endif

        xint(ix)=x

        if (randoy.ge.0.0d0) then
          y=g(2)*randoya
        else
          y=randoya
        endif

        if (randoz.ge.0.0d0) then
          z=g(3)*randoza
        else
          z=randoza
        endif

        ifail=0
        kkfail=0

        if (itry.eq.0) ifail=-1

        call undumag_field(x/1000.0d0,y/1000.0d0,z/1000.0d0,
     &    bxa(ix),bya(ix),bza(ix),ifail)

        if (itry.eq.0.and.ifail.eq.-1) then
          ifail=0
        endif

        if (ifail.ne.0) kkfail=ifail

        b=sqrt(bxa(ix)**2+bya(ix)**2+bza(ix)**2)

        ifail77=0

        if (ix.gt.2) then
          call util_parabel(xint(ix-2),bxa(ix-2),
     &      a,yp,xopt,yopt,kfail)
          if (kfail.eq.0) then
            bx=a(1)+a(2)*x+a(3)*x*x
          else
            ifail77=77
          endif
          if (ifail.ne.0) kkfail=ifail
          call util_parabel(xint(ix-2),bya(ix-2),
     &      a,yp,xopt,yopt,kfail)
          if (kfail.eq.0) then
            by=a(1)+a(2)*x+a(3)*x*x
          else
            ifail77=77
          endif
          if (ifail.ne.0) kkfail=ifail
          call util_parabel(xint(ix-2),bza(ix-2),
     &      a,yp,xopt,yopt,kfail)
          if (kfail.eq.0) then
            bz=a(1)+a(2)*x+a(3)*x*x
          else
            ifail77=77
          endif
          if (ifail.ne.0) kkfail=ifail
          bprog=sqrt(bx*bx+by*by+bz*bz)
          if (bprog.gt.1.0d-9.and.abs((b-bprog)/(b+bprog)).gt.rcvthron) then
            ifail77=77
          endif
        endif

        if (bprog.gt.1.0d-9.and.ifail77.eq.77.and.idis.eq.0) then
          write(lun6,*)"Discontinuity or numerical problems for on-axis field discovered, check rcvthron, x, dB, randox etc."
          write(lun6,*)"x, B, Bexpected, dB:",x,b,bprog,abs((b-bprog)/(b+bprog))
          idis=1
        endif

        if (ifail.ne.0.and.itry.lt.10) then
          itry=itry+1
          goto 11
        endif
        itry=0

        if (ifail.gt.0) then
          write(lun6,*)"Undumag_field returned failure for on-axis field at point ",
     &      ix,x,y,z
        else
          if (ifail.lt.0) then
            irecover=irecover+1
          endif
          ixon=ixon+1
          kfailon(ixon)=ifail
          if (ifail.eq.0) then
            ixonnor=ixonnor+1
            xintnor(ixonnor)=xint(ix)
            bxanor(ixonnor)=bxa(ix)
            byanor(ixonnor)=bya(ix)
            bzanor(ixonnor)=bza(ix)
          endif
          xint(ixon)=xint(ix)
          bxa(ixon)=bxa(ix)
          bya(ixon)=bya(ix)
          bza(ixon)=bza(ix)
        endif
      enddo !ix

      if (idebug.eq.1) then
        i_debug=-1
        !all util_break
      endif

      if (irecover.ne.0) then
        write(lun6,*)
        write(lun6,*)"*** Warning in undumag_end:  On-axis field calculations with ",irecover, " recovered errors ***"
        write(lun6,*)
c        do ix=1,ixon
c          if (kfailon(ix).ne.0) then
c            write(lun6,*)ix,xint(ix),bya(ix),bza(ix)
c          endif
c        enddo
c        write(lun6,*)
      endif
      if (ixon.eq.0) then
        write(lun6,*)
        write(lun6,*)"*** Warning in undumag_end: No field data on-axis calculated ***"
        write(lun6,*)
      endif

      if (ixonnor.gt.1) then

        if (isimpson.eq.0) then
          call util_spline_running_integral(xintnor,byanor,ixonnor,byintnor,coef,
     &      ws1,ws2,ws3,ws4)
          call util_spline_running_integral(xintnor,bzanor,ixonnor,bzintnor,coef,
     &      ws1,ws2,ws3,ws4)

          call util_spline_running_integral(xintnor,byintnor,ixonnor,
     &      byint2nor,coef,
     &      ws1,ws2,ws3,ws4)
          call util_spline_running_integral(xintnor,bzintnor,ixonnor,
     &      bzint2nor,coef,
     &      ws1,ws2,ws3,ws4)
        else
          call util_simpson_running_integral(ixonnor,xintnor,byanor,byintnor)
          call util_simpson_running_integral(ixonnor,xintnor,bzanor,bzintnor)
          call util_simpson_running_integral(ixonnor,xintnor,byintnor,byint2nor)
          call util_simpson_running_integral(ixonnor,xintnor,bzintnor,bzint2nor)
        endif

      endif

      if (ixon.gt.1) then

        if (isimpson.eq.0) then
          call util_spline_running_integral(xint,bya,ixon,byint,coef,
     &      ws1,ws2,ws3,ws4)
          call util_spline_running_integral(xint,bza,ixon,bzint,coef,
     &      ws1,ws2,ws3,ws4)

          call util_spline_running_integral(xint,byint,ixon,byint2,coef,
     &      ws1,ws2,ws3,ws4)
          call util_spline_running_integral(xint,bzint,ixon,bzint2,coef,
     &      ws1,ws2,ws3,ws4)
        else
          call util_simpson_running_integral(ixon,xint,bya,byint)
          call util_simpson_running_integral(ixon,xint,bza,bzint)
          call util_simpson_running_integral(ixon,xint,byint,byint2)
          call util_simpson_running_integral(ixon,xint,bzint,bzint2)
        endif

      endif !ixon

      if (idipoles.ne.0) then
        if (nxmap.gt.0.and.maxiter.gt.0) then
          if (isimpson.eq.0) then
            call util_spline_running_integral(xintd,byad,nxmap,byintd,coef,
     &        ws1,ws2,ws3,ws4)
            call util_spline_running_integral(xintd,bzad,nxmap,bzintd,coef,
     &        ws1,ws2,ws3,ws4)

            call util_spline_running_integral(xintd,byintd,nxmap,byint2d,coef,
     &        ws1,ws2,ws3,ws4)
            call util_spline_running_integral(xintd,bzintd,nxmap,bzint2d,coef,
     &        ws1,ws2,ws3,ws4)
          else
            call util_simpson_running_integral(nxmap,xintd,byad,byintd)
            call util_simpson_running_integral(nxmap,xintd,bzad,bzintd)
            call util_simpson_running_integral(nxmap,xintd,byintd,byint2d)
            call util_simpson_running_integral(nxmap,xintd,bzintd,bzint2d)
          endif
        endif !nxmap
      endif !(idipoles.ne.0) then

      byplmin=1.0e30
      byplmax=-1.0e30
      byiplmin=1.0e30
      byiplmax=-1.0e30
      byiiplmin=1.0e30
      byiiplmax=-1.0e30
      bzplmin=1.0e30
      bzplmax=-1.0e30
      bziplmin=1.0e30
      bziplmax=-1.0e30
      bziiplmin=1.0e30
      bziiplmax=-1.0e30

c Calculate on-axis field{
      open(newunit=lun,file="undumag_on-axis.dat")

      if (ixon.gt.1) then

        do ix=1,ixon
          if (bza(ix).lt.bzplmin) bzplmin=sngl(bza(ix))
          if (bza(ix).gt.bzplmax) bzplmax=sngl(bza(ix))
          if (bzint(ix).lt.bziplmin) bziplmin=sngl(bzint(ix))
          if (bzint(ix).gt.bziplmax) bziplmax=sngl(bzint(ix))
          if (bzint2(ix).lt.bziiplmin) bziiplmin=sngl(bzint2(ix))
          if (bzint2(ix).gt.bziiplmax) bziiplmax=sngl(bzint2(ix))
          if (bya(ix).lt.byplmin) byplmin=sngl(bya(ix))
          if (bya(ix).gt.byplmax) byplmax=sngl(bya(ix))
          if (byint(ix).lt.byiplmin) byiplmin=sngl(byint(ix))
          if (byint(ix).gt.byiplmax) byiplmax=sngl(byint(ix))
          if (byint2(ix).lt.byiiplmin) byiiplmin=sngl(byint2(ix))
          if (byint2(ix).gt.byiiplmax) byiiplmax=sngl(byint2(ix))
          write(lun,'(7(1pe17.7e3)," ",I10)')xint(ix),
     &      bya(ix),bza(ix),
     &      byint(ix),bzint(ix),
     &      byint2(ix),bzint2(ix),kfailon(ix)
        enddo

      else !ixon
        write(lun,*) "0. 0. 0. 0. 0. 0. 0. 0."
      endif !ixon

      flush(lun)
      close(lun)

      if (idebug.eq.1) then
        i_debug=3
        !all util_break
      endif

c Calculate on-axis field}

      if (idipoles.ne.0) then

        open(newunit=lun,file="undumag_on-axis_dipoles.dat")

        if (nxmap.gt.1) then

          do ix=1,nxmap
            write(lun,'(10(1pe17.7e3))')xintd(ix),
     &        byad(ix),bzad(ix),
     &        byintd(ix),bzintd(ix),
     &        byint2d(ix),bzint2d(ix)
          enddo

        else !ixon
          write(lun,*) "0. 0. 0. 0. 0. 0. 0."
        endif !ixon

        flush(lun)
        close(lun)

      endif !(idipoles.ne.0) then

      if (idebug.eq.1) then
        i_debug=4
        !all util_break
      endif

c Calculate field map{

      call util_zeit_kommentar(lun6,"Calculating field map")

      open(newunit=lun,file="undumag.map")

      if (knointmap.eq.0) then
        open(newunit=luni,file="undumag_integral.map")
        call util_zeit_kommentar(lun6,"Writing undumag.map and undumag_integral.map")
      else
        call util_zeit_kommentar(lun6,"Writing undumag.map")
      endif

      if (kmapnohead.eq.0) then

        call util_time_and_date(chtime)

        if (kmapmode.eq.0) then
          write(lun,'(a)') '* ' // trim(ctitle)
          write(lun,'(a)')"* " // trim(chtime)
          write(lun,'(a)')"* imoth imag mat ityp matmod x/mm y/mm z/mm Bx/T By/T Bz/T B/T Hx/T Hy/T Hz/T H/T Mx/T My/T Mz/T M/T BxDip/T ByDip/T BzDip/T ifail kfail cmag cmoth"
        else
          write(lun,'(a)') '* ' // trim(ctitle)
          write(lun,'(a)')"* " // trim(chtime)
          write(lun,'(a)')"* x/mm y/mm z/mm Bx/T By/T Bz/T ifail kfail"
          write(lun,'(a)')"* scaling = 0.001 0.001 0.001 1.0 1.0 1.0 for WAVE"
        endif

        if (knointmap.eq.0) then
          write(luni,'(a)')"* xi/mm xe/mm y/mm z/mm ByInt1/Tmm BzInt1/Tmm ByInt2/Tmm**2 BzInt2/Tmm**2"
        endif

      endif

      if (nxmap*nymap*nzmap.le.0) then
        x=0.0d0
        y=0.0d0
        z=0.0d0
        bx=0.0d0
        by=0.0d0
        bz=0.0d0
        b=0.0d0
        hx=0.0d0
        hy=0.0d0
        hz=0.0d0
        h=0.0d0
        bcx=0.0d0
        bcy=0.0d0
        bcz=0.0d0
        bc=0.0d0
        if (kmapmode.eq.0) then
          write(lun,*)"0 0 0 0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0 '' '' "
        else
          write(lun,*)"0.0 0.0 0.0 0.0 0.0 0.0"
        endif

      else !(nxmap*nymap*nzmap.le.0) then

        irecover=0
        x=xmapmin-dx
        itry=0
        kkfail=0

        if (knointmap.eq.0) then
          allocate(xinti(nxmap),byai(nxmap),bzai(nxmap),
     &      byinti(nxmap),bzinti(nxmap),
     &      bmap(4,nxmap,nymap,nzmap),
     &      byint2i(nxmap),bzint2i(nxmap)
     &      )
        endif

        kmag=0
        do ix=1,nxmap
          x=x+dx
          y=ymapmin-dy
          do iy=1,nymap
            y=y+dy
            z=zmapmin-dz
            do iz=1,nzmap
c              if(ix.eq.109.and.iy.eq.1.and.iz.eq.82) then
c                i_debug=-7
c                !all util_break
c              endif
              z=z+dz
              if (knomagmap.eq.0.or.knopolmap.eq.0) then
                kinside=-1
              else
                kinside=0
              endif
14            call util_random(3,g)
              g=g-0.5
              if (abs(g(1)).lt.randox10) then
                if (g(1).gt.0.0d0) then
                  g(1)=g(1)+randox10
                else
                  g(1)=g(1)-randox10
                endif
              endif
              if (abs(g(2)).lt.randoy10) then
                if (g(2).gt.0.0d0) then
                  g(2)=g(2)+randoy10
                else
                  g(2)=g(2)-randoy10
                endif
              endif
              if (abs(g(3)).lt.randoz10) then
                if (g(3).gt.0.0d0) then
                  g(3)=g(3)+randoz10
                else
                  g(3)=g(3)-randoz10
                endif
              endif
              if (itry.eq.0.and.randoz.gt.0.0d0) g=0.
              if (randox.ge.0.0d0) then
                xx=x+g(1)*randoxa ! millimeter!
              else
                xx=x+randoxa ! millimeter!
              endif
              if (randoy.ge.0.0d0) then
                yy=y+g(2)*randoya
              else
                yy=y+randoya
              endif
              if (randoz.ge.0.0d0) then
                zz=z+g(3)*randoza
              else
                zz=z+randoza
              endif
              if (angmaprotx.ne.0.0d0) then
                yr=yy-cenmaprotxy
                zr=zz-cenmaprotxz
                cosa=cos(angmaprotx)
                sina=sin(angmaprotx)
                zz=cosa*zr-sina*yr+cenmaprotxz
                yy=sina*zr+cosa*yr+cenmaprotxy
              endif
c              if (ix.eq.70) i_debug=1

              ifail=0
              if (itry.eq.0) ifail=-1

              call undumag_field(xx/1000.0d0,yy/1000.0d0,zz/1000.0d0,
     &          hx,hy,hz,ifail)

              if (itry.eq.0.and.ifail.eq.-1) then
                ifail=0
              endif

              if (ifail.ne.0) kkfail=ifail
              if (ifail.eq.-20000) ifail=0 ! inside magnet
              if (ifail.ne.0.and.itry.lt.10) then
                itry=itry+1
                goto 14
              endif
              itry=0
              if (ifail.gt.0) then
                write(lun6,*)"Undumag_field returned failure at point: ",xx,yy,zz
              else if (ifail.lt.0) then
                irecover=irecover+1
              endif
c              write(lun6,*)"field:",ix,iy,iz
              if (idipoles.ne.0) then
                call undumag_dipoles_field(xx/1000.0d0,yy/1000.0d0,zz/1000.0d0,
     &            bdx,bdy,bdz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)"Undumag_dipoles_field returned failure at point: ",
     &              xx,yy,zz
                endif !(idipoles.ne.0) then
              else if (ifail.lt.0) then
                irecover=irecover+1
              endif

              if (kinside.gt.nmagtot_t) then
                write(lun6,*)"*** Error in undumag_end: kInside .gt. nMagTot_t ***"
                write(lun6,*)"kInside, nMagTot:t",kinside,nmagtot_t
                write(lun6,*)"x:y:z",xx,yy,zz
                print*,itry,ix,iy,iz
                write(lun6,*)"*** Probably colliding magnets ***"
                stop
              endif

              if (kinside.gt.0.and.kinside.le.nmagtot_t) then
                kmag=kinside
                mat=nint(bpebc(9,kmag))
                imoth=nint(bpebc(15,kmag))
                bcx=bpebc(4,kmag)
                bcy=bpebc(5,kmag)
                bcz=bpebc(6,kmag)
                matmap2=matmaps(2,mat)
                matmap3=matmaps(3,mat)
              else !kinside
                imoth=0
                kmag=0
                mat=0
                matmap2=0
                matmap3=0
                bcx=0.0d0
                bcy=0.0d0
                bcz=0.0d0
              endif !kinside

              bx=hx+bcx
              by=hy+bcy
              bz=hz+bcz
              b=sqrt(bx*bx+by*by+bz*bz)
              h=sqrt(hx*hx+hy*hy+hz*hz)
              bc=sqrt(bcx*bcx+bcy*bcy+bcz*bcz)

              if (iforcegrid.ne.0) then
                xx=x
                yy=y
                zz=z
              endif

              cmag='none'
              cmoth='none'

              if (kmapmode.eq.0) then
                if (kmag.gt.0) then
                  if (newclc.eq.0) then
                    write(cmag,'(a)') chmags(:,kmag)
                    write(cmoth,'(a)') chmoths(:,imoth)
                  else
                    cmag=t_magnets(kmag)%cnam
                    cmoth=t_magnets(kmag)%cmoth
                  endif
                endif
                write(lun,*)
     &            imoth,kmag,mat,matmap2,matmap3,
     &            sngl(xx),sngl(yy),sngl(zz),
     &            sngl(bx),sngl(by),sngl(bz),sngl(b),
     &            sngl(hx),sngl(hy),sngl(hz),sngl(h),
     &            sngl(bcx),sngl(bcy),sngl(bcz),sngl(bc),
     &            sngl(bdx),sngl(bdy),sngl(bdz),
     &            ifail,kkfail,trim(cmag),' ',trim(cmoth)
              else
                write(lun,*)
     &            sngl(xx),sngl(yy),sngl(zz),sngl(bx),sngl(by),sngl(bz),ifail,kkfail
              endif
              if (knointmap.eq.0) then
                bmap(1,ix,iy,iz)=x
                bmap(2,ix,iy,iz)=by
                bmap(3,ix,iy,iz)=bz
                bmap(4,ix,iy,iz)=ifail
               endif
            enddo !nzmap
          enddo !nymap
        enddo !nxmap

        if (irecover.ne.0) then
          write(lun6,*)
          write(lun6,*)"*** Warning in undumag_end:  Field calculations with ",irecover, " recovered errors ***"
          write(lun6,*)
        endif
      endif !(nxmap*nymap*nzmap.le.0) then

      kinside=-1
      if (knomagmap.eq.0) then
        irecover=0
        do kmag=1,nrec

          !x1y1z1
          imoth=nint(bpebc(15,kmag))
          mat=nint(bpebc(9,kmag))
          matmap2=matmaps(2,mat)
          matmap3=matmaps(3,mat)

          x=bpebc(1,kmag) !mm
          y=bpebc(2,kmag) !mm
          z=bpebc(3,kmag) !mm
          bcx=bpebc(4,kmag)
          bcy=bpebc(5,kmag)
          bcz=bpebc(6,kmag)

          call undumag_field(x/1000.0d0,y/1000.0d0,z/1000.0d0,hx,hy,hz,ifail)
          if (ifail.gt.0) then
            write(lun6,*)"Undumag_field returned failure at point: ",x,y,z
          else if (ifail.lt.0) then
            irecover=irecover+1
          endif

          bx=hx+bcx
          by=hy+bcy
          bz=hz+bcz
          b=sqrt(bx*bx+by*by+bz*bz)
          h=sqrt(hx*hx+hy*hy+hz*hz)
          bc=sqrt(bcx*bcx+bcy*bcy+bcz*bcz)

          bdx=-9.0d0
          bdy=-9.0d0
          bdz=-9.0d0

          cmag='none'
          cmoth='none'

          if (kmapmode.eq.0) then
            if (kmag.gt.0) then
              if (newclc.eq.0) then
                write(cmag,'(a)') chmags(:,kmag)
                write(cmoth,'(a)') chmoths(:,imoth)
              else
                lmag=t_voxcopy(kmag)%kmagnet
                kproto=t_magcopy(lmag)%kproto
                write(cmagnet,*)t_voxcopy(kmag)%kmagnet
                write(cmodule,*)t_voxcopy(kmag)%kmodule
                write(ccopy,*)t_voxcopy(kmag)%kcopy
                cmag=t_magnets(kproto)%cnam
                cmag=trim(adjustl(cmag)) // '_'
     &            // trim(adjustl(cmodule)) // '_'
     &            // trim(adjustl(cmagnet)) // '_'
     &            // trim(adjustl(ccopy))
                cmoth=t_magcopy(lmag)%cmoth
              endif
            endif
            write(lun,*)
     &        imoth,kmag,mat,matmap2,matmap3,
     &        sngl(x),sngl(y),sngl(z),
     &        sngl(bx),sngl(by),sngl(bz),sngl(b),
     &        sngl(hx),sngl(hy),sngl(hz),sngl(h),
     &        sngl(bcx),sngl(bcy),sngl(bcz),sngl(bc),
     &        sngl(bdx),sngl(bdy),sngl(bdz),
     &        ifail,' 0 ',trim(cmag),' ',trim(cmoth)
          else
            write(lun,*)
     &        sngl(x),sngl(y),sngl(z),sngl(bx),sngl(by),sngl(bz)
          endif
        enddo ! kmag

        if (irecover.ne.0) then
          write(lun6,*)
          write(lun6,*)"*** Warning in undumag_end:  Field calculations inside magnets with ",irecover, " recovered errors ***"
          write(lun6,*)
        endif

      endif !knomagmap

      if (knomagmap.eq.0) then

        irecover=0
        allocate(hmagvox(2,nrec))

        bcminrec=1.0e30
        bcmaxrec=-1.0e30
        hminrec=1.0e30
        hmaxrec=-1.0e30

        do kmag=1,nrec

          easy=bpebc(11:13,kmag)
          easyn=sqrt(easy(1)**2+easy(2)**2+easy(3)**2)

          imoth=nint(bpebc(15,kmag))

          mat=nint(bpebc(9,kmag))

          if (newclc.ne.0) then

            kbrn=0
            do ibrn=1,nbrnmat
              if (nint(brnmat(1,ibrn)).eq.mat) then
                kbrn=ibrn
                exit
              endif
            enddo

            if (kbrn.eq.0) then
              write(lun6,*)
              write(lun6,*)"*** Warning in undumag_end: Could not find REC material in list of Br ***"
              write(lun6,*)"*** Be careful with plots of magnetisation ***"
            endif

          else
            kbrn=1
          endif !newclc

          matmap2=matmaps(2,mat)
          matmap3=matmaps(3,mat)

          x=bpebc(1,kmag) !mm
          y=bpebc(2,kmag) !mm
          z=bpebc(3,kmag) !mm

          bcx=bpebc(4,kmag)
          bcy=bpebc(5,kmag)
          bcz=bpebc(6,kmag)
          bc=sqrt(bcx*bcx+bcy*bcy+bcz*bcz)

          call undumag_field(x/1000.0d0,y/1000.0d0,z/1000.0d0,hx,hy,hz,ifail)

          if (ifail.gt.0) then
            write(lun6,*)"Undumag_field returned failure at point: ",x,y,z
          else if (ifail.lt.0) then
            irecover=irecover+1
          endif

          h=(hx*easy(1)+hy*easy(2)+hz*easy(3))/easyn
          bc=(bcx*easy(1)+bcy*easy(2)+bcz*easy(3))/easyn

          write(lunmag,'(a,I5,1p5e12.4,2I5)')"1 ",matmap3,easy,h,bc,mat,kbrn

          hmagvox(1,kmag)=h
          hmagvox(2,kmag)=bc

          if (bc.lt.bcminrec) bcminrec=sngl(bc)
          if (bc.gt.bcmaxrec) bcmaxrec=sngl(bc)

          if (h.lt.hminrec) hminrec=sngl(h)
          if (h.gt.hmaxrec) hmaxrec=sngl(h)

        enddo ! kmag

        if (hmaxrec-hminrec.lt.1.0e-6) then
          hminrec=-2.0
          hmaxrec=0.0
        endif

        if (bcmaxrec-bcminrec.lt.1.0e-6) then
          bcminrec=0.0
          bcmaxrec=2.
        endif

        if (irecover.ne.0) then
          write(lun6,*)
          write(lun6,*)"*** Warning in undumag_end:  Field calculations inside magnets with ",irecover, " recovered errors ***"
          write(lun6,*)
        endif

      endif !knomagmap

      hmaxiron=2.5

      if (knopolmap.eq.0) then

        irecover=0
        hmaxiron=0.0

        allocate(hmvoxel(2,niron))
        iron=0

        do kmag=nrec+1,nrec+niron

          iron=iron+1

          !x1y1z1
          imoth=nint(bpebc(15,kmag))

          mat=nint(bpebc(9,kmag))

          matmap2=matmaps(2,mat)
          matmap3=matmaps(3,mat)

          x=bpebc(1,kmag) !mm
          y=bpebc(2,kmag) !mm
          z=bpebc(3,kmag) !mm

          bcx=bpebc(4,kmag)
          bcy=bpebc(5,kmag)
          bcz=bpebc(6,kmag)

          call undumag_field(x/1000.0d0,y/1000.0d0,z/1000.0d0,hx,hy,hz,ifail)

          if (ifail.gt.0) then
            write(lun6,*)"Undumag_field returned failure at point: ",x,y,z
          else if (ifail.lt.0) then
            irecover=irecover+1
          endif

          bx=hx+bcx
          by=hy+bcy
          bz=hz+bcz
          b=sqrt(bx*bx+by*by+bz*bz)
          h=sqrt(hx*hx+hy*hy+hz*hz)
          bc=sqrt(bcx*bcx+bcy*bcy+bcz*bcz)

          bdx=-9.0d0
          bdy=-9.0d0
          bdz=-9.0d0

          if (matmap2.eq.2) then
            hmvoxel(1,iron)=h
            hmvoxel(2,iron)=bc
            if (h.gt.hmaxiron) hmaxiron=sngl(h)
          endif

          cmag='none'
          cmoth='none'

          if (kmapmode.eq.0) then

            if (kmag.gt.0) then
              if (newclc.eq.0) then
                write(cmag,'(a)') chmags(:,kmag)
                write(cmoth,'(a)') chmoths(:,imoth)
              else
                lmag=t_voxcopy(kmag)%kmagnet
                kproto=t_magcopy(lmag)%kproto
                write(cmagnet,*)t_voxcopy(kmag)%kmagnet
                write(cmodule,*)t_voxcopy(kmag)%kmodule
                write(ccopy,*)t_voxcopy(kmag)%kcopy
                cmag=t_magnets(kproto)%cnam
                cmag=trim(adjustl(cmag)) // '_'
     &            // trim(adjustl(cmodule)) // '_'
     &            // trim(adjustl(cmagnet)) // '_'
     &            // trim(adjustl(ccopy))
                cmoth=t_magcopy(lmag)%cmoth
              endif
            endif

            write(lun,*)
     &        imoth,kmag,mat,matmap2,matmap3,
     &        sngl(x),sngl(y),sngl(z),
     &        sngl(bx),sngl(by),sngl(bz),sngl(b),
     &        sngl(hx),sngl(hy),sngl(hz),sngl(h),
     &        sngl(bcx),sngl(bcy),sngl(bcz),sngl(bc),
     &        sngl(bdx),sngl(bdy),sngl(bdz),
     &        ifail,' 0 ',trim(cmag),' ',trim(cmoth)
          else
            write(lun,*)
     &        sngl(x),sngl(y),sngl(z),sngl(bx),sngl(by),sngl(bz)
          endif
        enddo ! kmag

        if (irecover.ne.0) then
          write(lun6,*)
          write(lun6,*)"*** Warning in undumag_end:  Field calculations inside iron with ",irecover, " recovered errors ***"
          write(lun6,*)
        endif

      endif !knopolmap

      if (knointmap.eq.0) then

        do iy=1,nymap
          do iz=1,nzmap
            yint=ymapmin+(iy-1)*dy
            zint=zmapmin+(iz-1)*dz
            kx=0
            do ix=1,nxmap
              if (bmap(4,ix,iy,iz).ne.0.0d0) cycle
              kx=kx+1
              xinti(kx)=bmap(1,ix,iy,iz)
              byai(kx)=bmap(2,ix,iy,iz)
              bzai(kx)=bmap(3,ix,iy,iz)
            enddo !ix
            if (kx.gt.1.and.knointmap.eq.0) then
              if (isimpson.eq.0) then
                call util_spline_running_integral(xinti,byai,kx,byinti,coef,
     &            ws1,ws2,ws3,ws4)
                call util_spline_running_integral(xinti,bzai,kx,bzinti,coef,
     &            ws1,ws2,ws3,ws4)
                call util_spline_running_integral(xinti,byinti,kx,byint2i,coef,
     &            ws1,ws2,ws3,ws4)
                call util_spline_running_integral(xinti,bzinti,kx,bzint2i,coef,
     &            ws1,ws2,ws3,ws4)
              else
                call util_simpson_running_integral(kx,xinti,byai,byinti)
                call util_simpson_running_integral(kx,xinti,bzai,bzinti)
                call util_simpson_running_integral(kx,xinti,byinti,byint2i)
                call util_simpson_running_integral(kx,xinti,bzinti,bzint2i)
              endif
              write(luni,'(8(1pe17.7e3))')xinti(1),xinti(kx),yint,zint,
     &          byinti(kx),bzinti(kx),byint2i(kx),bzint2i(kx)
            endif !kx
          enddo !iz
        enddo !iy

        flush(luni)
        close(luni)

        flush(lun)
        close(lun)

      endif !knointmap

c Calculate field map}

      if (idebug.eq.1) then
        i_debug=5
        !all util_break
      endif

      call util_zeit_kommentar(lun6,"Writing undumag_mh_rec.eps")
      call mshplt_init(20,15.,15.,25,25,600,600,
     &  'undumag_mh_rec.eps','','',0.)

      if (kdate.eq.0) then
        call mplopt('NDAT',1)
      else
        call mplopt('DATE',1)
      endif

      if (kcomment.ne.0) call mtitle(trim(ctitle))
      call mshplt_hplset('YGTI',-0.5)

c{ Plot Magnetization of magnets

      if (nmag.gt.0) then

        xplmin=hminrec
        xplmax=hmaxrec
        yplmin=bcminrec
        yplmax=bcmaxrec

        dxpl=xplmax-xplmin
        dypl=yplmax-yplmin

        if (dxpl.le.1.0e-9) dxpl=1.
        if (dypl.le.1.0e-9) dypl=1.

        xplmin=xplmin-0.1*dxpl
        xplmax=xplmax+0.1*dxpl
        yplmin=yplmin-0.1*dypl
        yplmax=yplmax+0.1*dypl

        call mshplt_frame(xplmin,xplmax,yplmin,yplmax,'H [T]','M [T]',' ')
        call mshplt_set_marker_size(0.25)

        call mgset('PLCI',4.)

        xpl(1)=hminrec
        xpl(2)=hmaxrec

        do ibrn=1,nbrnmat
          mat=nint(brnmat(1,ibrn))
          brn=sngl(abs(brnmat(2,ibrn)))
          matmap2=matmaps(2,mat)
          if (matmap2.eq.1) then
            ypl(1)=brn+sngl(bcmat(2,1,mat))*xpl(1)
            ypl(2)=brn+sngl(bcmat(2,1,mat))*xpl(2)
            call mpl(2,xpl,ypl)
          else if (matmap2.eq.2) then
            ypl(1)=brn+sngl(bcmat(3,1,mat))*xpl(1)
            ypl(2)=brn+sngl(bcmat(3,1,mat))*xpl(2)
            call mpl(2,xpl,ypl)
          endif

        enddo !nbrnmat

        call mgset('PLCI',2.)

        if (knomagmap.eq.0) then
          do kmag=1,nrec
            xpl(1)=sngl(hmagvox(1,kmag))
            ypl(1)=sngl(hmagvox(2,kmag))
            call mpm(1,xpl,ypl)
          enddo
        endif

        call muwk(0,0)
        call mshplt_end

      endif !nmag
c} Plot Magnetization of magnets

      if (niron.gt.0.and.(nmag+ncwires+nrace.gt.0.or.kbextern.gt.0)) then

        call util_zeit_kommentar(lun6,"Writing undumag_mh_iron.eps")
        call mshplt_init(20,15.,15.,25,25,600,600,
     &    'undumag_mh_iron.eps','','',0.)

        if (kdate.eq.0) then
          call mplopt('NDAT',1)
        else
          call mplopt('DATE',1)
        endif
        if (krunnum.ne.0) then
          write(ctitle,*)kundurun
          call util_string_trim(ctitle,nfirst,nlast)
          ctitle=trim(usercom)//", Run: "//ctitle(nfirst:nlast)
        else
          ctitle=trim(usercom)
        endif

        if (kcomment.ne.0) call mtitle(trim(ctitle))
        call mshplt_hplset('YGTI',-0.5)

c{ Plot Magnetization of iron

        gsiz_ps=0.4

        xplmin=0.0
        xplmax=0.005
        yplmin=0.0
        yplmax=2.5

        dxpl=xplmax-xplmin
        dypl=yplmax-yplmin

        if (dxpl.le.1.0e-9) dxpl=1.
        if (dypl.le.1.0e-9) dypl=1.

        call mshplt_set_pad(3.5,10.,4.,18.)
        call mshplt_frame(xplmin,xplmax,yplmin,yplmax,'H [T]','M [T]',' ')
        call mshplt_set_marker_size(0.25)

        call mgset('PLCI',4.)

        do imat=1,nmatfiles

          if (matmaps(2,imat).eq.1) cycle

          mat=matmaps(1,imat)
          matmap2=matmaps(2,mat)
          matmap3=matmaps(3,mat)

          if (matmap3.eq.0) cycle

          if (matmap3.eq.0) then
            xpl(1)=sngl(xplmin)
            xpl(2)=sngl(xplmax)
            ypl(1:2)=sngl(bcmat(2,1,mat))
            call mpl(2,xpl,ypl)
          else
            do i=1,matmaps(4,mat)-1
              xpl(1:2)=sngl(feh1(i:i+1))
              ypl(1:2)=sngl(fem1(i:i+1))
              call mpl(2,xpl,ypl)
            enddo
          endif

        enddo !imat

        call mgset('PLCI',2.)

        if (knopolmap.eq.0) then
          do iron=1,niron
            mat=nint(bpebc(9,nrec+iron))
            matmap2=matmaps(2,mat)
            matmap3=matmaps(3,mat)
            easy=0.0
            write(lunmag,'(a,i5,1p5e12.4,2I5)')
     &        "2 ",matmap3,easy,xpl(1),ypl(1),mat, mat*0
            if (matmap3.eq.0) cycle
            xpl(1)=sngl(hmvoxel(1,iron))
            ypl(1)=sngl(hmvoxel(2,iron))
c            if (xpl(1).lt.0.01) then
              call mpm(1,xpl,ypl)
c            else
c              print*,"holla hmvoxel"
c            endif
          enddo
        endif

        call mgset('PLCI',3.)

        if (knopolmap.eq.0) then
          do iron=1,niron
            mat=nint(bpebc(9,nrec+iron))
            matmap2=matmaps(2,mat)
            matmap3=matmaps(3,mat)
            if (matmap3.ne.0) cycle
            xpl(1)=sngl(hmvoxel(1,iron))
            ypl(1)=sngl(hmvoxel(2,iron))
c            if (xpl(1).lt.0.01) then
              call mpm(1,xpl,ypl)
c            else
c              print*,"holla hmvoxel"
c            endif
            easy=0
            write(lunmag,'(a,i5,1p5e12.4,2I5)')
     &        "2 ",matmap3,easy,xpl(1),ypl(1),mat,mat*0
          enddo
        endif

        call muwk(0,0)

        xplmin=0.0
        xplmax=hmaxiron
        if (hmaxiron.eq.0.0d0) then
          xplmax=sngl(feh1(matmaps(4,2)))
        endif
        yplmin=0.0
        yplmax=2.5

        dxpl=xplmax-xplmin
        dypl=yplmax-yplmin

        if (dxpl.le.1.0e-9) dxpl=1.
        if (dypl.le.1.0e-9) dypl=1.

        call mshplt_set_pad(12.5,19.,4.,18.)
        call mshplt_frame(xplmin,xplmax,yplmin,yplmax,'H [T]','M [T]',' ')

        call mgset('PLCI',4.)
        if (matmap2.eq.0) then
          ypl(1:2)=sngl(bcmat(2,1,2))
          call mpl(2,xpl,ypl)
        else
          do i=1,matmaps(4,2)-1
            xpl(1:2)=sngl(feh1(i:i+1))
            ypl(1:2)=sngl(fem1(i:i+1))
            call mpl(2,xpl,ypl)
          enddo
        endif

        call mgset('PLCI',2.)

        if (knopolmap.eq.0) then
          do iron=1,niron
            mat=nint(bpebc(9,nrec+iron))
            matmap2=matmaps(2,mat)
            matmap3=matmaps(3,mat)
            if (matmap3.eq.0) cycle
            xpl(1)=sngl(hmvoxel(1,iron))
            ypl(1)=sngl(hmvoxel(2,iron))
            if (xpl(1).lt.0.01) call mpm(1,xpl,ypl)
          enddo
        endif

        call mgset('PLCI',3.)

        if (knopolmap.eq.0) then
          do iron=1,niron
            mat=nint(bpebc(9,nrec+iron))
            matmap2=matmaps(2,mat)
            matmap3=matmaps(3,mat)
            if (matmap3.ne.0) cycle
            xpl(1)=sngl(hmvoxel(1,iron))
            ypl(1)=sngl(hmvoxel(2,iron))
            if (xpl(1).lt.0.01) call mpm(1,xpl,ypl)
          enddo
        endif

        call mgset('PLCI',2.)

        call muwk(0,0)
        call mshplt_end

      endif !(niron.gt.0) then

c} Magnetization of iron

c      write(lun6,*)"matrix:",matrix

      write(lun6,*)"Symmetries:"
      write(lun6,*)"ixsym, iysym, izsym, xsym:",ixsymo,iysymo,izsymo,xsym

      kinside=0
      write(lun6,*)
      write(lun6,*)"Conv. points and field H[T] there:"
c      i_debug=1
      do i=1,nxconv
        call undumag_field(xconv(i),yconv,zconv,hx,hy,hz,ifail)
        if (ifail.gt.0) then
          write(lun6,*)"Undumag_field returned unrecovered failure at convergence point: ",
     &      xconv(i)*1000.0,yconv*1000.0,zconv*1000.0
        endif
        write(lun6,'(a,i6,6g15.5)')" ",i,xconv(i)*1000.,yconv*1000.,zconv*1000.,
     &    hx,hy,hz
      enddo

      byint1fnor=0.0d0
      byint2fnor=0.0d0
      bzint1fnor=0.0d0
      bzint2fnor=0.0d0

      if (ixonnor.gt.1) then
        byint1fnor=byintnor(ixonnor)
        bzint1fnor=bzintnor(ixonnor)
        byint2fnor=byint2nor(ixonnor)
        bzint2fnor=bzint2nor(ixonnor)
      endif

      byint1f=0.0d0
      byint2f=0.0d0
      bzint1f=0.0d0
      bzint2f=0.0d0
      byint1fd=0.0d0
      byint2fd=0.0d0
      bzint1fd=0.0d0
      bzint2fd=0.0d0

      if (ixon.gt.1) then
        byint1f=byint(ixon)
        bzint1f=bzint(ixon)
        byint2f=byint2(ixon)
        bzint2f=bzint2(ixon)
      endif

      if (ixon.gt.1) then
        byint1fd=byintd(ixon)
        bzint1fd=bzintd(ixon)
        byint2fd=byint2d(ixon)
        bzint2fd=bzint2d(ixon)
      endif

      bxint1inf=0.0d0
      byint1inf=0.0d0
      bzint1inf=0.0d0
      byint1infd=0.0d0
      bzint1infd=0.0d0

      x=0.0d0
      y=0.0d0
      z=0.0d0

      if (maxiter.gt.0.and.nxmap.gt.0) then

        !all util_break
        call util_zeit_kommentar(lun6,"Writing undumag_integrals_inf.map")

        open(newunit=luninf,file="undumag_integrals_inf.map")
        write(luninf,'(a)')"* y/mm z/mm ByInt1/Tmm BzInt1/Tmm ByInt1_Dip/Tmm BzInt1_Dip/Tmm"

        y=ymapmin-dy
        do iy=1,nymap

          y=y+dy
          z=zmapmin-dz

          do iz=1,nzmap
            z=z+dz

            y=y/1000.0d0
            z=z/1000.0d0

            bxint1inf=0.0d0
            byint1inf=0.0d0
            bzint1inf=0.0d0

            byint1infd=0.0d0
            bzint1infd=0.0d0

            if (idipoles.ne.0) then
              do kmag=1,nmag
                if (bpebc(17,kmag).lt.0.0d0) cycle
                call undumag_dipoles_int(kmag,y,z,byi,bzi,ifail)
                if (ifail.ne.0) then
                  write(lun6,*)"*** Error in undumag_end: Bad return from undumag_dipoles_int ***"
                endif
                byint1infd=byint1infd+byi
                bzint1infd=bzint1infd+bzi
              enddo !nmag
            endif !(idipoles.ne.0) then

            x=0.0d0

            call undumag_bintinf_sym(0.0d0,y,z,1.0d0,0.0d0,0.0d0,
     &        bxint1inf,byint1inf,bzint1inf,ifail)

            if (ifail.ne.0) then
              write(lun6,*)
              write(lun6,*)"*** Warning in undumag_end: Bad return from undumag_bintinf_sym ***"
              write(lun6,*)"*** y,z:",y,z," ***"
            endif

            y=y*1000.0d0
            z=z*1000.0d0

            write(luninf,'(6(1pe17.7e3))')y,z,
     &        byint1inf*1000.0d0,bzint1inf*1000.0d0,
     &        byint1infd*1000.0d0,bzint1infd*1000.0d0

          enddo !iz
        enddo !iy

        flush(luninf)
        close(luninf)

        if (idebug.eq.1) then
          i_debug=6
          !all util_break
        endif

        bxint1inf=0.0d0
        byint1inf=0.0d0
        bzint1inf=0.0d0

        byint1infd=0.0d0
        bzint1infd=0.0d0

        x=0.0d0 !m
        y=0.0d0 !m
        z=0.0d0 !m

        call undumag_bintinf_sym(x,y,z,1.0d0,0.0d0,0.0d0,
     &    bxint1inf,byint1inf,bzint1inf,ifail)
        if (ifail.ne.0) then
          write(lun6,*)
          write(lun6,*)"*** Warning in undumag_end: Bad return from undumag_bintinf_sym ***"
          write(lun6,*)"*** y,z:",y,z," ***"
        endif

        if (idipoles.ne.0) then

          do kmag=1,ndipoles

            y2z2=dipoles(2,kmag)**2+dipoles(3,kmag)**2
            py=dipoles(6,kmag)*dipoles(4,kmag)
            pz=dipoles(7,kmag)*dipoles(4,kmag)
            pryz=py*dipoles(2,kmag)+pz*dipoles(3,kmag)

            if (y2z2.ne.0.0d0) then
              byint1infd=byint1infd
     &          +3.0d0*pryz*dipoles(2,kmag)*2.0d0/3.0d0/y2z2**2*2.0d0
     &          -2.0d0/y2z2*py
              bzint1infd=bzint1infd
     &          +3.0d0*pryz*dipoles(3,kmag)*2.0d0/3.0d0/y2z2**2*2.0d0
     &          -2.0d0/y2z2*pz
            else
              write(lun6,*)"*** Error in undumag_end: Integration of dipole fields fails, since distance to dipole is zero for dipole",
     &          kmag," ***"
            endif
          enddo
        endif !(idipoles.ne.0) then

      endif !(maxiter.gt.1) then

      bxint1inf=bxint1inf*1000.0d0
      byint1inf=byint1inf*1000.0d0
      bzint1inf=bzint1inf*1000.0d0

      write(lun6,*)
      write(lun6,*)"Initial and final damping factors for relaxation of iron:",
     &  sngl(dampi),sngl(damp8)
      write(lun6,*)
      write(lun6,*)"Maximum iteration used for Chi(H) for iron:",nchimax
      write(lun6,*)
      write(lun6,*) "1. Integrals ByI  and BzI  in [Tmm]:  ",
     &  sngl(byint1f),sngl(bzint1f)
      byif=byint1f
      bzif=bzint1f
      write(lun6,*) "1. Integrals ByI  and BzI  in [Tmm], without recovered points:  ",
     &  sngl(byint1fnor),sngl(bzint1fnor)
      write(lun6,*) "1. Integrals ByI and BzI [Tmm], analytically,"
      write(lun6,*) "NOT including external field:  ",
     &  sngl(byint1inf),sngl(bzint1inf)

      if (idipoles.ne.0) then
        write(lun6,*) "1. Integrals ByI  and BzI  in [Tmm] for dipole approx.:  ",
     &    sngl(byint1fd),sngl(bzint1fd)
        write(lun6,*) "1. Integrals ByI and BzI [Tmm], analytically, dipole approx.,"
        write(lun6,*) "NOT including external field:  ",
     &    sngl(byint1infd),sngl(bzint1infd)
      endif !(idipoles.ne.0) then

      write(lun6,*)
      write(lun6,*) "External field [T]:",sngl(bxex),sngl(byex),sngl(bzex)
      write(lun6,*) "1. Integrals ByI and BzI [Tmm] of external field:  ",
     &  sngl(byexint),sngl(bzexint)

      write(lun6,*)
      write(lun6,*) "2. Integrals ByII and BzII in [Tmm**2]: ",
     &  sngl(byint2f),sngl(bzint2f)
      write(lun6,*) "2. Integrals ByII and BzII in [Tmm**2], without recovered points: ",
     &  sngl(byint2fnor),sngl(bzint2fnor)

      if (idipoles.ne.0) then
        write(lun6,*) "2. Integrals ByII and BzII in [Tmm**2] for dipole approx.: ",
     &    sngl(byint2fd),sngl(bzint2fd)
        write(lun6,*)
      endif !(idipoles.ne.0) then

      write(lun6,*)
      dx=xint(nxmap)-xint(1)
      if (nxmap.gt.1) then
        write(lun6,*)"Range of integration and step size:",xint(1),xint(nxmap),dx/(nxmap-1)
      else
        write(lun6,*)"Range of integration and step size:",xint(1),xint(nxmap)," 0.0"
      endif
      write(lun6,*)"By and Bz there:",
     &  sngl(bya(1)),sngl(bza(1)),sngl(bya(nxmap)),sngl(bza(nxmap))
      write(lun6,*)"By*x-range and Bz*x-range there:",
     &  sngl(bya(1)*dx),sngl(bza(1)*dx),sngl(bya(nxmap)*dx),sngl(bza(nxmap)*dx)
      write(lun6,*)

      call util_zeit_kommentar(lun6,"Writing undumag_on-axis_by_bz.eps")
      call mshplt_init(20,15.,15.,25,25,600,600,
     &  'undumag_on-axis_by_bz.eps','','',0.)

      if (ixon.gt.1) then

        if (kdate.eq.0) then
          call mplopt('NDAT',1)
        else
          call mplopt('DATE',1)
        endif
        if (krunnum.ne.0) then
          write(ctitle,*)kundurun
          call util_string_trim(ctitle,nfirst,nlast)
          ctitle=trim(usercom)//", Run: "//ctitle(nfirst:nlast)
        else
          ctitle=trim(usercom)
        endif

        if (kcomment.ne.0) call mtitle(trim(ctitle))
        call mshplt_hplset('YGTI',-0.5)

c{ Plot By, Bz

        gsiz_ps=0.4

        xplmin=sngl(xmapmin)
        xplmax=sngl(xmapmax)
        yplmin=min(byplmin,bzplmin)
        yplmax=max(byplmax,bzplmax)
        dxpl=xplmax-xplmin
        dypl=yplmax-yplmin

        if (dxpl.le.1.0e-9) dxpl=1.
        if (dypl.le.1.0e-9) dypl=1.

        call mplfra(
     &    xplmin-dxpl*0.05,
     &    xplmax+dxpl*0.05,
     &    yplmin-dypl*0.05,
     &    yplmax+dypl*0.05,
     &    '')

        call mgset('PLCI',2.)

        do ix=1,ixon-1
          xpl(1)=sngl(xint(ix))
          xpl(2)=sngl(xint(ix+1))
          ypl(1)=sngl(bya(ix))
          ypl(2)=sngl(bya(ix+1))
          call mpl(2,xpl,ypl)
        enddo

        call mgset('PLCI',4.)

        do ix=1,ixon-1
          xpl(1)=sngl(xint(ix))
          xpl(2)=sngl(xint(ix+1))
          ypl(1)=sngl(bza(ix))
          ypl(2)=sngl(bza(ix+1))
          call mpl(2,xpl,ypl)
        enddo

        call mshplt_set_pad(4.,19.,3.,18.)

        call mshplt_set_text_angle(90.)
        call mshplt_text_ndc(-0.1,0.9,'B [T]')
        call mshplt_set_text_angle(0.)
        call mshplt_text_ndc(0.85,-0.1,'x [mm]')

c        call mgset('CHHE',0.4)
c        call mshplt_set_text_angle(0.)
c        call mshplt_text_ndc(0.9,-0.1,'x [mm]')
cc        call mtx(xplmax-dxpl*0.05,yplmin-dypl*0.175,'x [mm]')
c        call mshplt_set_text_angle(90.)
c        if (abs(yplmax).lt.1.0e-3) then
c          call mshplt_text_ndc(-0.1,0.86,'B [T]')
c        else
c          call mshplt_text_ndc(-0.1,0.88,'B [T]')
c        endif
c        call mtx(xplmin-dxpl*0.15,yplmax-dypl*0.05,'B [T]')
        call mshplt_set_text_angle(0.)
        call mgset('CHHE',0.5)
        call mshplt_set_text_color(0,1,0,0)
        call mshplt_text_ndc(0.85,0.9,'By')
        call mshplt_set_text_color(0,0,0,1)
        call mshplt_text_ndc(0.85,0.83,'Bz')
        call mshplt_set_text_color(1,0,0,0)
        call mgset('CHHE',0.4)

        call muwk(0,0)
        call mshplt_end

      endif !ixon

c} Plot By, Bz

c{ Plot ByInt, BzInt

      call util_zeit_kommentar(lun6,"Writing undumag_on-axis_byint_bzint.eps")
      call mshplt_init(20,15.,15.,25,25,600,600,
     &  'undumag_on-axis_byint_bzint.eps','','',0.)
      if (kcomment.ne.0) call mtitle(trim(ctitle))
      if (kdate.eq.0) then
        call mplopt('NDAT',1)
      else
        call mplopt('DATE',1)
      endif
      call mshplt_hplset('YGTI',-0.5)

      if (ixon.gt.1) then

        call mgset('CHHE',0.3)
        call mshplt_set_text_color(1,0,0,0)
        gsiz_ps=0.4

        xplmin=sngl(xmapmin)
        xplmax=sngl(xmapmax)
        yplmin=min(byiplmin,bziplmin)
        yplmax=max(byiplmax,bziplmax)
        dxpl=xplmax-xplmin
        dypl=yplmax-yplmin
        if (dxpl.le.1.0e-9) dxpl=1.
        if (dypl.le.1.0e-9) dypl=1.

        call mplfra(
     &    xplmin-dxpl*0.05,
     &    xplmax+dxpl*0.05,
     &    yplmin-dypl*0.05,
     &    yplmax+dypl*0.05,
     &    '')

        call mgset('PLCI',2.)

        do ix=1,ixon-1
          xpl(1)=sngl(xint(ix))
          xpl(2)=sngl(xint(ix+1))
          ypl(1)=sngl(byint(ix))
          ypl(2)=sngl(byint(ix+1))
          call mpl(2,xpl,ypl)
        enddo

        call mgset('PLCI',4.)

        do ix=1,ixon-1
          xpl(1)=sngl(xint(ix))
          xpl(2)=sngl(xint(ix+1))
          ypl(1)=sngl(bzint(ix))
          ypl(2)=sngl(bzint(ix+1))
          call mpl(2,xpl,ypl)
        enddo

        call mgset('CHHE',0.4)
        call mshplt_set_text_angle(0.)
        call mshplt_text_ndc(0.9,-0.1,'x [mm]')
        call mshplt_set_text_angle(90.)
        call mshplt_text_ndc(-0.1,0.7,'1. Integral of B [Tmm]')
        call mshplt_set_text_angle(0.)
        call mgset('CHHE',0.5)
        call mshplt_set_text_color(0,1,0,0)
        cbint="1. Int By = "
        call mshplt_text_ndc(0.77,0.9,cbint)
        cbint=""
        write(cbint(1:9),'(f9.3)') byint1f
        if (cbint(1:1).eq.'*') write(cbint(1:9),'(e9.3)') byint1f
        cbint(11:14)="Tmm"
        call mshplt_text_ndc(0.77,0.85,cbint)
        call mshplt_set_text_color(0,0,0,1)
        cbint="1. Int Bz = "
        call mshplt_text_ndc(0.77,0.80,cbint)
        cbint=""
        write(cbint(1:9),'(f9.3)') bzint1f
        if (cbint(1:1).eq.'*') write(cbint(1:9),'(e9.3)') bzint1f
        cbint(11:14)="Tmm"
        call mshplt_text_ndc(0.77,0.75,cbint)
        call mshplt_set_text_color(1,0,0,0)
        call mgset('CHHE',0.4)

      endif !ixon

      call muwk(0,0)
      call mshplt_end

c} Plot ByInt, BzInt

c{ Plot ByInt2, BzInt2

      call util_zeit_kommentar(lun6,"Writing undumag_on-axis_byint2_bzint2.eps")
      call mshplt_init(20,15.,15.,25,25,600,600,
     &  'undumag_on-axis_byint2_bzint2.eps','','',0.)
      if (kdate.eq.0) then
        call mplopt('NDAT',1)
      else
        call mplopt('DATE',1)
      endif
      if (kcomment.ne.0) call mtitle(trim(ctitle))
      call mshplt_hplset('YGTI',-0.5)
      gsiz_ps=0.4

      if (ixon.gt.1) then

        call mgset('CHHE',0.3)
        call mshplt_set_text_color(1,0,0,0)

        xplmin=sngl(xmapmin)
        xplmax=sngl(xmapmax)
        yplmin=min(byiiplmin,bziiplmin)
        yplmax=max(byiiplmax,bziiplmax)
        dxpl=xplmax-xplmin
        dypl=yplmax-yplmin
        if (dxpl.le.1.0e-9) dxpl=1.
        if (dypl.le.1.0e-9) dypl=1.

        call mplfra(
     &    xplmin-dxpl*0.05,
     &    xplmax+dxpl*0.05,
     &    yplmin-dypl*0.05,
     &    yplmax+dypl*0.05,
     &    '')

        call mgset('PLCI',2.)

        do ix=1,ixon-1
          xpl(1)=sngl(xint(ix))
          xpl(2)=sngl(xint(ix+1))
          ypl(1)=sngl(byint2(ix))
          ypl(2)=sngl(byint2(ix+1))
          call mpl(2,xpl,ypl)
        enddo

        call mgset('PLCI',4.)

        do ix=1,ixon-1
          xpl(1)=sngl(xint(ix))
          xpl(2)=sngl(xint(ix+1))
          ypl(1)=sngl(bzint2(ix))
          ypl(2)=sngl(bzint2(ix+1))
          call mpl(2,xpl,ypl)
        enddo

        call mgset('CHHE',0.4)
        call mshplt_set_text_angle(0.)
        call mshplt_text_ndc(0.9,-0.1,'x [mm]')
        call mshplt_set_text_angle(90.)
        call mshplt_text_ndc(-0.1,0.77,'2. Integral of B [Tmm^2]')
        call mshplt_set_text_angle(0.)
        call mgset('CHHE',0.5)
        call mshplt_set_text_color(0,1,0,0)
        cbint="2. Int By = "
        call mshplt_text_ndc(0.73,0.9,cbint)
        cbint=""
        write(cbint(1:9),'(f9.3)') byint2f
        if (cbint(1:1).eq.'*') write(cbint(1:9),'(e9.3)') byint2f
        cbint(9:14)="Tmm^2"
        call mshplt_text_ndc(0.73,0.85,cbint)
        call mshplt_set_text_color(0,0,0,1)
        cbint="2. Int Bz = "
        call mshplt_text_ndc(0.73,0.80,cbint)
        cbint=""
        write(cbint(1:9),'(f9.3)') bzint2f
        if (cbint(1:1).eq.'*') write(cbint(1:9),'(e9.3)') bzint2f
        cbint(9:14)="Tmm^2"
        call mshplt_text_ndc(0.73,0.75,cbint)
        call mshplt_set_text_color(1,0,0,0)
        call mgset('CHHE',0.4)
      endif !ixon

      call muwk(0,0)
      call mshplt_end
c} Plot ByInt2, BzInt2

c Calculate beff{

      deallocate (xintnor)
      deallocate (bxanor)
      deallocate (byanor)
      deallocate (bzanor)
      deallocate (byintnor)
      deallocate (bzintnor)
      deallocate (byint2nor)
      deallocate (bzint2nor)
      deallocate (xint)
      deallocate (bxa)
      deallocate (bya)
      deallocate (bza)
      deallocate (byint)
      deallocate (bzint)
      deallocate (byint2)
      deallocate (bzint2)
      deallocate (ws1)
      deallocate (ws2)
      deallocate (ws3)
      deallocate (ws4)
      deallocate (coef)

      allocate (
     &  xintnor(nxbeff),
     &  byintnor(nxbeff),bzintnor(nxbeff),
     &  byint2nor(nxbeff),bzint2nor(nxbeff),
     &  bxanor(nxbeff),byanor(nxbeff),bzanor(nxbeff),
     &  xint(nxbeff),
     &  byint(nxbeff),bzint(nxbeff),
     &  byint2(nxbeff),bzint2(nxbeff),
     &  bxa(nxbeff),bya(nxbeff),bza(nxbeff),
     &  ws1(nxbeff),ws2(nxbeff),ws3(nxbeff),ws4(nxbeff),coef(nxbeff))

c      if (xbeff.eq.9999.0d0) xbeff=xconv(nxconv/2+1)
      if (xbeff.eq.9999.0d0) xbeff=xcenter
      if (xbeff.eq.-9999.0d0) xbeff=(xmapmin+xmapmax)/2.0d0

      xbeffo=xbeff

      halfperlen=perlen/2.0d0
      quadperlen=perlen/4.0d0

      bymaxbeff=-1.0d30
      bzmaxbeff=-1.0d30

      if (kbeffmode.eq.9999) then
        if (nper.gt.0) then
          kbeffmode=0
        else
          kbeffmode=1
        endif
      endif

      if (kbeffmode.eq.0) then
        xminbeff=xbeff-perlen*0.51
        xmaxbeff=xbeff+perlen*0.51
        dx=(xmaxbeff-xminbeff)/(nxbeff-1)
        xminbeffnor=xminbeff
        xmaxbeffnor=xmaxbeff
        dxkbmode=abs(kbeffmode)*dx
      else
        xminbeff=xbeff-quadperlen
        xmaxbeff=xbeff+quadperlen
        dx=(xmaxbeff-xminbeff)/(nxbeff-1)
        dxkbmode=abs(kbeffmode)*dx
        xminbeffnor=xminbeff
        xmaxbeffnor=xmaxbeff
      endif

      xbymax=xbeff
      xbzmax=xbeff

      do ix=1,nxbeff

        x=xminbeff+(ix-1)*dx
        xx=x

        if (kbeffmode.ne.0.and.abs(abs(x-xbeff)-quadperlen).lt.dxkbmode) then
          cycle
        endif

        call util_random(3,g)
        g=g-0.5
        if (abs(g(1)).lt.randox10) then
          if (g(1).gt.0.0d0) then
            g(1)=g(1)+randox10
          else
            g(1)=g(1)-randox10
          endif
        endif
        if (abs(g(2)).lt.randoy10) then
          if (g(2).gt.0.0d0) then
            g(2)=g(2)+randoy10
          else
            g(2)=g(2)-randoy10
          endif
        endif
        if (abs(g(3)).lt.randoz10) then
          if (g(3).gt.0.0d0) then
            g(3)=g(3)+randoz10
          else
            g(3)=g(3)-randoz10
          endif
        endif

        if (randox.ge.0.0d0) then
          x=x+g(1)*randoxa ! millimeter!
        else
          x=x+randoxa ! millimeter!
        endif

        xint(ix)=x

        if (kbeffmode.ne.0.and.abs(abs(x-xbeff)-quadperlen).lt.dxkbmode) then
          if (x.lt.xbeff) then
            x=xx+abs(xx-x)
          else
            x=xx-abs(xx-x)
          endif
        endif

        if (randoy.ge.0.0d0) then
          y=g(2)*randoya
        else
          y=randoya
        endif
        if (randoz.ge.0.0d0) then
          z=g(3)*randoza
        else
          z=randoza
        endif

        if (kbeffmode.eq.0) then
          call undumag_field(x/1000.0d0,y/1000.0d0,z/1000.0d0,
     &      bx,by,bz,ifail)
        else
          if (abs(abs(x-xbeff)-quadperlen).lt.dxkbmode) then
            cycle
          endif
          if (abs(x-xbeff).le.quadperlen) then
            call undumag_field(x/1000.0d0,y/1000.0d0,z/1000.0d0,
     &        bx,by,bz,ifail)
          else if (x.lt.xbeff) then
            call undumag_field((x+halfperlen)/1000.0d0,y/1000.0d0,z/1000.0d0,
     &        bx,by,bz,ifail)
            bx=-bx
            by=-by
            bz=-bz
          else
            call undumag_field((x-halfperlen)/1000.0d0,y/1000.0d0,z/1000.0d0,
     &        bx,by,bz,ifail)
            bx=-bx
            by=-by
            bz=-bz
          endif
        endif !kbeffmode

        if (ifail.ne.0) cycle

        if (abs(by).gt.bymaxbeff) then
          bymaxbeff=abs(by)
          xbymax=xminbeff+(ix-1)*dx
        endif

        if (abs(bz).gt.bzmaxbeff) then
          bzmaxbeff=abs(bz)
          xbzmax=xminbeff+(ix-1)*dx
        endif

      enddo !ix

      if (bymaxbeff.lt.1.0d-4*bzmaxbeff) xbymax=xbzmax
      if (bzmaxbeff.lt.1.0d-4*bymaxbeff) xbzmax=xbymax

      call undumag_beffy_beffz(
     &  byint1f,bzint1f,
     &  byint2f,bzint2f,
     &  byint1inf,bzint1inf,
     &  byint1fnor,bzint1fnor,
     &  byint2fnor,bzint2fnor,
     &  byexint,bzexint)

      if (idipoles.ne.0) then

        call util_zeit_kommentar(lun6,"Writing undumag_bzeff_dipoles.dat")
        open(newunit=lun,file="undumag_bzeff_dipoles.dat")

        xbeff=xbzmax
        xminbeff=xbeff-perlen/2.0d0
        xmaxbeff=xbeff+perlen/2.0d0

        halfperlen=perlen/2.0d0
        quadperlen=perlen/4.0d0

        if (abs(xbeffo-xminbeff).le.quadperlen) then
          xminbeff=xminbeff-halfperlen
          xmaxbeff=xmaxbeff-halfperlen
        else if (xbeffo-xminbeff.gt.halfperlen*1.001) then
          xminbeff=xminbeff+halfperlen
          xmaxbeff=xmaxbeff+halfperlen
        endif

        if (xbeffz.ne.-9999.0d0) then
          xbeff=xbeffz
          xminbeff=xbeff-perlen/2.0d0
          xmaxbeff=xbeff+perlen/2.0d0
        endif

        xminbeffnor=xminbeff
        xmaxbeffnor=xmaxbeff

        dx=(xmaxbeff-xminbeff)/(nxbeff-1)
        x=xminbeff-dx
        dxkbmode=abs(kbeffmode)*dx

        ixbeff=0
        ixbeffnor=0
        irecover=0

        do ix=1,nxbeff

          x=xminbeff+(ix-1)*dx
          xint(ix)=x
          if (kbeffmode.eq.0) then
            call undumag_dipoles_field(x/1000.0d0,y/1000.0d0,z/1000.0d0,
     &        bxa(ix),bya(ix),bza(ix),ifail)
          else
            if (abs(abs(x-xbeff)-quadperlen).lt.dxkbmode) then
              cycle
            endif
            if (abs(x-xbeff).le.quadperlen) then
              call undumag_dipoles_field(x/1000.0d0,y/1000.0d0,z/1000.0d0,
     &          bxa(ix),bya(ix),bza(ix),ifail)
            else if (x.lt.xbeff) then
              call undumag_dipoles_field((x+halfperlen)/1000.0d0,y/1000.0d0,z/1000.0d0,
     &          bxa(ix),bya(ix),bza(ix),ifail)
              bxa(ix)=-bxa(ix)
              bya(ix)=-bya(ix)
              bza(ix)=-bza(ix)
            else
              call undumag_dipoles_field((x-halfperlen)/1000.0d0,y/1000.0d0,z/1000.0d0,
     &          bxa(ix),bya(ix),bza(ix),ifail)
              bxa(ix)=-bxa(ix)
              bya(ix)=-bya(ix)
              bza(ix)=-bza(ix)
            endif
          endif !kbeffmode

          if (ifail.gt.0) then
            write(lun6,*)"Undumag_dipoles_field returned failure for Bzeff calculation at point ",ix,xint(ix)
          else
            ixbeff=ixbeff+1
            xint(ixbeff)=xint(ix)
            bxa(ixbeff)=bxa(ix)
            bya(ixbeff)=bya(ix)
            bza(ixbeff)=bza(ix)
          endif

        enddo

        if (ixbeff.gt.0) then

          x3=xint(1:3)
          b3=bya(1:3)
          call parabel_short(x3,b3,a3)
          xint(1)=xminbeff
          bya(1)=a3(1)+a3(2)*xint(1)+a3(3)*xint(1)**2
          b3=bza(1:3)
          call parabel_short(x3,b3,a3)
          bza(1)=a3(1)+a3(2)*xint(1)+a3(3)*xint(1)**2

          x3=xint(ixbeff-2:ixbeff)
          b3=bya(ixbeff-2:ixbeff)
          call parabel_short(x3,b3,a3)
          xint(ixbeff)=xmaxbeff
          bya(ixbeff)=a3(1)+a3(2)*xint(ixbeff)+a3(3)*xint(ixbeff)**2
          b3=bza(ixbeff-2:ixbeff)
          call parabel_short(x3,b3,a3)
          bza(ixbeff)=a3(1)+a3(2)*xint(ixbeff)+a3(3)*xint(ixbeff)**2

          do i=1,ixbeff
            write(lun,*)i,xint(i),bya(i),bza(i)
          enddo

          call util_spline_running_integral(xint,bza,ixbeff,bzint,coef,
     &      ws1,ws2,ws3,ws4)

          bmnbeffd=1.0d30
          bmxbeffd=-1.0d30
          bmaxbeffd=-1.0d30
          do i=1,ixbeff
            if (bza(i).gt.bmxbeffd) then
              bmxbeffd=bza(i)
            endif
            if (bza(i).lt.bmnbeffd) then
              bmnbeffd=bza(i)
            endif
            if (abs(bza(i)).gt.bmaxbeffd) then
              bmaxbeffd=abs(bza(i))
              ibmax=i
            endif
            bzint(i)=bzint(i)**2
          enddo

          if (ibmax.eq.1) ibmax=2
          if (ibmax.eq.ixbeff) ibmax=ixbeff-1

          yp(1)=1.0d0
          yp(2)=2.0d0
          yp(3)=3.0d0
          bp(1)=abs(bza(ibmax-1))
          bp(2)=abs(bza(ibmax))
          bp(3)=abs(bza(ibmax+1))

          call util_max_parabel(3,yp,bp,dum,bmaxp,ws1,ws2,ifail)
          if (ifail.eq.0) bmaxbeffd=bmaxp

          call util_spline_running_integral(xint,bzint,ixbeff,bzint2,coef,
     &      ws1,ws2,ws3,ws4)

          beffd= sqrt(bzint2(ixbeff)/(xint(ixbeff)-xint(1)))
c Correct for endpole effects
          if (bmaxbeffd.ne.0.0d0) then
            beffd=beffd*(bmxbeffd-bmnbeffd)/2.0d0/bmaxbeffd
          endif
          bmaxbeffd=(bmxbeffd-bmnbeffd)/2.0d0
          dkeffd = beffd * sqrt(2.0d0)  * 3.0d8 / 0.511d6 / 1000.0d0
          beffd = dkeffd / ((xint(ixbeff)-xint(1))*100.0d0) / 0.934d0 * 1000.0d0

          bmnbeffzd=bmnbeffd
          bmxbeffzd=bmxbeffd
          beffzd=beffd
          dkeffzd=dkeffd

          flush(lun) !undumag_bzeff_dipoles.beff
          close(lun) !undumag_bzeff_dipoles.beff

        else

          write(lun6,*)
          write(lun6,*)"*** Warning in undumag_end: No field data for Bzeff calculation ***"
          write(lun6,*)

        endif

        if (idebug.eq.1) then
          i_debug=7
          !all util_break
        endif

        call util_zeit_kommentar(lun6,"Writing undumag_byeff_dipoles.dat")
        open(newunit=lun,file="undumag_byeff_dipoles.dat")

        xbeff=xbymax
        xminbeff=xbeff-perlen/2.0d0
        xmaxbeff=xbeff+perlen/2.0d0

        halfperlen=perlen/2.0d0
        quadperlen=perlen/4.0d0

        if (abs(xbeffo-xminbeff).le.quadperlen) then
          xminbeff=xminbeff-halfperlen
          xmaxbeff=xmaxbeff-halfperlen
        else if (xbeffo-xminbeff.gt.halfperlen*1.001) then
          xminbeff=xminbeff+halfperlen
          xmaxbeff=xmaxbeff+halfperlen
        endif

        if (xbeffy.ne.-9999.0d0) then
          xbeff=xbeffy
          xminbeff=xbeff-perlen/2.0d0
          xmaxbeff=xbeff+perlen/2.0d0
        endif

        xminbeffnor=xminbeff
        xmaxbeffnor=xmaxbeff

        dx=(xmaxbeff-xminbeff)/(nxbeff-1)
        x=xminbeff-dx
        dxkbmode=abs(kbeffmode)*dx

        ixbeff=0
        ixbeffnor=0
        irecover=0
        do ix=1,nxbeff
          x=xminbeff+(ix-1)*dx
          xint(ix)=x
          if (kbeffmode.eq.0) then
            call undumag_dipoles_field(x/1000.0d0,y/1000.0d0,z/1000.0d0,
     &        bxa(ix),bya(ix),bza(ix),ifail)
          else
            if (abs(abs(x-xbeff)-quadperlen).lt.dxkbmode) then
              cycle
            endif
            if (abs(x-xbeff).le.quadperlen) then
              call undumag_dipoles_field(x/1000.0d0,y/1000.0d0,z/1000.0d0,
     &          bxa(ix),bya(ix),bza(ix),ifail)
            else if (x.lt.xbeff) then
              call undumag_dipoles_field((x+halfperlen)/1000.0d0,y/1000.0d0,z/1000.0d0,
     &          bxa(ix),bya(ix),bza(ix),ifail)
              bxa(ix)=-bxa(ix)
              bya(ix)=-bya(ix)
              bza(ix)=-bza(ix)
            else
              call undumag_dipoles_field((x-halfperlen)/1000.0d0,y/1000.0d0,z/1000.0d0,
     &          bxa(ix),bya(ix),bza(ix),ifail)
              bxa(ix)=-bxa(ix)
              bya(ix)=-bya(ix)
              bza(ix)=-bza(ix)
            endif
          endif !kbeffmode

          if (ifail.gt.0) then
            write(lun6,*)"Undumag_dipoles_field returned failure for Byeff calculation at point ",ix,xint(ix)
          else
            ixbeff=ixbeff+1
            xint(ixbeff)=xint(ix)
            bxa(ixbeff)=bxa(ix)
            bya(ixbeff)=bya(ix)
            bza(ixbeff)=bza(ix)
          endif
        enddo

        if (ixbeff.gt.0) then

          x3=xint(1:3)
          b3=bya(1:3)
          call parabel_short(x3,b3,a3)
          xint(1)=xminbeff
          bya(1)=a3(1)+a3(2)*xint(1)+a3(3)*xint(1)**2
          b3=bza(1:3)
          call parabel_short(x3,b3,a3)
          bza(1)=a3(1)+a3(2)*xint(1)+a3(3)*xint(1)**2

          x3=xint(ixbeff-2:ixbeff)
          b3=bya(ixbeff-2:ixbeff)
          call parabel_short(x3,b3,a3)
          xint(ixbeff)=xmaxbeff
          bya(ixbeff)=a3(1)+a3(2)*xint(ixbeff)+a3(3)*xint(ixbeff)**2
          b3=bza(ixbeff-2:ixbeff)
          call parabel_short(x3,b3,a3)
          bza(ixbeff)=a3(1)+a3(2)*xint(ixbeff)+a3(3)*xint(ixbeff)**2

          do i=1,ixbeff
            write(lun,*)i,xint(i),bya(i),bza(i)
          enddo

          call util_spline_running_integral(xint,bya,ixbeff,byint,coef,
     &      ws1,ws2,ws3,ws4)

          bmnbeffd=1.0d30
          bmxbeffd=-1.0d30
          bmaxbeffd=-1.0d30
          do i=1,ixbeff
            if (bya(i).gt.bmxbeffd) then
              bmxbeffd=bya(i)
            endif
            if (bya(i).lt.bmnbeffd) then
              bmnbeffd=bya(i)
            endif
            if (abs(bya(i)).gt.bmaxbeffd) then
              bmaxbeffd=abs(bya(i))
              ibmax=i
            endif
            byint(i)=byint(i)**2
          enddo

          if (ibmax.eq.1) ibmax=2
          if (ibmax.eq.ixbeff) ibmax=ixbeff-1

          yp(1)=1.0d0
          yp(2)=2.0d0
          yp(3)=3.0d0
          bp(1)=abs(bya(ibmax-1))
          bp(2)=abs(bya(ibmax))
          bp(3)=abs(bya(ibmax+1))

          call util_max_parabel(3,yp,bp,dum,bmaxp,ws1,ws2,ifail)
          if (ifail.eq.0) bmaxbeffd=bmaxp

          call util_spline_running_integral(xint,byint,ixbeff,byint2,coef,
     &      ws1,ws2,ws3,ws4)

          beffd= sqrt(byint2(ixbeff)/(xint(ixbeff)-xint(1)))
c Correct for endpole effects
          if (bmaxbeffd.ne.0.0d0) then
            beffd=beffd*(bmxbeffd-bmnbeffd)/2.0d0/bmaxbeffd
          endif
          bmaxbeffd=(bmxbeffd-bmnbeffd)/2.0d0
          dkeffd = beffd * sqrt(2.0d0)  * 3.0d8 / 0.511d6 / 1000.0d0
          beffd = dkeffd / ((xint(ixbeff)-xint(1))*100.0d0) / 0.934d0 * 1000.0d0

          flush(lun) !undumag_byeff_dipoles.beff
          close(lun) !undumag_byeff_dipoles.beff

        else

          write(lun6,*)
          write(lun6,*)"*** Warning in undumag_end: No field data for Byeff calculation ***"
          write(lun6,*)

        endif !ixbeff

        if (idebug.eq.1) then
          i_debug=8
          !all util_break
        endif

        write(lun6,*)"XminBeff, XmaxBeff (dipole approx.):",
     &    sngl(xminbeff),sngl(xmaxbeff)

        write(lun6,*)"ByMin, ByMax, (ByMax-ByMin)/2, ByEff (dipoles approx.):",
     &    sngl(bmnbeffd),sngl(bmxbeffd),
     &    sngl((bmxbeffd-bmnbeffd)/2.0d0),sngl(beffd)

        write(lun6,*)"BzMin, BzMax, (BzMax-BzMin)/2, BzEff (dipole approx.):",
     &    sngl(bmnbeffzd),sngl(bmxbeffzd),
     &    sngl((bmxbeffzd-bmnbeffzd)/2.0d0),sngl(beffzd)

        write(lun6,*)
        write(lun6,*)"Beff = Sqrt( ByEff**2 + BzEff**2 ) (dipole approx.):",
     &    sngl(sqrt(beffd**2+beffzd**2))

        dkeffd=sngl(sqrt(dkeffd**2+dkeffzd**2))

        write(lun6,*)

        write(lun6,*)"Keff and first harmonic [eV] (dipole approx):",
     &    sngl(dkeffd),sngl(950.0d0*ebeam**2/(1.0d0+dkeffd**2/2.0d0)/(perlen/10.0d0))
        write(lun6,*)

        call util_zeit_kommentar(lun6,"Writing undumag_dipoles.beff")
        open(newunit=lun,file="undumag_dipoles.beff")
        write(lun,*)"* Run:"
        write(lun,*)kundurun
        write(lun,*)"* XminBeff XmaxBeff:"
        write(lun,*)
     &    sngl(xminbeff),sngl(xmaxbeff)
        write(lun,*)"* ByMin, ByMax, (ByMax-ByMin)/2, ByEff:"
        write(lun,*)
     &    sngl(bmnbeffd),sngl(bmxbeffd),
     &    sngl((bmxbeffd-bmnbeffd)/2.0d0),sngl(beffd)
        write(lun,*)"* BzMin, BzMax, (BzMax-BzMin)/2, BzEff:"
        write(lun,*)
     &    sngl(bmnbeffzd),sngl(bmxbeffzd),
     &    sngl((bmxbeffzd-bmnbeffzd)/2.0d0),sngl(beffzd)
        write(lun,*)"* Beff = Sqrt( ByEff**2 + BzEff**2 ):"
        write(lun,*)
     &    sngl(sqrt(beffd**2+beffzd**2))
        write(lun,*)"* ByInt1, BzInt1, ByInt2, BzInt2:"
        write(lun,*)
     &    sngl(byint1fd),sngl(bzint1fd),
     &    sngl(byint2fd),sngl(bzint2fd)
        write(lun,*)"* ByInt1Inf, BzInt1Inf:"
        write(lun,*)
     &    sngl(byint1infd),sngl(bzint1infd)
        flush(lun)
        close(lun)
!} beff
      endif !(idipoles.ne.0) then

      deallocate (xint)
      deallocate (bxa)
      deallocate (bya)
      deallocate (bza)
      deallocate (byint)
      deallocate (bzint)
      deallocate (byint2)
      deallocate (bzint2)
      deallocate (ws1)
      deallocate (ws2)
      deallocate (ws3)
      deallocate (ws4)
      deallocate (coef)

      if (kurad.ne.0) then

        ndim=nstepp
        gammai=ebeam/emassg1

        if (xelec.eq.9999.0d0) xelec=xmapmin
        if (xf.eq.9999.0d0) xf=xmapmax

        xelec=xelec/1000.0d0
        yelec=yelec/1000.0d0
        zelec=zelec/1000.0d0

        ds=ds/1000.0d0

        xobsv=xobsv/1000.0d0
        yobsv=yobsv/1000.0d0
        zobsv=zobsv/1000.0d0

        xf=xf/1000.0d0
        yf=yf/1000.0d0
        zf=zf/1000.0d0

        call urad(jcharge,
     &    gammai,dgamtot
     &    ,xelec,yelec,zelec,vxelec,vyelec,vzelec
     &    ,xf,yf,zf,efx,efy,efz,
     &    xexit,yexit,zexit,vnxex,vnyex,vnzex,texit,ds
     &    ,nthstep,nstep,ndim,traxyz
     &    ,xobsv,yobsv,zobsv,phelow,phehig,
     &    nphener,phener,aradx,arady,aradz,stokes,powden
     &    ,ieneloss,ivelofield,istatus
     &    )

        write(lun6,*)
        write(lun6,'(a,3g15.5)')"xelec, yelec, zelec for urad [mm]:",
     &    xelec*1000.,yelec*1000.,zelec*1000.
        write(lun6,'(a,3g15.5)')"vxelec, vyelec, vzelec for urad:",
     &    vxelec,vyelec,vzelec
        write(lun6,'(a,2g15.5)')"ebeam [GeV], gamma for urad:",ebeam, gamma
        write(lun6,'(a,3g15.5)')"xexit, yexit, zexit [mm]:",
     &    xexit*1000.0,yexit*1000.0,zexit*1000.0
        write(lun6,'(a,2g15.5)')"hori. and vert. kick at xexit [mrad]:",
     &    vnzex/vnxex*1000., vnyex/vnxex*1000.

        xplmin=1.0e30
        xplmax=-1.0e30
        yplmin=1.0e30
        yplmax=-1.0e30
        zplmin=1.0e30
        zplmax=-1.0e30

        call util_zeit_kommentar(lun6,"Writing urad_traxyz.dat")
        open(newunit=lun,file='urad_traxyz.dat',recl=256)

        do istep=1,nstep
          if (traxyz(1,istep).lt.xplmin) xplmin=sngl(traxyz(1,istep))
          if (traxyz(1,istep).gt.xplmax) xplmax=sngl(traxyz(1,istep))
          if (traxyz(2,istep).lt.yplmin) yplmin=sngl(traxyz(2,istep))
          if (traxyz(2,istep).gt.yplmax) yplmax=sngl(traxyz(2,istep))
          if (traxyz(3,istep).lt.zplmin) zplmin=sngl(traxyz(3,istep))
          if (traxyz(3,istep).gt.zplmax) zplmax=sngl(traxyz(3,istep))
          write(lun,'(14e17.7e3)')traxyz(1:3,istep)*1000.0,traxyz(4:14,istep)
        enddo

        flush(lun)
        close(lun)

c{ Plot x,y,z

        call util_zeit_kommentar(lun6,"Writing undumag_trajectory.eps")
        call mshplt_init(20,15.,15.,25,25,600,600,
     &    'undumag_trajectory.eps','','',0.)

        gsiz_ps=0.4

        if (kdate.eq.0) then
          call mplopt('NDAT',1)
        else
          call mplopt('DATE',1)
        endif

        theta_ps=sngl(traxyz_theta)
        phi_ps=sngl(traxyz_phi)

        xplmin=xplmin*1000.
        xplmax=xplmax*1000.
        yplmin=yplmin*1.0e6
        zplmin=zplmin*1.0e6
        yplmax=yplmax*1.0e6
        zplmax=zplmax*1.0e6

        dxpl=xplmax-xplmin
        dypl=yplmax-yplmin
        dzpl=zplmax-zplmin

        if (dypl.lt.1.0e-9) dypl=1.0
        if (dzpl.lt.1.0e-9) dzpl=1.0

        xplmin=xplmin-dxpl*0.05
        xplmax=xplmax+dxpl*0.05
        yplmin=yplmin-dypl*0.05
        yplmax=yplmax+dypl*0.05
        zplmin=zplmin-dzpl*0.05
        zplmax=zplmax+dzpl*0.05

        if (yplmin.le.zplmin) then
          zplmin=yplmin
        else
          yplmin=zplmin
        endif

        if (yplmax.ge.zplmax) then
          zplmax=yplmax
        else
          yplmax=zplmax
        endif

        call mshplt_frame3d_xzy(
     &    xplmin,xplmax,
     &    yplmin,yplmax,
     &    zplmin,zplmax,
     &    'x [mm]','y [mu-m]','z [mu-m]','')

        call mshplt_set_text_color(1,0,0,0)
        gsiz_ps=0.4
        call mgset('CHHE',0.4)
        call mshplt_text_ndc(0.1,1.05,ctitle)

        call mgset('PLCI',2.)

        do istep=1,nstep-1
          xpl(1)=sngl(traxyz(1,istep))*1000.
          xpl(2)=sngl(traxyz(1,istep+1))*1000.
          ypl(1)=sngl(traxyz(2,istep))*1.0e6
          ypl(2)=sngl(traxyz(2,istep+1))*1.0e6
          zpl(1)=zplmax+zplmin-sngl(traxyz(3,istep))*1.0e6
          zpl(2)=zplmax+zplmin-sngl(traxyz(3,istep+1))*1.0e6
          call mpl3(2,xpl,zpl,ypl)
        enddo

        call mshplt_end

c} Plot x,y,z

c{ Plot y,z

      call util_zeit_kommentar(lun6,"Writing undumag_y_z.eps")

      call mshplt_init(20,15.,15.,25,25,600,600,
     &  'undumag_y_z.eps','','',0.)

      if (ixon.gt.1) then

        if (kdate.eq.0) then
          call mplopt('NDAT',1)
        else
          call mplopt('DATE',1)
        endif
        if (krunnum.ne.0) then
          write(ctitle,*)kundurun
          call util_string_trim(ctitle,nfirst,nlast)
          ctitle=trim(usercom)//", Run: "//ctitle(nfirst:nlast)
        else
          ctitle=trim(usercom)
        endif

        if (kcomment.ne.0) call mtitle(trim(ctitle))
        call mshplt_hplset('YGTI',-0.5)

        call mplfra(
     &    xplmin-dxpl*0.05,
     &    xplmax+dxpl*0.05,
     &    yplmin-dypl*0.05,
     &    yplmax+dypl*0.05,
     &    '')

        call mgset('PLCI',2.)

        do istep=1,nstep-1
          xpl(1)=sngl(traxyz(1,istep))*1000.
          xpl(2)=sngl(traxyz(1,istep+1))*1000.
          zpl(1)=sngl(traxyz(2,istep))*1.0e6
          zpl(2)=sngl(traxyz(2,istep+1))*1.0e6
          call mpl(2,xpl,zpl)
        enddo

        call mgset('PLCI',4.)

        do istep=1,nstep-1
          xpl(1)=sngl(traxyz(1,istep))*1000.
          xpl(2)=sngl(traxyz(1,istep+1))*1000.
          ypl(1)=sngl(traxyz(3,istep))*1.0e6
          ypl(2)=sngl(traxyz(3,istep+1))*1.0e6
          call mpl(2,xpl,ypl)
        enddo

        call mgset('CHHE',0.4)
        call mshplt_set_text_angle(0.)
        call mshplt_text_ndc(0.9,-0.1,'x [mm]')
        call mshplt_set_text_angle(90.)

        call mshplt_text_ndc(-0.1,0.65,'trajectory [mu-m]')

        call mshplt_set_text_angle(0.)
        call mgset('CHHE',0.5)
        call mshplt_set_text_color(0,1,0,0)
        call mshplt_text_ndc(0.85,0.9,'y')
        call mshplt_set_text_color(0,0,0,1)
        call mshplt_text_ndc(0.85,0.83,'z')
        call mshplt_set_text_color(1,0,0,0)
        call mgset('CHHE',0.4)

        call muwk(0,0)
        call mshplt_end

      endif !ixon

c} Plot y,z

        s0min=1.0e30
        s1min=1.0e30
        s2min=1.0e30
        s3min=1.0e30
        s0max=-1.0e30
        s1max=-1.0e30
        s2max=-1.0e30
        s3max=-1.0e30
        call util_zeit_kommentar(lun6,"Writing urad_stokes.dat")
        open(newunit=lun,file='urad_stokes.dat',recl=256)
        do ifreq=1,nphener
          s0=sngl(stokes(1,ifreq))
          s1=sngl(stokes(2,ifreq))
          s2=sngl(stokes(3,ifreq))
          s3=sngl(stokes(4,ifreq))
          write(lun,*)sngl(phener(ifreq)),s0,s1,s2,s3
          if (s0.lt.s0min) s0min=s0
          if (s1.lt.s1min) s1min=s1
          if (s2.lt.s2min) s2min=s2
          if (s3.lt.s3min) s3min=s3
          if (s0.gt.s0max) s0max=s0
          if (s1.gt.s1max) s1max=s1
          if (s2.gt.s2max) s2max=s2
          if (s3.gt.s3max) s3max=s3
        enddo
        flush(lun)
        close(lun)

      endif !kurad

      call util_zeit_kommentar(lun6,"Writing undumag_spectrum.eps")
      call mshplt_init(20,15.,15.,25,25,600,600,
     &  'undumag_spectrum.eps','','',0.)

      if (kdate.eq.0) then
        call mplopt('NDAT',1)
      else
        call mplopt('DATE',1)
      endif
      if (krunnum.ne.0) then
        write(ctitle,*)kundurun
        call util_string_trim(ctitle,nfirst,nlast)
        ctitle=trim(usercom)//", Run: "//ctitle(nfirst:nlast)
      else
        ctitle=trim(usercom)
      endif

      if (nphener.ne.0) then

      if (kcomment.ne.0) call mtitle(trim(ctitle))
      call mshplt_hplset('YGTI',-0.5)

      gsiz_ps=0.4

      xplmin=sngl(phelow)
      xplmax=sngl(phehig)

! S0
      yplmin=s0min
      yplmax=s0max

      dxpl=xplmax-xplmin
      dypl=yplmax-yplmin

      if (dxpl.le.1.0e-9) dxpl=1.
      if (dypl.le.1.0e-9) dypl=1.

      call mshplt_set_pad(4.,10.,12.,18.)

      call mshplt_set_text_angle(90.)
      call mshplt_text_ndc(-0.15,0.0,'S0 [1/s/mm^2/0.1%BW,100mA]')
      call mshplt_set_text_angle(0.)
      call mshplt_text_ndc(0.85,-0.25,'Eph [eV]')

      call mshplt_get_axis_label_offset(xlaboff,ylaboff)
      call mshplt_set_axis_label_offset(xlaboff,ylaboff*0.75)
      call mshplt_frame(
     &  xplmin,
     &  xplmax,
     &  yplmin,
     &  yplmax+dypl*0.05,
     &  ' ',' ',' ')

      call mshplt_set_text_angle(0.)

      call mgset('PLCI',2.)

      do ifreq=1,nphener-1
        xpl(1)=sngl(phener(ifreq))
        xpl(2)=sngl(phener(ifreq+1))
        ypl(1)=sngl(stokes(1,ifreq))
        ypl(2)=sngl(stokes(1,ifreq+1))
        call mpl(2,xpl,ypl)
      enddo

! S1
      dxpl=xplmax-xplmin
      dypl=yplmax-yplmin

      if (dxpl.le.1.0e-9) dxpl=1.
      if (dypl.le.1.0e-9) dypl=1.

      call mshplt_set_pad(13.,19.,12.,18.)
      call mshplt_set_text_angle(90.)
      call mshplt_text_ndc(-0.15,0.0,'S1 [1/s/mm^2/0.1%BW,100mA]')
      call mshplt_set_text_angle(0.)
      call mshplt_text_ndc(0.85,-0.25,'Eph [eV]')

      call mshplt_frame(
     &  xplmin,
     &  xplmax,
     &  -yplmax-dypl*0.05,
     &  yplmax+dypl*0.05,
     &  ' ',' ',' ')

      call mgset('PLCI',2.)

      do ifreq=1,nphener-1
        xpl(1)=sngl(phener(ifreq))
        xpl(2)=sngl(phener(ifreq+1))
        ypl(1)=sngl(stokes(2,ifreq))
        ypl(2)=sngl(stokes(2,ifreq+1))
        call mpl(2,xpl,ypl)
      enddo

      call mgset('PLCI',4.)

! S2
      dxpl=xplmax-xplmin
      dypl=yplmax-yplmin

      if (dxpl.le.1.0e-9) dxpl=1.
      if (dypl.le.1.0e-9) dypl=1.

      call mshplt_set_pad(4.,10.,4.,10.)
      call mshplt_set_text_angle(90.)
      call mshplt_text_ndc(-0.15,0.0,'S2 [1/s/mm^2/0.1%BW,100mA]')
      call mshplt_set_text_angle(0.)
      call mshplt_text_ndc(0.85,-0.25,'Eph [eV]')

      call mshplt_frame(
     &  xplmin,
     &  xplmax,
     &  -yplmax-dypl*0.05,
     &  yplmax+dypl*0.05,
     &  ' ',' ',' ')

      call mgset('PLCI',2.)

      do ifreq=1,nphener-1
        xpl(1)=sngl(phener(ifreq))
        xpl(2)=sngl(phener(ifreq+1))
        ypl(1)=sngl(stokes(3,ifreq))
        ypl(2)=sngl(stokes(3,ifreq+1))
        call mpl(2,xpl,ypl)
      enddo

! S3
      dxpl=xplmax-xplmin
      dypl=yplmax-yplmin

      if (dxpl.le.1.0e-9) dxpl=1.
      if (dypl.le.1.0e-9) dypl=1.

      call mshplt_set_pad(13.,19.,4.,10.)
      call mshplt_set_text_angle(90.)
      call mshplt_text_ndc(-0.15,0.0,'S3 [1/s/mm^2/0.1%BW,100mA]')
      call mshplt_set_text_angle(0.)
      call mshplt_text_ndc(0.85,-0.25,'Eph [eV]')

      call mshplt_frame(
     &  xplmin,
     &  xplmax,
     &  -yplmax-dypl*0.05,
     &  yplmax+dypl*0.05,
     &  ' ',' ',' ')

      do ifreq=1,nphener-1
        xpl(1)=sngl(phener(ifreq))
        xpl(2)=sngl(phener(ifreq+1))
        ypl(1)=sngl(stokes(4,ifreq))
        ypl(2)=sngl(stokes(4,ifreq+1))
        call mpl(2,xpl,ypl)
      enddo

      call muwk(0,0)
      call mshplt_end


      endif !(nphener.ne.0) then

      if (kdumpconv.ne.0) then
        flush(lunconv)
        close(lunconv)
      endif

      if (killbadmag.lt.0.and.killbadmag.ne.-9999) then
        i=0
        call util_zeit_kommentar(lun6,"Writing undumag.bad")
        open(newunit=lunkill,file="undumag.bad")
        do kmag=1,nmag
          if (bpebc(16,kmag).ne.0.0d0) then
            write(lunkill,*)kmag,nint(bpebc(16,kmag)),bpebc(1:6,kmag)
            i=i+1
          endif
        enddo
        flush(lunkill)
        close(lunkill)
        write(lun6,*)
        write(lun6,*)"File undumag.bad written, number of bad voxel:",i
      endif

      if (idipoles.ne.0) then
        call util_zeit_kommentar(lun6,"Writing undumag_map.dip")
        open(newunit=lun,file="undumag_map.dip")
        do kmag=1,ndipoles
          write(lun,'(14e17.7e3)')dipoles(1:3,kmag),
     &      dipoles(4,kmag)*dipoles(5:7,kmag),dipoles(9:16,kmag)
        enddo
        flush(lun)
        close(lun)
      endif

      if (intmaglis.ne.0) then
        write(lun6,*)
        write(lun6,*)" --- Due to flag intmaglis, only magnets on file undumag_magmap.lis do contribute to field map ---"
        write(lun6,*)
      endif

c      call muwk(0,0)
c      call mshplt_end

      byplmin=1.0e30
      bzplmin=1.0e30
      byplmax=-1.0e30
      bzplmax=-1.0e30
      call util_zeit_kommentar(lun6,"Writing undumag_field_profile.dat")
      open(newunit=lunz,file='undumag_field_profile.dat')
      nz=(nint(zmaxprof-zminprof))+1
      zmin=dble(nint(zminprof))-1.0d0
      i=0
      do iz=1,nz
22      z=zmin+dble(iz)
        x=(xminbeff+xmaxbeff)/2.0d0
        y=0.0d0
        ! to avoid boundary effects:
        call util_random(3,g)
        g=g-0.5
c+self,if=rando10.
        if (abs(g(1)).lt.randox10) then
          if (g(1).gt.0.0d0) then
            g(1)=g(1)+randox10
          else
            g(1)=g(1)-randox10
          endif
        endif
        if (abs(g(2)).lt.randoy10) then
          if (g(2).gt.0.0d0) then
            g(2)=g(2)+randoy10
          else
            g(2)=g(2)-randoy10
          endif
        endif
        if (abs(g(3)).lt.randoz10) then
          if (g(3).gt.0.0d0) then
            g(3)=g(3)+randoz10
          else
            g(3)=g(3)-randoz10
          endif
        endif
c+self.,if=rando10.

        if (itry.eq.0.and.randoz.gt.0.0d0) g=0.

        if (randox.ge.0.0d0) then
          x=x+g(1)*randoxa ! millimeter!
        else
          x=x+randoxa ! millimeter!
        endif

        if (randoy.ge.0.0d0) then
          y=g(2)*randoya
        else
          y=randoya
        endif

        if (randoz.ge.0.0d0) then
          z=z+g(3)*randoza
        else
          z=z+randoza
        endif

        ifail=0

        if (itry.eq.0) ifail=-1

        call undumag_field(x/1000.0d0,y/1000.0d0,z/1000.0d0,bx,by,bz,ifail)

        if (itry.eq.0.and.ifail.eq.-1) then
          ifail=0
        endif

        if (ifail.ne.0.and.itry.lt.10) then
          itry=itry+1
          goto 22
        endif
        itry=0

        if (ifail.le.0) then
          i=i+1
          write(lunz,*)x,y,z,bx,by,bz
          zppl(i)=sngl(z)
          bypl(i)=sngl(by)
          bzpl(i)=sngl(bz)
          if (by.lt.byplmin) byplmin=sngl(by)
          if (by.gt.byplmax) byplmax=sngl(by)
          if (bz.lt.bzplmin) bzplmin=sngl(bz)
          if (bz.gt.bzplmax) bzplmax=sngl(bz)
        endif

      enddo
      flush(lunz)
      close(lunz)

      nz=i

      call util_zeit_kommentar(lun6,"Writing undumag_field_profile.eps")
      call mshplt_init(20,15.,15.,25,25,600,600,
     &  'undumag_field_profile.eps','','',0.)

      if (kdate.eq.0) then
        call mplopt('NDAT',1)
      else
        call mplopt('DATE',1)
      endif
      if (krunnum.ne.0) then
        write(ctitle,*)kundurun
        call util_string_trim(ctitle,nfirst,nlast)
        ctitle=trim(usercom)//", Run: "//ctitle(nfirst:nlast)
      else
        ctitle=trim(usercom)
      endif

      if (kcomment.ne.0) call mtitle(trim(ctitle))
      call mshplt_hplset('YGTI',-0.5)

c{ Plot By, Bz

      gsiz_ps=0.4

      xplmin=sngl(zminprof)
      xplmax=sngl(zmaxprof)
      yplmin=min(byplmin,bzplmin)
      yplmax=max(byplmax,bzplmax)
      dxpl=xplmax-xplmin
      dypl=yplmax-yplmin

      if (dxpl.le.1.0e-9) dxpl=1.
      if (dypl.le.1.0e-9) dypl=1.

      call mplfra(
     &  xplmin-dxpl*0.05,
     &  xplmax+dxpl*0.05,
     &  yplmin-dypl*0.05,
     &  yplmax+dypl*0.05,
     &  '')

      call mgset('PLCI',2.)
      call mshplt_set_marker_size(0.5)

      do i=1,nz-1
        xpl(1)=sngl(zppl(i))
        xpl(2)=sngl(zppl(i+1))
        ypl(1)=sngl(bypl(i))
        ypl(2)=sngl(bypl(i+1))
        call mpl(2,xpl,ypl)
      enddo

      call mgset('PLCI',4.)

      do i=1,nz-1
        xpl(1)=sngl(zppl(i))
        xpl(2)=sngl(zppl(i+1))
        ypl(1)=sngl(bzpl(i))
        ypl(2)=sngl(bzpl(i+1))
        call mpl(2,xpl,ypl)
      enddo

      call mgset('CHHE',0.4)
      call mshplt_set_text_angle(0.)
      call mshplt_text_ndc(0.9,-0.1,'z [mm]')
      call mshplt_set_text_angle(90.)
      if (abs(yplmax).lt.1.0e-3) then
        call mshplt_text_ndc(-0.1,0.86,'B [T]')
      else
        call mshplt_text_ndc(-0.1,0.88,'B [T]')
      endif
      call mshplt_set_text_angle(0.)
      call mgset('CHHE',0.5)
      call mshplt_set_text_color(0,1,0,0)
      call mshplt_text_ndc(0.85,0.9,'By')
      call mshplt_set_text_color(0,0,0,1)
      call mshplt_text_ndc(0.85,0.83,'Bz')
      call mshplt_set_text_color(1,0,0,0)
      call mgset('CHHE',0.4)

      call muwk(0,0)
      call mshplt_end

      call util_zeit_kommentar(lun6,"Writing undumag.wav")
      open(newunit=lunw,file='undumag.wav')

      write(lunw,'(a)')cundutit
      write(lunw,*)ncwires,nrec,nmag,nplanmax,ncornmax,' 20',' 3',' 8',
     &  " ! ncwires, nrec, nmag, nplanmax, ncornmax, 1_dim_bpebc, 1_dim_bperot, 2_dim_bpetm"
      write(lunw,*)ixsym,iysym,izsym,kxcenter,xsym,xcenter
      write(lunw,*)perlen,xmapmin,xmapmax,nper
      write(lunw,*)kurad,ebeam
      write(lunw,*)xelec,yelec,zelec
      write(lunw,*)vxelec,vyelec,vzelec
      write(lunw,*)xf,yf,zf
      write(lunw,*)efx,efy,efz
      write(lunw,*)tiny,window

      do kmag=1,nmag
        write(lunw,*)kmag
        write(lunw,*)bpebc(:,kmag)
        nplan=ibpeplan(kmag)
        write(lunw,*)nplan,ibpecol(kmag)
        do iplan=1,nplan
          ncorn=ibpecorn(iplan,kmag)
          write(lunw,*)ncorn
          do icorn=1,ncorn
            write(lunw,*)bpemag(1:3,icorn,iplan,kmag)
            write(lunw,*)bperot(1:3,icorn,iplan,kmag)
          enddo
          do i=1,8
            write(lunw,*)bpetm(1:3,i,iplan,kmag)
          enddo
        enddo
      enddo

      do i=1,ncwires
        write(lunw,*)wire(:,i)
      enddo

      flush(lunw)
      close(lunw)

      call undumag_uout

      call util_zeit_kommentar(lun6,"Writing undumag.mat")

      open(newunit=lunmat,file="undumag.mat")

      write(lunmat,'(a)') '* ' // ctitle

      do mat=1,nmatfiles
        n=matmaps(4,mat)
        mtyp=matmaps(2,mat)
        if (mtyp.eq.1.and.nrec.gt.0) then
          if (n.eq.0) then
            if (newclc.ne.0) then
              br=0.0d0
              do ibrn=1,nbrnmat
                if (abs(brnmat(2,ibrn)).gt.br) br=abs(brnmat(2,ibrn))
              enddo
              kbrn=0
              do ibrn=1,nbrnmat
                if (nint(brnmat(1,ibrn)).eq.mat) then
                  kbrn=ibrn
                  exit
                endif
              enddo
              if (kbrn.eq.0) then
                write(lun6,*)
                write(lun6,*)"*** Warning in undumag_end: Could not find REC material in list of Br ***"
                write(lun6,*)"*** Be careful with plots of magnetisation ***"
              endif
              brn=sngl(abs(brnmat(2,ibrn)))
              hbmatmin=sngl(brn-bcmat(2,1,mat)*br)
              hbmatmax=sngl(brn+bcmat(2,1,mat)*br)
            endif !newclc
            write(lunmat,*) mat,mtyp,matmaps(3,mat),sngl(-br),hbmatmin,sngl(bcmat(3,1,mat))
            write(lunmat,*) mat,mtyp,matmaps(3,mat),sngl(br),hbmatmax,sngl(bcmat(3,1,mat))
          else
            do i=1,n
              write(lunmat,*) mat,mtyp,matmaps(3,mat),sngl(bcmat(1:3,i,mat))
            enddo
          endif
        else if (mtyp.eq.2) then
          do i=1,n
            write(lunmat,*) mat,mtyp,matmaps(3,mat),sngl(bcmat(1:3,i,mat))
          enddo
        endif !mtyp
      enddo

      flush(lunmat)
      close(lunmat)

      open(newunit=lunmat,file="undumag.brn")

      write(lunmat,'(a)') '* ' // ctitle

      do mat=1,nbrnmat
        write(lunmat,*) brnmat(1:2,mat)
      enddo

      flush(lunmat)
      close(lunmat)

      call clcmag_voxels_list(1)

      open(newunit=lunst,file="undumag.stat")
      write(lunst,*)"0"
      flush(lunst)
      close(lunst)

      flush(lunmag)
      close(lunmag)

9999  continue

      call  util_random_get_seed(irnsize,irnseed)

      call util_get_free_lun(lun)
      call util_zeit_kommentar(lun6,"Writing undumag.seeds")

      open(newunit=lun,file='undumag.seeds',status='unknown')

      write(lun,*)irnsize, kundurun
      do i=1,irnsize
        write(lun,*)i,irnseed(i)
      enddo

      flush(lun)
      close(lun)

      open(newunit=lun,file='undumag.gmd',status='unknown')
      write(lun,*)kundurun,modegui
      flush(lun)
      close(lun)

      return
      end
