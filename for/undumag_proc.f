*CMZ :          29/02/2024  16.00.13  by  Michael Scheer
*CMZ :  2.04/09 22/08/2023  09.03.52  by  Michael Scheer
*CMZ :  2.04/08 10/08/2023  09.28.20  by  Michael Scheer
*CMZ :  2.04/06 22/05/2023  15.36.58  by  Michael Scheer
*CMZ :  2.04/03 28/02/2023  10.11.37  by  Michael Scheer
*CMZ :  2.03/00 24/07/2022  14.55.26  by  Michael Scheer
*CMZ :  2.02/02 01/07/2022  18.10.55  by  Michael Scheer
*CMZ :  2.02/01 11/02/2022  09.44.24  by  Michael Scheer
*CMZ :  2.02/00 29/03/2021  08.13.23  by  Michael Scheer
*CMZ :  2.01/04 19/07/2019  11.32.16  by  Michael Scheer
*CMZ :  2.01/03 19/02/2019  15.12.23  by  Michael Scheer
*CMZ :  2.01/02 27/04/2018  13.35.13  by  Michael Scheer
*CMZ :  2.00/03 24/04/2018  12.57.46  by  Michael Scheer
*CMZ :  2.00/00 11/04/2018  09.06.41  by  Michael Scheer
*CMZ :  1.25/03 22/03/2018  17.04.20  by  Michael Scheer
*CMZ :  1.25/02 21/03/2018  12.51.53  by  Michael Scheer
*CMZ :  1.25/00 16/03/2018  13.46.00  by  Michael Scheer
*CMZ :  1.23/04 03/10/2017  10.43.48  by  Michael Scheer
*CMZ :  1.23/03 25/09/2017  16.00.03  by  Michael Scheer
*CMZ :  1.22/01 21/07/2017  12.01.46  by  Michael Scheer
*CMZ :  1.20/03 26/06/2017  09.29.58  by  Michael Scheer
*CMZ :  1.20/02 22/06/2017  15.34.18  by  Michael Scheer
*CMZ :  1.20/01 22/06/2017  13.59.54  by  Michael Scheer
*CMZ :  1.20/00 20/06/2017  17.45.31  by  Michael Scheer
*CMZ :  1.18/03 13/06/2017  16.03.07  by  Michael Scheer
*CMZ :  1.17/08 27/05/2017  11.11.36  by  Michael Scheer
*CMZ :  1.17/07 22/05/2017  09.11.18  by  Michael Scheer
*CMZ :  1.17/06 21/05/2017  12.30.34  by  Michael Scheer
*CMZ :  1.17/05 18/05/2017  10.15.55  by  Michael Scheer
*CMZ :  1.17/04 10/05/2017  11.28.21  by  Michael Scheer
*CMZ :  1.17/00 07/05/2017  21.16.08  by  Michael Scheer
*CMZ :  1.16/00 07/05/2017  14.06.14  by  Michael Scheer
*CMZ :  1.15/11 24/04/2017  17.05.33  by  Michael Scheer
*CMZ :  1.15/10 10/04/2017  16.42.28  by  Michael Scheer
*CMZ :  1.15/08 06/04/2017  12.38.19  by  Michael Scheer
*CMZ :  1.15/07 05/04/2017  09.12.16  by  Michael Scheer
*CMZ :  1.15/02 31/03/2017  13.42.48  by  Michael Scheer
*CMZ :  1.15/00 27/03/2017  12.51.14  by  Michael Scheer
*CMZ :  1.14/00 22/03/2017  12.49.30  by  Michael Scheer
*CMZ :  1.11/01 06/01/2017  13.35.57  by  Michael Scheer
*CMZ :  1.11/00 07/12/2016  12.48.13  by  Michael Scheer
*CMZ :  1.10/02 24/11/2016  12.14.11  by  Michael Scheer
*CMZ :  1.06/00 19/09/2016  14.23.58  by  Michael Scheer
*CMZ :  1.04/02 15/09/2016  16.07.58  by  Michael Scheer
*CMZ :  1.02/01 04/09/2016  16.24.12  by  Michael Scheer
*CMZ :  1.02/00 29/08/2016  13.44.31  by  Michael Scheer
*CMZ :  1.00/00 19/08/2016  15.00.54  by  Michael Scheer
*CMZ :  0.00/14 19/08/2016  14.32.22  by  Michael Scheer
*CMZ :  0.00/13 19/08/2016  13.59.01  by  Michael Scheer
*CMZ :  0.00/12 21/07/2016  09.07.26  by  Michael Scheer
*CMZ :  0.00/11 20/07/2016  11.54.42  by  Michael Scheer
*CMZ :  0.00/09 05/07/2016  16.15.09  by  Michael Scheer
*CMZ :  0.00/07 22/06/2016  16.13.38  by  Michael Scheer
*CMZ :  0.00/05 13/06/2016  15.10.33  by  Michael Scheer
*CMZ :  0.00/04 13/05/2016  14.49.34  by  Michael Scheer
*CMZ :  0.00/03 04/05/2016  11.42.42  by  Michael Scheer
*CMZ :  0.00/02 02/05/2016  10.17.29  by  Michael Scheer
*CMZ :  1.17/14 13/04/2016  09.45.18  by  Michael Scheer
*CMZ :  1.17/13 06/04/2016  16.00.49  by  Michael Scheer
*CMZ :  1.17/12 06/04/2016  14.48.31  by  Michael Scheer
*CMZ :  1.17/11 06/04/2016  09.12.36  by  Michael Scheer
*CMZ :  1.17/10 04/04/2016  14.20.09  by  Michael Scheer
*CMZ :  1.17/09 04/04/2016  09.24.11  by  Michael Scheer
*CMZ :  1.17/08 04/04/2016  09.03.19  by  Michael Scheer
*CMZ :  1.17/07 04/04/2016  08.44.39  by  Michael Scheer
*CMZ :  1.17/06 01/04/2016  12.58.26  by  Michael Scheer
*CMZ :  1.17/05 27/03/2016  11.59.54  by  Michael Scheer
*CMZ :  1.17/04 24/03/2016  19.09.17  by  Michael Scheer
*CMZ :  1.17/03 21/03/2016  09.58.20  by  Michael Scheer
*CMZ :  1.17/02 14/03/2016  10.05.05  by  Michael Scheer
*-- Author :    Michael Scheer   07/03/2016
      subroutine undumag_proc

      use omp_lib
      use bpolyederf90m
      use undumagf90m
      use commandlinef90m

!      bpebc(1:3,imag) contains position of magnet imag
!      bpebc(4:6,imag) contains normalized magnetization vector of magnet imag

      implicit none

      double precision, dimension (:,:), allocatable :: bciron

      double precision x,y,z,hxo,hyo,hzo,h,hx,hy,hz,bn,xcut,
     &  tr(3,3),ti(3,3),bcrot3,hconvo,hconvr,dh,dho,dampirono,
     &  bc(3),vmaglab(3),xin(3),yin(3),a(3),yopt,xopt,yp(3),
     &  bx,by,bz,bmax

      real g(3),xm,ym,zm

      integer imag,jc,iterold,ifail,nmatsiz,idx,nmaxth,mag,lun,nplan,
     &  krunmatrix,mmag,i,k,m,iplan,lunst,ith,iprint,istat,magbmax,imat
      integer :: nconv=0,mark=0

      integer, dimension (:), allocatable :: irecover
      integer*8 nmagnmag,mat,mapmode

      logical lexist

      save nmaxth,ith

      if (nrec.eq.0.and.ncwires.eq.0) then
        write(lun6,*)
        write(lun6,*)"*** Nothing to solve in undumag_proc, i.e. no magnets no coils  ***"
        write(lun6,*)
        return
      endif

      if (kprint.lt.0) kprint=0

      if (niron.gt.0.and.kresiron.ne.0) then
        do imag=nrec+1,nrec+niron
           mat=nint(bpebc(9,imag))
           mapmode=mapmode+matmaps(3,mat)
        enddo
        if (mapmode.eq.0) then
          write(lun6,*)
          write(lun6,*)"*** Only iron with infinity mu found***"
          write(lun6,*)"*** KRESIRON SET TO ZERO ***"
          write(lun6,*)
          kresiron=0
        endif
        if (kresiron.ne.0.and.kprint.eq.0) then
          write(lun6,*)
          write(lun6,*)"*** Warning KRESIRON IS SET, BUT KPRINT ZERO ***"
          write(lun6,*)"*** KRESIRON SET TO ZERO ***"
          write(lun6,*)
          kresiron=0
        endif
      else if (niron.le.0.and.kresiron.ne.0) then
          write(lun6,*)
          write(lun6,*)"*** Warning KRESIRON is set, but there is no iron ****"
          write(lun6,*)"*** KRESIRON set to zero ***"
          write(lun6,*)
          kresiron=0
      endif

      open(newunit=lunst,file="undumag.sta")
      write(lunst,*)kundurun,konv,iwarnsum
      write(lunst,*)"undumag_proc"
      close(lunst)

      if (newclc.ne.0) then
        do imag=1,nmag
          imat=int(bpebc(9,imag))
          if (matmaps(2,imat).eq.1) cycle
          bpebc(4,imag)=0.001 ! for convmat etc.
          bpebc(7,imag)=0.001 ! for convmat etc.
        enddo
      endif

      allocate(bciron(9,niron))

      if (kpreset.eq.0) bpebc(11:13,nrec+1:nmag)=0.0d0

      dampirono=dampiron
      dampiron=abs(dampiron)

      if (ncwires.gt.0) then
        bmax=-1.0d30
        do imag=1,nmag
          x=bpebc(1,imag)/1000.0d0
          y=bpebc(2,imag)/1000.0d0
          z=bpebc(3,imag)/1000.0d0
          call undumag_bcoils(x,y,z,bx,by,bz,istat)
          bpebc(18,imag)=bx
          bpebc(19,imag)=by
          bpebc(20,imag)=bz
          bn=sqrt(bx**2+by**2+bz**2)
          if (bn.gt.bmax) then
            bmax=bn
            magbmax=imag
            xm=x*1000.
            ym=y*1000.
            zm=z*1000.
          endif
        enddo
        if (nmag.gt.0) then
          write(lun6,*)
          write(lun6,'(a,g12.5,a,3g12.5)')"Undumag_proc: Max. field of coils in magnets: ",sngl(bmax)," at ",xm,ym,zm
          write(lun6,*)
        endif
      endif

      if (maxiter.le.0.or.(nmag.eq.0.and.kbextern.eq.0))
     &  goto 99999

      if (irandmag.lt.0) then
        do imag=1,nmag
          call util_random(3,g)
          g=g-0.5
          if (abs(g(1)).lt.randox10) then
            if (g(1).gt.0.0d0) then
              g(1)=g(1)+randox10
            else
              g(1)=g(1)-randox10
            endif
          endif
          if (abs(g(2)).lt.randoy10) then
            if (g(2).gt.0.0d0) then
              g(2)=g(2)+randoy10
            else
              g(2)=g(2)-randoy10
            endif
          endif
          if (abs(g(3)).lt.randoz10) then
            if (g(3).gt.0.0d0) then
              g(3)=g(3)+randoz10
            else
              g(3)=g(3)-randoz10
            endif
          endif
          bpebc(1,imag)=bpebc(1,imag)+g(1)*randox
          bpebc(2,imag)=bpebc(2,imag)+g(2)*randoy
          bpebc(3,imag)=bpebc(3,imag)+g(3)*randoz
        enddo
      endif

      allocate(bc0(10,nmag))

      allocate(bpm(nplanmax,nmag))
      do imag=1,nmag
        if(bpebc(8,imag).eq.1) then !not a rectangular magnet
          do iplan=1,iabs(ibpeplan(imag))
            bpm(iplan,imag)=bpetm(1,7,iplan,imag)
          enddo
        endif
      enddo

      bc0(7:10,1:nmag)=bpebc(11:14,1:nmag) ! keep the original magnetization

      iterold=maxiteriron
      kconv=0

      kinside=0
      h=0.0d0

      allocate (convmat(3,3,nxconv,nmag))
      if (ncwires.gt.0) then
        allocate(bxconvw(nxconv),byconvw(nxconv),bzconvw(nxconv))
      endif
c      allocate(bcc(3,nmag))

c      bcc(1:3,1:nmag)=bpebc(4:6,1:nmag)

      nmaxth=1
      nmaxth=OMP_GET_MAX_THREADS()
      if (nthreads.gt.0) nmaxth=min(nmaxth,nthreads)
      write(lun6,*)
      write(lun6,*)"Number of CPU cores used:",nmaxth
      write(lun6,*)

      allocate(irecover(nmaxth))
      irecover=0
      ith=1
      do mag=1,nmag

        do i=1,nxconv

          x=xconv(i)
          xcut=2.0d0*xsym-x
          y=yconv
          z=zconv

          if (ncwires.gt.0) then
            call undumag_bcoils(x,y,z,bxconvw(i),byconvw(i),bzconvw(i),ifail)
          endif

          bpebc(4:6,mag)=0.0d0
          bpebc(3+1,mag)=1.0d0

          if(bpebc(8,mag).eq.1) then !not a rectangular magnet
            do iplan=1,iabs(ibpeplan(mag))
              bpetm(1,7,iplan,mag)=bpetm(1,8,iplan,mag)
            enddo
          endif

          call undumag_bpolyeder1(mag,x,y,z,hx,hy,hz,ifail)

          if (ifail.gt.0) then
            write(lun6,*)""
            write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
            write(lun6,*)"mag,x,y,z:",mag,x,y,z
            write(lun6,*)""
            iwarnsum=10
          else if (ifail.lt.0) then
c            write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
c            write(lun6,*)"mag, ifail:",mag,ifail
            irecover(ith)=irecover(ith)+1
          endif

          convmat(1,1,i,mag)=hx
          convmat(2,1,i,mag)=hy
          convmat(3,1,i,mag)=hz

          if (ixsym.eq.0) then
            if (iysym.ne.0) then
              call undumag_bpolyeder1(mag,x,-y,z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,x,-y,z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
c                write(lun6,*)"mag,ifail:",mag,ifail
              endif
              convmat(1,1,i,mag)=convmat(1,1,i,mag)-hx
              convmat(2,1,i,mag)=convmat(2,1,i,mag)+hy
              convmat(3,1,i,mag)=convmat(3,1,i,mag)-hz
            endif
            if (izsym.ne.0) then
              call undumag_bpolyeder1(mag,x,y,-z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,x,y,-z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
c                write(lun6,*)"mag,ifail:",mag,ifail
              endif
              convmat(1,1,i,mag)=convmat(1,1,i,mag)+hx
              convmat(2,1,i,mag)=convmat(2,1,i,mag)+hy
              convmat(3,1,i,mag)=convmat(3,1,i,mag)-hz
            endif
            if (iysym.ne.0.and.izsym.ne.0) then
              call undumag_bpolyeder1(mag,x,-y,-z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,x,-y,-z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
c                write(lun6,*)"mag,ifail:",mag,ifail
              endif
              convmat(1,1,i,mag)=convmat(1,1,i,mag)-hx
              convmat(2,1,i,mag)=convmat(2,1,i,mag)+hy
              convmat(3,1,i,mag)=convmat(3,1,i,mag)+hz
            endif
          else !ixsym
            call undumag_bpolyeder1(mag,xcut,y,z,hx,hy,hz,ifail)
            if (ifail.gt.0) then
              write(lun6,*)""
              write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
              write(lun6,*)"mag,x,y,z:",mag,xcut,y,z
              write(lun6,*)""
            else if (ifail.lt.0) then
c              write(lun6,*)"mag,ifail:",mag,ifail
              irecover(ith)=irecover(ith)+1
            endif
            convmat(1,1,i,mag)=convmat(1,1,i,mag)-hx
            convmat(2,1,i,mag)=convmat(2,1,i,mag)+hy
            convmat(3,1,i,mag)=convmat(3,1,i,mag)+hz
            if (iysym.ne.0) then
              call undumag_bpolyeder1(mag,x,-y,z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,x,-y,z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,1,i,mag)=convmat(1,1,i,mag)-hx
              convmat(2,1,i,mag)=convmat(2,1,i,mag)+hy
              convmat(3,1,i,mag)=convmat(3,1,i,mag)-hz
              call undumag_bpolyeder1(mag,xcut,-y,z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,xcut,-y,z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,1,i,mag)=convmat(1,1,i,mag)+hx
              convmat(2,1,i,mag)=convmat(2,1,i,mag)+hy
              convmat(3,1,i,mag)=convmat(3,1,i,mag)-hz
            endif
            if (izsym.ne.0) then
              call undumag_bpolyeder1(mag,x,y,-z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,x,y,-z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,1,i,mag)=convmat(1,1,i,mag)+hx
              convmat(2,1,i,mag)=convmat(2,1,i,mag)+hy
              convmat(3,1,i,mag)=convmat(3,1,i,mag)-hz
              call undumag_bpolyeder1(mag,xcut,y,-z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,xcut,y,-z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,1,i,mag)=convmat(1,1,i,mag)-hx
              convmat(2,1,i,mag)=convmat(2,1,i,mag)+hy
              convmat(3,1,i,mag)=convmat(3,1,i,mag)-hz
            endif
            if (iysym.ne.0.and.izsym.ne.0) then
              call undumag_bpolyeder1(mag,x,-y,-z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 convmat:"
                write(lun6,*)"mag,x,y,z:",mag,x,-y,-z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,1,i,mag)=convmat(1,1,i,mag)-hx
              convmat(2,1,i,mag)=convmat(2,1,i,mag)+hy
              convmat(3,1,i,mag)=convmat(3,1,i,mag)+hz
              call undumag_bpolyeder1(mag,xcut,-y,-z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 convmat:"
                write(lun6,*)"mag,x,y,z:",mag,xcut,-y,-z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,1,i,mag)=convmat(1,1,i,mag)+hx
              convmat(2,1,i,mag)=convmat(2,1,i,mag)+hy
              convmat(3,1,i,mag)=convmat(3,1,i,mag)+hz
            endif
          endif !(ixsym.eq.0) then

          bpebc(4:6,mag)=0.0d0
          bpebc(3+2,mag)=1.0d0

          if(bpebc(8,mag).eq.1) then !not a rectangular magnet
            do iplan=1,iabs(ibpeplan(mag))
              bpetm(1,7,iplan,mag)=bpetm(2,8,iplan,mag)
            enddo
          endif

          call undumag_bpolyeder1(mag,x,y,z,hx,hy,hz,ifail)

          if (ifail.gt.0) then
            write(lun6,*)""
            write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
            write(lun6,*)"mag,x,y,z:",mag,x,y,z
            write(lun6,*)""
            iwarnsum=10
          else if (ifail.lt.0) then
            irecover(ith)=irecover(ith)+1
          endif

          convmat(1,2,i,mag)=hx
          convmat(2,2,i,mag)=hy
          convmat(3,2,i,mag)=hz

          if (ixsym.eq.0) then
            if (iysym.ne.0) then
              call undumag_bpolyeder1(mag,x,-y,z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,x,-y,z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,2,i,mag)=convmat(1,2,i,mag)-hx
              convmat(2,2,i,mag)=convmat(2,2,i,mag)+hy
              convmat(3,2,i,mag)=convmat(3,2,i,mag)-hz
            endif
            if (izsym.ne.0) then
              call undumag_bpolyeder1(mag,x,y,-z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,x,y,-z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,2,i,mag)=convmat(1,2,i,mag)+hx
              convmat(2,2,i,mag)=convmat(2,2,i,mag)+hy
              convmat(3,2,i,mag)=convmat(3,2,i,mag)-hz
            endif
            if (iysym.ne.0.and.izsym.ne.0) then
              call undumag_bpolyeder1(mag,x,-y,-z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,x,-y,-z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,2,i,mag)=convmat(1,2,i,mag)-hx
              convmat(2,2,i,mag)=convmat(2,2,i,mag)+hy
              convmat(3,2,i,mag)=convmat(3,2,i,mag)+hz
            endif
          else !ixsym
            call undumag_bpolyeder1(mag,xcut,y,z,hx,hy,hz,ifail)
            if (ifail.gt.0) then
              write(lun6,*)""
              write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
              write(lun6,*)"mag,x,y,z:",mag,xcut,y,z
              write(lun6,*)""
            else if (ifail.lt.0) then
              irecover(ith)=irecover(ith)+1
            endif
            convmat(1,2,i,mag)=convmat(1,2,i,mag)-hx
            convmat(2,2,i,mag)=convmat(2,2,i,mag)+hy
            convmat(3,2,i,mag)=convmat(3,2,i,mag)+hz
            if (iysym.ne.0) then
              call undumag_bpolyeder1(mag,x,-y,z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,x,-y,z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,2,i,mag)=convmat(1,2,i,mag)-hx
              convmat(2,2,i,mag)=convmat(2,2,i,mag)+hy
              convmat(3,2,i,mag)=convmat(3,2,i,mag)-hz
              call undumag_bpolyeder1(mag,xcut,-y,z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,xcut,-y,z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,2,i,mag)=convmat(1,2,i,mag)+hx
              convmat(2,2,i,mag)=convmat(2,2,i,mag)+hy
              convmat(3,2,i,mag)=convmat(3,2,i,mag)-hz
            endif
            if (izsym.ne.0) then
              call undumag_bpolyeder1(mag,x,y,-z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,x,y,-z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,2,i,mag)=convmat(1,2,i,mag)+hx
              convmat(2,2,i,mag)=convmat(2,2,i,mag)+hy
              convmat(3,2,i,mag)=convmat(3,2,i,mag)-hz
              call undumag_bpolyeder1(mag,xcut,y,-z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,xcut,y,-z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,2,i,mag)=convmat(1,2,i,mag)-hx
              convmat(2,2,i,mag)=convmat(2,2,i,mag)+hy
              convmat(3,2,i,mag)=convmat(3,2,i,mag)-hz
            endif
            if (iysym.ne.0.and.izsym.ne.0) then
              call undumag_bpolyeder1(mag,x,-y,-z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,x,-y,-z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,2,i,mag)=convmat(1,2,i,mag)-hx
              convmat(2,2,i,mag)=convmat(2,2,i,mag)+hy
              convmat(3,2,i,mag)=convmat(3,2,i,mag)+hz
              call undumag_bpolyeder1(mag,xcut,-y,-z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,xcut,-y,-z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,2,i,mag)=convmat(1,2,i,mag)+hx
              convmat(2,2,i,mag)=convmat(2,2,i,mag)+hy
              convmat(3,2,i,mag)=convmat(3,2,i,mag)+hz
            endif
          endif !(ixsym.eq.0) then

          bpebc(4:6,mag)=0.0d0
          bpebc(3+3,mag)=1.0d0

          if(bpebc(8,mag).eq.1) then !not a rectangular magnet
            do iplan=1,iabs(ibpeplan(mag))
              bpetm(1,7,iplan,mag)=bpetm(1,8,iplan,mag)
            enddo
          endif

          call undumag_bpolyeder1(mag,x,y,z,hx,hy,hz,ifail)

          if (ifail.gt.0) then
            write(lun6,*)""
            write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
            write(lun6,*)"mag,x,y,z:",mag,x,y,z
            write(lun6,*)""
            iwarnsum=10
          else if (ifail.lt.0) then
            irecover(ith)=irecover(ith)+1
          endif

          convmat(1,3,i,mag)=hx
          convmat(2,3,i,mag)=hy
          convmat(3,3,i,mag)=hz

          if (ixsym.eq.0) then
            if (iysym.ne.0) then
              call undumag_bpolyeder1(mag,x,-y,z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,x,-y,z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,3,i,mag)=convmat(1,3,i,mag)-hx
              convmat(2,3,i,mag)=convmat(2,3,i,mag)+hy
              convmat(3,3,i,mag)=convmat(3,3,i,mag)-hz
            endif
            if (izsym.ne.0) then
              call undumag_bpolyeder1(mag,x,y,-z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,x,y,-z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,3,i,mag)=convmat(1,3,i,mag)+hx
              convmat(2,3,i,mag)=convmat(2,3,i,mag)+hy
              convmat(3,3,i,mag)=convmat(3,3,i,mag)-hz
            endif
            if (iysym.ne.0.and.izsym.ne.0) then
              call undumag_bpolyeder1(mag,x,-y,-z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,x,-y,-z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,3,i,mag)=convmat(1,3,i,mag)-hx
              convmat(2,3,i,mag)=convmat(2,3,i,mag)+hy
              convmat(3,3,i,mag)=convmat(3,3,i,mag)+hz
            endif
          else !ixsym
            call undumag_bpolyeder1(mag,xcut,y,z,hx,hy,hz,ifail)
            if (ifail.gt.0) then
              write(lun6,*)""
              write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
              write(lun6,*)"mag,x,y,z:",mag,xcut,y,z
              write(lun6,*)""
            else if (ifail.lt.0) then
              irecover(ith)=irecover(ith)+1
            endif
            convmat(1,3,i,mag)=convmat(1,3,i,mag)-hx
            convmat(2,3,i,mag)=convmat(2,3,i,mag)+hy
            convmat(3,3,i,mag)=convmat(3,3,i,mag)+hz
            if (iysym.ne.0) then
              call undumag_bpolyeder1(mag,x,-y,z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,x,-y,z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,3,i,mag)=convmat(1,3,i,mag)-hx
              convmat(2,3,i,mag)=convmat(2,3,i,mag)+hy
              convmat(3,3,i,mag)=convmat(3,3,i,mag)-hz
              call undumag_bpolyeder1(mag,xcut,-y,z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,xcut,-y,z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,3,i,mag)=convmat(1,3,i,mag)+hx
              convmat(2,3,i,mag)=convmat(2,3,i,mag)+hy
              convmat(3,3,i,mag)=convmat(3,3,i,mag)-hz
            endif
            if (izsym.ne.0) then
              call undumag_bpolyeder1(mag,x,y,-z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,x,y,-z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,3,i,mag)=convmat(1,3,i,mag)+hx
              convmat(2,3,i,mag)=convmat(2,3,i,mag)+hy
              convmat(3,3,i,mag)=convmat(3,3,i,mag)-hz
              call undumag_bpolyeder1(mag,xcut,y,-z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,xcut,y,-z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,3,i,mag)=convmat(1,3,i,mag)-hx
              convmat(2,3,i,mag)=convmat(2,3,i,mag)+hy
              convmat(3,3,i,mag)=convmat(3,3,i,mag)-hz
            endif
            if (iysym.ne.0.and.izsym.ne.0) then
              call undumag_bpolyeder1(mag,x,-y,-z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,x,-y,-z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,3,i,mag)=convmat(1,3,i,mag)-hx
              convmat(2,3,i,mag)=convmat(2,3,i,mag)+hy
              convmat(3,3,i,mag)=convmat(3,3,i,mag)+hz
              call undumag_bpolyeder1(mag,xcut,-y,-z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1 for convmat:"
                write(lun6,*)"mag,x,y,z:",mag,xcut,-y,-z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              convmat(1,3,i,mag)=convmat(1,3,i,mag)+hx
              convmat(2,3,i,mag)=convmat(2,3,i,mag)+hy
              convmat(3,3,i,mag)=convmat(3,3,i,mag)+hz
            endif
          endif !(ixsym.eq.0) then

        enddo ! nxconv
      enddo ! magmag

      if (irecover(ith).ne.0) then
        write(lun6,*)"*** Warning in undumag_proc: Recovered from ",irecover(ith),
     &    " errors while calculating convergence vector ***"
      endif

      if (matrix.gt.0) then
        allocate(wwmatrix4(3,3,nmag,nmag),stat=istat)
        if (istat.ne.0) then
          write(lun6,*)'*** Error in undumag_proc: Not enough memory for interaction matrix of size 3x3x',nmag,' x ',nmag
          stop "*** UNDUMAG ABORTED ***"
        endif
        wwmatrix4=0.0d0
      endif

      irecover=0

      if (matrix.gt.0) then

        call util_zeit_kommentar(lun6,"Setting-up the matrix.")

        nmagnmag=nmag*nmag
        write(lun6,*)
        write(lun6,*)"Matrix size 3 x 3 x:",nmag," x ",nmag," = ",nmagnmag*9
        write(lun6,*)

        iumatrix=0
        do imag=1,nmag
          if (irandmag.eq.0) then
            x=bpebc(1,imag)/1000.0d0
            y=bpebc(2,imag)/1000.0d0
            z=bpebc(3,imag)/1000.0d0
          else
            call util_random(3,g)
            x=(bpebc(1,imag)+(g(1)-0.5)*randoxa)/1000.0d0
            y=(bpebc(2,imag)+(g(2)-0.5)*randoya)/1000.0d0
            z=(bpebc(3,imag)+(g(3)-0.5)*randoza)/1000.0d0
          endif
          xcut=2.0d0*xsym-x

          mark=mark+1
!$OMP PARALLEL NUM_THREADS(nmaxth) DEFAULT(PRIVATE)
!$OMP& SHARED(lun6,irecover,ixsym,iysym,izsym,bpebc,bpetm,ibpeplan,wwmatrix4)
!$OMP& FIRSTPRIVATE(imag,nmag,x,y,z,xcut)
          ith=OMP_GET_THREAD_NUM()+1
!$OMP DO

          do mag=1,nmag

            bpebc(4:6,mag)=0.0d0
            bpebc(3+1,mag)=1.0d0

            if(bpebc(8,mag).eq.1) then !not a rectangular magnet
              do iplan=1,iabs(ibpeplan(mag))
                bpetm(1,7,iplan,mag)=bpetm(1,8,iplan,mag)
              enddo
            endif

            call undumag_bpolyeder1(mag,x,y,z,hx,hy,hz,ifail)

            h=sqrt(hx**2+hy**2+hz**2)
            if (h.gt.2.0d0) then
              write(lun6,*)"*** Warning in undumag_proc: Strange H return by undumag_bpolyeder1 for wwmatrix(1...)"
              write(lun6,*)"imag,mag, hx,hy,hz",imag,mag,hx,hy,hz
            endif

            if (ifail.gt.0) then
              write(lun6,*)""
              write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
              print '(a,2i7,3f7.5,3e15.5e3)',"mag1,mag2,x,y,z:",mag,imag,x,y,z,hx,hy,hz
              write(lun6,*)""
              iwarnsum=10
            else if (ifail.lt.0) then
              irecover(ith)=irecover(ith)+1
            endif

            wwmatrix4(1,1,mag,imag)=hx
            wwmatrix4(1,2,mag,imag)=hy
            wwmatrix4(1,3,mag,imag)=hz

            if (ixsym.eq.0) then
              if (iysym.ne.0) then
                call undumag_bpolyeder1(mag,x,-y,z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,x,-y,z
                  write(lun6,*)""
                else if (ifail.lt.0) then
                  irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(1,1,mag,imag)=wwmatrix4(1,1,mag,imag)-hx
                wwmatrix4(1,2,mag,imag)=wwmatrix4(1,2,mag,imag)-hy
                wwmatrix4(1,3,mag,imag)=wwmatrix4(1,3,mag,imag)-hz
              endif

              if (izsym.ne.0) then
                call undumag_bpolyeder1(mag,x,y,-z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,x,y,-z
                  write(lun6,*)""
                else if (ifail.lt.0) then
                  irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(1,1,mag,imag)=wwmatrix4(1,1,mag,imag)+hx
                wwmatrix4(1,2,mag,imag)=wwmatrix4(1,2,mag,imag)+hy
                wwmatrix4(1,3,mag,imag)=wwmatrix4(1,3,mag,imag)+hz
              endif
              if (iysym.ne.0.and.izsym.ne.0) then
                call undumag_bpolyeder1(mag,x,-y,-z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,x,-y,-z
                  write(lun6,*)""
                else if (ifail.lt.0) then
                  irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(1,1,mag,imag)=wwmatrix4(1,1,mag,imag)-hx
                wwmatrix4(1,2,mag,imag)=wwmatrix4(1,2,mag,imag)-hy
                wwmatrix4(1,3,mag,imag)=wwmatrix4(1,3,mag,imag)-hz
              endif
            else !ixsym
              call undumag_bpolyeder1(mag,xcut,y,z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,xcut,y,z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              wwmatrix4(1,1,mag,imag)=wwmatrix4(1,1,mag,imag)-hx
              wwmatrix4(1,2,mag,imag)=wwmatrix4(1,2,mag,imag)-hy
              wwmatrix4(1,3,mag,imag)=wwmatrix4(1,3,mag,imag)-hz
              if (iysym.ne.0) then
                call undumag_bpolyeder1(mag,x,-y,z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,x,-y,z
                  write(lun6,*)""
                else if (ifail.lt.0) then
                  irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(1,1,mag,imag)=wwmatrix4(1,1,mag,imag)-hx
                wwmatrix4(1,2,mag,imag)=wwmatrix4(1,2,mag,imag)-hy
                wwmatrix4(1,3,mag,imag)=wwmatrix4(1,3,mag,imag)-hz
                call undumag_bpolyeder1(mag,xcut,-y,z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,xcut,-y,z
                  write(lun6,*)""
                else if (ifail.lt.0) then
                  irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(1,1,mag,imag)=wwmatrix4(1,1,mag,imag)+hx
                wwmatrix4(1,2,mag,imag)=wwmatrix4(1,2,mag,imag)+hy
                wwmatrix4(1,3,mag,imag)=wwmatrix4(1,3,mag,imag)+hz
              endif
              if (izsym.ne.0) then
                call undumag_bpolyeder1(mag,x,y,-z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,x,y,-z
                  write(lun6,*)""
                else if (ifail.lt.0) then
                  irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(1,1,mag,imag)=wwmatrix4(1,1,mag,imag)+hx
                wwmatrix4(1,2,mag,imag)=wwmatrix4(1,2,mag,imag)+hy
                wwmatrix4(1,3,mag,imag)=wwmatrix4(1,3,mag,imag)+hz
                call undumag_bpolyeder1(mag,xcut,y,-z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,xcut,y,-z
                  write(lun6,*)""
                else if (ifail.lt.0) then
                  irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(1,1,mag,imag)=wwmatrix4(1,1,mag,imag)-hx
                wwmatrix4(1,2,mag,imag)=wwmatrix4(1,2,mag,imag)-hy
                wwmatrix4(1,3,mag,imag)=wwmatrix4(1,3,mag,imag)-hz
              endif
              if (iysym.ne.0.and.izsym.ne.0) then
                call undumag_bpolyeder1(mag,x,-y,-z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,x,-y,-z
                  write(lun6,*)""
                else if (ifail.lt.0) then
                  irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(1,1,mag,imag)=wwmatrix4(1,1,mag,imag)-hx
                wwmatrix4(1,2,mag,imag)=wwmatrix4(1,2,mag,imag)-hy
                wwmatrix4(1,3,mag,imag)=wwmatrix4(1,3,mag,imag)-hz
                call undumag_bpolyeder1(mag,xcut,-y,-z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,xcut,-y,-z
                  write(lun6,*)""
                else if (ifail.lt.0) then
                  irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(1,1,mag,imag)=wwmatrix4(1,1,mag,imag)+hx
                wwmatrix4(1,2,mag,imag)=wwmatrix4(1,2,mag,imag)+hy
                wwmatrix4(1,3,mag,imag)=wwmatrix4(1,3,mag,imag)+hz
              endif
            endif !(ixsym.eq.0) then

            bpebc(4:6,mag)=0.0d0
            bpebc(3+2,mag)=1.0d0

            if(bpebc(8,mag).eq.1) then !not a rectangular magnet
              do iplan=1,iabs(ibpeplan(mag))
                bpetm(1,7,iplan,mag)=bpetm(2,8,iplan,mag)
              enddo
            endif

            call undumag_bpolyeder1(mag,x,y,z,hx,hy,hz,ifail)

            h=sqrt(hx**2+hy**2+hz**2)
            if (h.gt.2.0d0) then
              write(lun6,*)"*** Warning in undumag_proc: Strange H return by undumag_bpolyeder1 for wwmatrix(2...)"
              write(lun6,*)"imag,mag, hx,hy,hz",imag,mag,hx,hy,hz
            endif

            if (ifail.gt.0) then
              write(lun6,*)""
              write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
              write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,x,y,z
              write(lun6,*)""
            else if (ifail.lt.0) then
              irecover(ith)=irecover(ith)+1
            endif

            wwmatrix4(2,1,mag,imag)=hx
            wwmatrix4(2,2,mag,imag)=hy
            wwmatrix4(2,3,mag,imag)=hz

            if (ixsym.eq.0) then
              if (iysym.ne.0) then
                call undumag_bpolyeder1(mag,x,-y,z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,x,-y,z
                  write(lun6,*)""
                else if (ifail.lt.0) then
                  irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(2,1,mag,imag)=wwmatrix4(2,1,mag,imag)+hx
                wwmatrix4(2,2,mag,imag)=wwmatrix4(2,2,mag,imag)+hy
                wwmatrix4(2,3,mag,imag)=wwmatrix4(2,3,mag,imag)+hz
              endif
              if (izsym.ne.0) then
                call undumag_bpolyeder1(mag,x,y,-z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,x,y,-z
                  write(lun6,*)""
                else if (ifail.lt.0) then
                  irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(2,1,mag,imag)=wwmatrix4(2,1,mag,imag)+hx
                wwmatrix4(2,2,mag,imag)=wwmatrix4(2,2,mag,imag)+hy
                wwmatrix4(2,3,mag,imag)=wwmatrix4(2,3,mag,imag)+hz
              endif
              if (iysym.ne.0.and.izsym.ne.0) then
                call undumag_bpolyeder1(mag,x,-y,-z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,x,-y,-z
                  write(lun6,*)""
                else if (ifail.lt.0) then
                  irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(2,1,mag,imag)=wwmatrix4(2,1,mag,imag)+hx
                wwmatrix4(2,2,mag,imag)=wwmatrix4(2,2,mag,imag)+hy
                wwmatrix4(2,3,mag,imag)=wwmatrix4(2,3,mag,imag)+hz
              endif
            else !ixsym
              call undumag_bpolyeder1(mag,xcut,y,z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,xcut,y,z
                write(lun6,*)""
              else if (ifail.lt.0) then
                irecover(ith)=irecover(ith)+1
              endif
              wwmatrix4(2,1,mag,imag)=wwmatrix4(2,1,mag,imag)+hx
              wwmatrix4(2,2,mag,imag)=wwmatrix4(2,2,mag,imag)+hy
              wwmatrix4(2,3,mag,imag)=wwmatrix4(2,3,mag,imag)+hz
              if (iysym.ne.0) then
                call undumag_bpolyeder1(mag,x,-y,z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,x,-y,z
                  write(lun6,*)""
                else if (ifail.lt.0) then
                  irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(2,1,mag,imag)=wwmatrix4(2,1,mag,imag)+hx
                wwmatrix4(2,2,mag,imag)=wwmatrix4(2,2,mag,imag)+hy
                wwmatrix4(2,3,mag,imag)=wwmatrix4(2,3,mag,imag)+hz
                call undumag_bpolyeder1(mag,xcut,-y,z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,xcut,-y,z
                  write(lun6,*)""
                else if (ifail.lt.0) then
                  irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(2,1,mag,imag)=wwmatrix4(2,1,mag,imag)+hx
                wwmatrix4(2,2,mag,imag)=wwmatrix4(2,2,mag,imag)+hy
                wwmatrix4(2,3,mag,imag)=wwmatrix4(2,3,mag,imag)+hz
              endif
              if (izsym.ne.0) then
                call undumag_bpolyeder1(mag,x,y,-z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,x,y,-z
                  write(lun6,*)""
                else if (ifail.lt.0) then
                  irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(2,1,mag,imag)=wwmatrix4(2,1,mag,imag)+hx
                wwmatrix4(2,2,mag,imag)=wwmatrix4(2,2,mag,imag)+hy
                wwmatrix4(2,3,mag,imag)=wwmatrix4(2,3,mag,imag)+hz
                call undumag_bpolyeder1(mag,xcut,y,-z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,xcut,y,-z
                  write(lun6,*)""
                else if (ifail.lt.0) then
                  irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(2,1,mag,imag)=wwmatrix4(2,1,mag,imag)+hx
                wwmatrix4(2,2,mag,imag)=wwmatrix4(2,2,mag,imag)+hy
                wwmatrix4(2,3,mag,imag)=wwmatrix4(2,3,mag,imag)+hz
              endif
              if (iysym.ne.0.and.izsym.ne.0) then
                call undumag_bpolyeder1(mag,x,-y,-z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,x,-y,-z
                  write(lun6,*)""
                else if (ifail.lt.0) then
                  irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(2,1,mag,imag)=wwmatrix4(2,1,mag,imag)+hx
                wwmatrix4(2,2,mag,imag)=wwmatrix4(2,2,mag,imag)+hy
                wwmatrix4(2,3,mag,imag)=wwmatrix4(2,3,mag,imag)+hz
                call undumag_bpolyeder1(mag,xcut,-y,-z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,xcut,-y,-z
                  write(lun6,*)""
                else if (ifail.lt.0) then
                  irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(2,1,mag,imag)=wwmatrix4(2,1,mag,imag)+hx
                wwmatrix4(2,2,mag,imag)=wwmatrix4(2,2,mag,imag)+hy
                wwmatrix4(2,3,mag,imag)=wwmatrix4(2,3,mag,imag)+hz
              endif
            endif !(ixsym.eq.0) then

            bpebc(4:6,mag)=0.0d0
            bpebc(3+3,mag)=1.0d0

            if(bpebc(8,mag).eq.1) then !not a rectangular magnet
              do iplan=1,iabs(ibpeplan(mag))
                bpetm(1,7,iplan,mag)=bpetm(3,8,iplan,mag)
              enddo
            endif

            call undumag_bpolyeder1(mag,x,y,z,hx,hy,hz,ifail)
            h=sqrt(hx**2+hy**2+hz**2)
            if (h.gt.2.0d0) then
              write(lun6,*)"*** Warning in undumag_proc: Strange H return by undumag_bpolyeder1 for wwmatrix(3...)"
              write(lun6,*)"imag,mag, hx,hy,hz",imag,mag,hx,hy,hz
            endif

            if (ifail.gt.0) then
              write(lun6,*)""
              write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
              write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,x,y,z
              write(lun6,*)""
            else if (ifail.lt.0) then
              irecover(ith)=irecover(ith)+1
            endif

            wwmatrix4(3,1,mag,imag)=hx
            wwmatrix4(3,2,mag,imag)=hy
            wwmatrix4(3,3,mag,imag)=hz

            if (ixsym.eq.0) then
              if (iysym.ne.0) then
                call undumag_bpolyeder1(mag,x,-y,z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,x,-y,z
                  write(lun6,*)""
          else if (ifail.lt.0) then
            irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(3,1,mag,imag)=wwmatrix4(3,1,mag,imag)-hx
                wwmatrix4(3,2,mag,imag)=wwmatrix4(3,2,mag,imag)-hy
                wwmatrix4(3,3,mag,imag)=wwmatrix4(3,3,mag,imag)-hz
              endif
              if (izsym.ne.0) then
                call undumag_bpolyeder1(mag,x,y,-z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,x,y,-z
                  write(lun6,*)""
          else if (ifail.lt.0) then
            irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(3,1,mag,imag)=wwmatrix4(3,1,mag,imag)-hx
                wwmatrix4(3,2,mag,imag)=wwmatrix4(3,2,mag,imag)-hy
                wwmatrix4(3,3,mag,imag)=wwmatrix4(3,3,mag,imag)-hz
              endif
              if (iysym.ne.0.and.izsym.ne.0) then
                call undumag_bpolyeder1(mag,x,-y,-z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,x,-y,-z
                  write(lun6,*)""
          else if (ifail.lt.0) then
            irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(3,1,mag,imag)=wwmatrix4(3,1,mag,imag)+hx
                wwmatrix4(3,2,mag,imag)=wwmatrix4(3,2,mag,imag)+hy
                wwmatrix4(3,3,mag,imag)=wwmatrix4(3,3,mag,imag)+hz
              endif
            else !ixsym
              call undumag_bpolyeder1(mag,xcut,y,z,hx,hy,hz,ifail)
              if (ifail.gt.0) then
                write(lun6,*)""
                write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,xcut,y,z
                write(lun6,*)""
          else if (ifail.lt.0) then
            irecover(ith)=irecover(ith)+1
              endif
              wwmatrix4(3,1,mag,imag)=wwmatrix4(3,1,mag,imag)+hx
              wwmatrix4(3,2,mag,imag)=wwmatrix4(3,2,mag,imag)+hy
              wwmatrix4(3,3,mag,imag)=wwmatrix4(3,3,mag,imag)+hz
              if (iysym.ne.0) then
                call undumag_bpolyeder1(mag,x,-y,z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,x,-y,z
                  write(lun6,*)""
          else if (ifail.lt.0) then
            irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(3,1,mag,imag)=wwmatrix4(3,1,mag,imag)-hx
                wwmatrix4(3,2,mag,imag)=wwmatrix4(3,2,mag,imag)-hy
                wwmatrix4(3,3,mag,imag)=wwmatrix4(3,3,mag,imag)-hz
                call undumag_bpolyeder1(mag,xcut,-y,z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,xcut,-y,z
                  write(lun6,*)""
          else if (ifail.lt.0) then
            irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(3,1,mag,imag)=wwmatrix4(3,1,mag,imag)-hx
                wwmatrix4(3,2,mag,imag)=wwmatrix4(3,2,mag,imag)-hy
                wwmatrix4(3,3,mag,imag)=wwmatrix4(3,3,mag,imag)-hz
              endif
              if (izsym.ne.0) then
                call undumag_bpolyeder1(mag,x,y,-z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,x,y,-z
                  write(lun6,*)""
          else if (ifail.lt.0) then
            irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(3,1,mag,imag)=wwmatrix4(3,1,mag,imag)-hx
                wwmatrix4(3,2,mag,imag)=wwmatrix4(3,2,mag,imag)-hy
                wwmatrix4(3,3,mag,imag)=wwmatrix4(3,3,mag,imag)-hz
                call undumag_bpolyeder1(mag,xcut,y,-z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,xcut,y,-z
                  write(lun6,*)""
          else if (ifail.lt.0) then
            irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(3,1,mag,imag)=wwmatrix4(3,1,mag,imag)-hx
                wwmatrix4(3,2,mag,imag)=wwmatrix4(3,2,mag,imag)-hy
                wwmatrix4(3,3,mag,imag)=wwmatrix4(3,3,mag,imag)-hz
              endif
              if (iysym.ne.0.and.izsym.ne.0) then
                call undumag_bpolyeder1(mag,x,-y,-z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,x,-y,-z
                  write(lun6,*)""
          else if (ifail.lt.0) then
            irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(3,1,mag,imag)=wwmatrix4(3,1,mag,imag)+hx
                wwmatrix4(3,2,mag,imag)=wwmatrix4(3,2,mag,imag)+hy
                wwmatrix4(3,3,mag,imag)=wwmatrix4(3,3,mag,imag)+hz
                call undumag_bpolyeder1(mag,xcut,-y,-z,hx,hy,hz,ifail)
                if (ifail.gt.0) then
                  write(lun6,*)""
                  write(lun6,*)"*** Warning in undumag_proc: Bad return of undumag_bpolyeder1:"
                  write(lun6,*)"mag1,mag2,x,y,z:",mag,imag,xcut,-y,-z
                  write(lun6,*)""
          else if (ifail.lt.0) then
            irecover(ith)=irecover(ith)+1
                endif
                wwmatrix4(3,1,mag,imag)=wwmatrix4(3,1,mag,imag)+hx
                wwmatrix4(3,2,mag,imag)=wwmatrix4(3,2,mag,imag)+hy
                wwmatrix4(3,3,mag,imag)=wwmatrix4(3,3,mag,imag)+hz
              endif
            endif !:(ixsym.eq.0) then
99          continue

          enddo ! magmag

!$OMP END DO
!$OMP END PARALLEL
c          bpebc(4:6,imag)=bci
        enddo !imag

        do ith=2,nmaxth
          irecover(1)=irecover(1)+irecover(ith)
        enddo
        if (irecover(1).ne.0) then
          write(lun6,*)"*** Warning in undumag_proc: Recovered from ",irecover(1),
     &      " errors while calculating interaction matrix ***"
        endif

        deallocate(irecover)

        mark=mark+1

        call util_zeit_kommentar(lun6,"Matrix set up.")

        iumatrix=matrix


        if (matrix.gt.1) then
          open(newunit=lun,file='undumag_matrix.pst',form="unformatted")
          write(lun)kundurun,nmag
          do i=1,nmag
            do m=1,nmag
              write(lun)wwmatrix4(1:3,1:3,m,i)
            enddo
          enddo
          close(lun)
          call util_zeit_kommentar(lun6,"Matrix written to file undumag_matrix.pst.")
        endif

      else if (matrix.lt.0) then

        call util_zeit_kommentar(lun6,"Reading interaction matrix from undumag_matrix.pre")
        open(newunit=lun,file='undumag_matrix.pre',status='old',form="unformatted")
        read(lun)krunmatrix,mmag
        if (mmag.ne.nmag) then
          write(lun6,*)"*** Error in undumag_proc: Matrix of file undumag_matrix.mag does not match number of magnets ***"
          stop
        endif

        do i=1,mmag
          do k=1,mmag
            read(lun)wwmatrix4(1:3,1:3,k,i)
          enddo
        enddo
        close(lun)
        call util_zeit_kommentar(lun6,"Interaction matrix read")
        iumatrix=matrix

      endif !matrix.ne.0

      do imag=1,nmag
        bn=bc0(10,imag)
        bpebc(4:6,imag)=bc0(7:9,imag)*bn
        bpebc(7,imag)=bn
      enddo
c      bpebc(4:6,1:nmag)=bcc(1:3,1:nmag)
c      deallocate(bcc)

      do imag=1,nmag
        if(bpebc(8,imag).eq.1) then !not a rectangular magnet
          do iplan=1,ibpeplan(imag)
            bpetm(1,7,iplan,imag)=bpm(iplan,imag)
          enddo
        endif
      enddo

      magmag=0

      allocate(bc00(6,nmag))
      mark=mark+1

      do imag=1,nmag
        bc00(1,imag)=wwmatrix4(1,1,imag,imag)
        bc00(2,imag)=wwmatrix4(2,2,imag,imag)
        bc00(3,imag)=wwmatrix4(3,3,imag,imag)
      enddo !nmag

      call undumag_bconv(h)

      call util_zeit_kommentar(lun6,"Starting relaxation.")

      mark=mark+1

      halt=0.0d0
      xin(1)=0.0d0
      xin(2)=1.0d0
      xin(3)=2.0d0
      do kiter=1,maxiter

        if (niron.gt.0) then
          if (kesti.gt.0) then
            bciron(1:3,1:niron)=bciron(4:6,1:niron)
            bciron(4:6,1:niron)=bciron(7:9,1:niron)
            bciron(7:9,1:niron)=bpebc(4:6,nrec+1:nrec+niron)
            if(kiter.ge.kesti) then
              do imag=nrec+1,nrec+niron
                do i=1,3
                  yin(1)=bciron(i,imag)
                  yin(2)=bciron(i+3,imag)
                  yin(3)=bciron(i+6,imag)
                  call util_parabel(xin,yin,a,yp,xopt,yopt,ifail)
                  if (ifail.eq.0) then
                    bpebc(3+i,nrec+1:nrec+niron)=a(1)+a(2)*3.0d0+a(3)*9.0d0
                  endif
                enddo
              enddo
            endif
          endif
          call undumag_relax_iron
        endif

        if (kiter.lt.maxiter.or.niron.eq.0) call undumag_relax_rec

        iprint=0
        if (kprint.gt.0) then
          if (mod(kiter,kprint).eq.0.or.kiter.eq.1.or.kiter.eq.maxiter) iprint=1
        endif

        kinside=0

        if (iprint.eq.1.or.kiter.eq.1) then
          h=0.0d0
          call undumag_bconv(h)
c        write(lun6,*)"proc: kiter,h:",kiter,h
          kconv=0
          if (halt.ne.0.0d0) then
            dh=(h/halt)-1.0d0
          else
            dh=0.0d0
          endif
          hconvr=abs(dh)
        endif

        if (iprint.ne.0.and.halt.ne.0.0d0) then

          call undumag_residuals_iron

          if (niron.gt.0.and.kresiron.ne.0) then
            if (kresiron.eq.1.and.hresidiron.le.resiron) goto 9999
          endif

          if (hconvr.lt.hconva) then
            print '(a,3I6,a,3g13.5)',"kiter, niterrec, niteriron, Hold, H, (H-Hold)/Hold:",
     &        kiter,niterrec,niteriron," ",halt,h,(h-halt)/halt
            if (dampfac.eq.0.0d0) then
              nconv=nconv+1
              if (nconv.ge.3) then
                if (kresiron.eq.2.and.hresidiron.le.resiron.or.
     &            kresiron.eq.0.or.niron.eq.0) goto 9999
              endif
            else
              dampiron=dampiron*dampfac
              hconva=min(hconvbase*exp(log(dampiron)*hconvexp),hconva)
c              maxiteriron=(log(0.0001)/log(1.0d0-dampiron)+1)
              if (hconva.lt.1.0d-10) then
                print '(a,3I6,a,3g13.5)',"kiter, niterrec, niteriron, Hold, H, (H-Hold)/Hold:",
     &            kiter,niterrec,niteriron," ",halt,h,(h-halt)/halt
                if (kresiron.eq.2.and.hresidiron.le.resiron.or.
     &            kresiron.eq.0) goto 9999
              endif
              write(lun6,*)"dampiron, hconv:",dampiron,hconva
            endif
          else if  (kiter.gt.2.and.hconv.lt.-1000.0d0.and.
     &        (dh.gt.0.0d0.and.dho.lt.0.0d0
     &        .or.
     &        dh.lt.0.0d0.and.dho.gt.0.0d0)
     &        ) then
            print '(a,3I6,a,3g13.5)',
     &        "kiter, niterrec, niteriron, Hold, H, (H-Hold)/Hold:",
     &        kiter,niterrec,niteriron," ",halt,h,(h-halt)/halt
            if (kresiron.eq.2.and.hresidiron.le.resiron.or.
     &        kresiron.eq.0) goto 9999
          else if  (kiter.gt.2.and.hconv.lt.0.0d0.and.hconv.gt.-1000.0d0.and.hconvr.ge.hconvo) then
            print '(a,3I6,a,3g13.5)',
     &        "kiter, niterrec, niteriron, Hold, H, (H-Hold)/Hold:",
     &        kiter,niterrec,niteriron," ",halt,h,(h-halt)/halt
            if (kresiron.eq.2.and.hresidiron.le.resiron.or.
     &        kresiron.eq.0) goto 9999
          else if (iprint.ne.0.or.kiter.eq.maxiter) then
            print '(a,3I6,a,3g13.5)',"kiter, niterrec, niteriron, Hold, H, (H-Hold)/Hold:",
     &        kiter,niterrec,niteriron," ",halt,h,(h-halt)/halt
          endif
        else if (iprint.ne.0 ) then
          print '(a,3I6,a,3g13.5)',"kiter, niterrec, niteriron, H:",
     &      kiter,niterrec,niteriron," ",h
        endif

        if (niron.gt.0.and.iprint.ne.0.and.kiter.gt.1) write(lun6,*)"RMS of iron residuals:",sngl(hresidiron)

        if (iprint.ne.0.and.kdumpconv.ne.0) then
          inquire(file="undumag.sta",exist=lexist)
          if (lexist.eqv..false.) then
            konv=-1
            write(lun6,*)"------------------------------------------------------------"
            call util_zeit_kommentar(lun6,"Aborted since file undumag.sta is missing!")
            open(newunit=lunst,file="undumag.sta")
            write(lunst,*)kundurun,konv,iwarnsum
            write(lunst,*)"Aborted by user!"
            close(lunst)
            return
          endif

          open(newunit=lunst,file="undumag.sta")
          write(lunst,*)kundurun,konv,iwarnsum
          write(lunst,*)"undumag_proc"
          if (halt.eq.0.0d0) then
            write(lunst,'(a,3I6,a,4g13.5)') "kiter, niterrec, niteriron, dampiron, H:",
     &        kiter,niterrec,niteriron," ",dampiron,h
          else
            write(lunst,'(a,3I6,a,4g13.5)') "kiter, niterrec, niteriron, (H-Hold)/Hold:",
     &        kiter,niterrec,niteriron," ",dampiron,(h-halt)/halt
          endif
          close(lunst)
        endif !(kdumpconv.ne.0) then

        if (iprint.ne.0) then
          hconvo=hconvr
          dho=dh
        endif

        if (dampirono.lt.0.0d0) then
          if (dh.gt.0) then
            dampiron=dampiron+(1.0d0-dampiron)*0.001d0
          else
            dampiron=dampiron/10.0d0
            dampirono=9999.0d0
          endif
          write(lun6,*)"dampiron adapted:",sngl(dampiron)
        endif

        if (iprint.ne.0) then
          inquire(file="undumag.sta",exist=lexist)
          if (lexist.eqv..false.) then
            konv=-1
            write(lun6,*)"------------------------------------------------------------"
            call util_zeit_kommentar(lun6,"Aborted since file undumag.sta is missing!")
            open(newunit=lunst,file="undumag.sta")
            write(lunst,*)kundurun,konv,iwarnsum
            write(lunst,*)"Aborted by user!"
            close(lunst)
            return
          endif
          iprint=0
        endif

        if (halt.ne.0.0d0.and.niron.eq.0) then
          if (abs(h/halt-1.0d0).lt.hconva) then
            print '(a,3I6,a,3g13.5)',"kiter, niterrec, niteriron, Hold, H, (H-Hold)/Hold:",
     &        kiter,niterrec,niteriron," ",halt,h,(h-halt)/halt
            goto 9999
          endif
        endif

        halt=h
      enddo !iter

9999  continue
c      deallocate(bc00)
      deallocate(bc0)
      deallocate(bpm)

99999 continue

      if (kiter.ge.maxiter) then
        konv=0
        write(lun6,*)"------------------------------------------------------------"
        call util_zeit_kommentar(lun6,"Relaxation finished, since max. number of iterations reached.")
        open(newunit=lunst,file="undumag.sta")
        write(lunst,*)kundurun,konv,iwarnsum
        write(lunst,*)"Maximum number of iterations reached!"
        close(lunst)
      else
        konv=1
        write(lun6,*)"------------------------------------------------------------"
        call util_zeit_kommentar(lun6,"Relaxation finished, convergence reached.")
        open(newunit=lunst,file="undumag.sta")
        write(lunst,*)kundurun,konv,iwarnsum
        write(lunst,*)"Convergence reached!"
        close(lunst)
      endif

      write(lun6,*)"Total number of iterations for magnets and poles:",
     &  iterrectot,iterirontot
      write(lun6,*)"------------------------------------------------------------"

      deallocate(bciron)

      return
      end
