*CMZ :          14/06/2024  09.47.34  by  Michael Scheer
*CMZ :  2.05/03 05/11/2023  15.58.43  by  Michael Scheer
*CMZ :  2.05/02 02/11/2023  12.47.23  by  Michael Scheer
*CMZ :  2.04/28 29/09/2023  16.50.35  by  Michael Scheer
*CMZ :  2.04/20 20/09/2023  15.47.37  by  Michael Scheer
*CMZ :  2.04/19 17/09/2023  15.21.47  by  Michael Scheer
*CMZ :  2.04/16 06/09/2023  14.48.40  by  Michael Scheer
*CMZ :  2.04/14 04/09/2023  13.53.15  by  Michael Scheer
*CMZ :  2.04/10 22/08/2023  09.03.52  by  Michael Scheer
*CMZ :  2.04/05 15/03/2023  09.34.01  by  Michael Scheer
*CMZ :  2.04/03 04/03/2023  17.02.39  by  Michael Scheer
*CMZ :  2.03/00 23/07/2022  09.18.29  by  Michael Scheer
*CMZ :  2.02/02 02/03/2022  13.23.21  by  Michael Scheer
*CMZ :  2.02/01 10/02/2022  12.55.23  by  Michael Scheer
*CMZ :  2.02/00 31/03/2021  20.30.51  by  Michael Scheer
*CMZ :  2.01/08 13/08/2020  11.27.23  by  Michael Scheer
*CMZ :  2.01/05 26/06/2020  16.04.15  by  Michael Scheer
*CMZ :  2.01/04 18/07/2019  13.56.54  by  Michael Scheer
*CMZ :  2.01/03 13/06/2019  15.03.29  by  Michael Scheer
*CMZ :  2.01/02 27/04/2018  14.56.07  by  Michael Scheer
*CMZ :  2.01/01 24/04/2018  17.15.25  by  Michael Scheer
*CMZ :  2.01/00 24/04/2018  14.30.21  by  Michael Scheer
*CMZ :  2.00/03 23/04/2018  17.47.12  by  Michael Scheer
*CMZ :  2.00/00 12/04/2018  08.39.07  by  Michael Scheer
*CMZ :  1.25/05 05/04/2018  19.09.03  by  Michael Scheer
*CMZ :  1.25/03 23/03/2018  16.25.38  by  Michael Scheer
*CMZ :  1.25/02 21/03/2018  13.30.12  by  Michael Scheer
*CMZ :  1.25/01 20/03/2018  15.59.20  by  Michael Scheer
*CMZ :  1.25/00 16/03/2018  12.35.49  by  Michael Scheer
*CMZ :  1.24/01 16/10/2017  19.08.03  by  Michael Scheer
*CMZ :  1.23/07 10/10/2017  13.53.24  by  Michael Scheer
*CMZ :  1.23/04 04/10/2017  11.50.12  by  Michael Scheer
*CMZ :  1.23/03 25/09/2017  18.37.06  by  Michael Scheer
*CMZ :  1.23/02 17/09/2017  11.21.15  by  Michael Scheer
*CMZ :  1.22/02 02/08/2017  16.23.00  by  Michael Scheer
*CMZ :  1.22/01 21/07/2017  14.53.35  by  Michael Scheer
*CMZ :  1.22/00 05/07/2017  08.50.03  by  Michael Scheer
*CMZ :  1.20/03 29/06/2017  11.30.39  by  Michael Scheer
*CMZ :  1.20/02 22/06/2017  15.56.28  by  Michael Scheer
*CMZ :  1.20/01 22/06/2017  12.48.09  by  Michael Scheer
*CMZ :  1.20/00 21/06/2017  13.11.48  by  Michael Scheer
*CMZ :  1.19/00 20/06/2017  12.31.54  by  Michael Scheer
*CMZ :  1.18/03 13/06/2017  15.30.31  by  Michael Scheer
*CMZ :  1.18/02 13/06/2017  14.09.42  by  Michael Scheer
*CMZ :  1.18/01 07/06/2017  09.19.34  by  Michael Scheer
*CMZ :  1.17/08 30/05/2017  16.04.28  by  Michael Scheer
*CMZ :  1.17/06 21/05/2017  12.55.08  by  Michael Scheer
*CMZ :  1.16/00 07/05/2017  12.22.37  by  Michael Scheer
*CMZ :  1.15/12 04/05/2017  12.23.38  by  Michael Scheer
*CMZ :  1.15/11 26/04/2017  11.23.30  by  Michael Scheer
*CMZ :  1.15/10 19/04/2017  12.22.06  by  Michael Scheer
*CMZ :  1.15/09 07/04/2017  14.51.07  by  Michael Scheer
*CMZ :  1.15/08 06/04/2017  14.32.29  by  Michael Scheer
*CMZ :  1.15/06 04/04/2017  13.29.10  by  Michael Scheer
*CMZ :  1.15/05 04/04/2017  12.46.33  by  Michael Scheer
*CMZ :  1.15/04 03/04/2017  12.15.21  by  Michael Scheer
*CMZ :  1.15/02 01/04/2017  19.50.52  by  Michael Scheer
*CMZ :  1.15/00 28/03/2017  11.26.05  by  Michael Scheer
*CMZ :  1.14/00 22/03/2017  09.16.41  by  Michael Scheer
*CMZ :  1.13/03 16/03/2017  10.00.53  by  Michael Scheer
*CMZ :  1.13/02 09/03/2017  17.14.36  by  Michael Scheer
*CMZ :  1.13/01 08/03/2017  15.40.55  by  Michael Scheer
*CMZ :  1.13/00 02/03/2017  16.37.53  by  Michael Scheer
*CMZ :  1.12/00 24/02/2017  08.47.15  by  Michael Scheer
*CMZ :  1.11/07 23/02/2017  17.24.23  by  Michael Scheer
*CMZ :  1.11/06 23/02/2017  13.18.36  by  Michael Scheer
*CMZ :  1.11/05 22/02/2017  12.27.44  by  Michael Scheer
*CMZ :  1.11/04 25/01/2017  10.13.44  by  Michael Scheer
*CMZ :  1.11/03 17/01/2017  14.50.40  by  Michael Scheer
*CMZ :  1.11/01 06/01/2017  13.46.07  by  Michael Scheer
*CMZ :  1.11/00 04/01/2017  15.56.40  by  Michael Scheer
*CMZ :  1.10/03 05/12/2016  15.36.58  by  Michael Scheer
*CMZ :  1.10/02 30/11/2016  16.12.02  by  Michael Scheer
*CMZ :  1.10/01 18/11/2016  15.02.58  by  Michael Scheer
*CMZ :  1.10/00 01/11/2016  09.47.47  by  Michael Scheer
*CMZ :  1.09/01 06/10/2016  09.08.03  by  Michael Scheer
*CMZ :  1.09/00 04/10/2016  09.12.28  by  Michael Scheer
*CMZ :  1.07/03 27/09/2016  18.54.27  by  Michael Scheer
*CMZ :  1.07/01 25/09/2016  11.39.27  by  Michael Scheer
*CMZ :  1.07/00 24/09/2016  14.51.14  by  Michael Scheer
*CMZ :  1.06/01 21/09/2016  15.43.31  by  Michael Scheer
*CMZ :  1.06/00 21/09/2016  13.02.17  by  Michael Scheer
*CMZ :  1.05/00 17/09/2016  10.32.16  by  Michael Scheer
*CMZ :  1.04/03 15/09/2016  17.35.03  by  Michael Scheer
*CMZ :  1.04/02 15/09/2016  16.29.44  by  Michael Scheer
*CMZ :  1.04/00 14/09/2016  10.45.28  by  Michael Scheer
*CMZ :  1.03/00 13/09/2016  13.31.19  by  Michael Scheer
*CMZ :  1.02/03 12/09/2016  11.37.12  by  Michael Scheer
*CMZ :  1.02/02 12/09/2016  10.20.23  by  Michael Scheer
*CMZ :  1.02/01 11/09/2016  12.27.52  by  Michael Scheer
*CMZ :  1.02/00 29/08/2016  14.10.42  by  Michael Scheer
*CMZ :  1.00/00 19/08/2016  17.52.14  by  Michael Scheer
*CMZ :  0.00/13 16/08/2016  12.06.57  by  Michael Scheer
*CMZ :  0.00/12 21/07/2016  09.03.47  by  Michael Scheer
*CMZ :  0.00/11 20/07/2016  16.13.39  by  Michael Scheer
*CMZ :  0.00/10 13/07/2016  15.05.25  by  Michael Scheer
*CMZ :  0.00/09 04/07/2016  17.54.03  by  Michael Scheer
*CMZ :  0.00/06 22/06/2016  13.38.55  by  Michael Scheer
*CMZ :  0.00/05 14/06/2016  13.51.40  by  Michael Scheer
*CMZ :  0.00/04 13/05/2016  14.27.24  by  Michael Scheer
*CMZ :  0.00/02 29/04/2016  09.17.43  by  Michael Scheer
*CMZ :  0.00/01 26/04/2016  15.56.38  by  Michael Scheer
*CMZ :  0.00/00 20/04/2016  12.48.03  by  Michael Scheer
*CMZ :  1.17/15 19/04/2016  15.54.31  by  Michael Scheer
*CMZ :  1.17/14 13/04/2016  12.32.55  by  Michael Scheer
*CMZ :  1.17/13 08/04/2016  11.47.10  by  Michael Scheer
*CMZ :  1.17/12 06/04/2016  14.29.22  by  Michael Scheer
*CMZ :  1.17/11 05/04/2016  12.46.06  by  Michael Scheer
*CMZ :  1.17/10 04/04/2016  14.46.34  by  Michael Scheer
*CMZ :  1.17/09 04/04/2016  09.41.39  by  Michael Scheer
*CMZ :  1.17/08 04/04/2016  08.58.50  by  Michael Scheer
*CMZ :  1.17/07 04/04/2016  08.42.21  by  Michael Scheer
*-- Author :    Michael Scheer   01/04/2016

      subroutine undumag_ini(kseg)

      use omp_lib
      use commandlinef90m
      use bpolyederf90m
      use undumagf90m
      use magnets_structure
      use displacement

      implicit none

      double precision undumag_variable_getval

*KEEP,PHYCONPARAM.
c-----------------------------------------------------------------------
c     phyconparam.cmn
c-----------------------------------------------------------------------

      complex*16, parameter :: zone1=(1.0d0,0.0d0), zi1=(0.0d0,1.0d0)

      complex*16, dimension(4,3), parameter ::
     &  vstokes=reshape([
     &  ( 0.0000000000000000d0,  0.0000000000000000d0),
     &  ( 0.0000000000000000d0,  0.0000000000000000d0),
     &  ( 0.0000000000000000d0,  0.0000000000000000d0),
     &  ( 0.0000000000000000d0,  0.0000000000000000d0),
     &  ( 0.0000000000000000d0,  0.0000000000000000d0),
     &  ( 0.0000000000000000d0, -0.70710678118654746d0),
     &  ( 0.0000000000000000d0, -0.70710678118654746d0),
     &  ( 0.70710678118654746d0, 0.0000000000000000d0),
     &  (-0.70710678118654746d0,-0.70710678118654746d0),
     &  ( 0.70710678118654746d0, 0.0000000000000000d0),
     &  (-0.70710678118654746d0, 0.0000000000000000d0),
     &  (-0.70710678118654746d0, 0.0000000000000000d0)
     &  ],[4,3])

c      vstokes(1,1)=( 0.0d0,        0.0d0)      !horizontal polarization
c      vstokes(1,2)=( 0.0d0,        0.0d0)
c      vstokes(1,3)=(-sqrt(1./2.),       -sqrt(1./2.))
c
c      vstokes(2,1)=( 0.0d0,        0.0d0)      !right handed polarization
c      vstokes(2,2)=( 0.0d0,       -sqrt(1./2.))
c      vstokes(2,3)=(+sqrt(1./2.),        0.0d0)
c
c      vstokes(3,1)=( 0.0d0,        0.0d0)      !left handed polarization
c      vstokes(3,2)=( 0.0d0,       -sqrt(1./2.))
c      vstokes(3,3)=(-sqrt(1./2.),        0.0d0)
c
c      vstokes(4,1)=( 0.0d0,        0.0d0)      !45 degree linear polarization
c      vstokes(4,2)=( sqrt(1./2.),        0.0d0)
c      vstokes(4,3)=(-sqrt(1./2.),        0.0d0)

      double precision, parameter ::
     &  HBAREV1=6.58211889D-16
     &  ,CLIGHT1=2.99792458D8
     &  ,EMASSKG1=9.10938188D-31
     &  ,EMASSE1=0.510998902D6
     &  ,EMASSG1=0.510998902D-3
     &  ,ECHARGE1=1.602176462D-19
     &  ,ERAD1=2.8179380D-15
     &  ,EPS01=8.854187817D-12
     &  ,PI1=3.141592653589793D0
     &  ,rmu04pi1=1.0D-7
     &  ,dnull1=0.0d0
     &  ,done1=1.0d0
     & ,HPLANCK1=6.626176D-34

      double precision, parameter ::
     & GRARAD1=PI1/180.0d0
     & ,RADGRA1=180.0d0/PI1
     & ,HBAR1=HBAREV1*ECHARGE1
     & ,WTOE1=CLIGHT1*HPLANCK1/ECHARGE1*1.0d9
     & ,CQ1=55.0d0/32.0d0/DSQRT(3.0D0)*HBAR1/EMASSKG1/CLIGHT1
     & ,CGAM1=4.0d0/3.0d0*PI1*ERAD1/EMASSG1**3
     & ,POL1CON1=8.0d0/5.0d0/DSQRT(3.0D0)
     & ,POL2CON1=8.0d0/5.0d0/DSQRT(3.0D0)/2.0d0/PI1/3600.0d0
     &  *EMASSKG1/HBAR1/ERAD1*EMASSG1**5
     & ,TWOPI1=2.0D0*PI1
     & ,HALFPI1=PI1/2.0D0
     & ,sqrttwopi1=sqrt(twopi1)
     & ,rmu01=4.0D0*PI1/1.0D7
     & ,alpha1=echarge1**2/(4.0d0*pi1*eps01*hbar1*clight1)
     & ,gaussn1=1.0d0/sqrt(twopi1)
     & ,cK934=ECHARGE1/(2.0d0*PI1*EMASSKG1*CLIGHT1)/100.0d0
     & ,powcon1=cgam1/2.0d0/pi1*clight1*(clight1/1.0d9)**2*emassg1
     &  ,gamma1=1.0d0/emassg1
     &  ,emom1=emasse1*dsqrt((gamma1-1.0d0)*(gamma1+1.0d0))
     &  ,rho1=emom1/clight1
     &  ,omegac1=1.5d0*gamma1**3*clight1/rho1
     &  ,ecdipev1=omegac1*hbar1/echarge1
     &  ,ecdipkev1=ecdipev1/1000.0d0

c-----------------------------------------------------------------------
c     end of phyconparam.cmn
c-----------------------------------------------------------------------
*KEEP,SEQDEBUG.
      integer iseqdebug
      common/seqdebugc/iseqdebug
*KEEP,RANDOM.
      integer*8 irancalls
      integer, parameter :: irnsize=64
      integer irnseed(irnsize),irnmode,irnseedi(irnsize)
      common /randomc/ irancalls,irnseed,irnmode,irnseedi

      namelist /randomn/ irnmode,irnseed
*KEND.

      integer lun,lunst,ivrmlo,lunrn,lundum,k,i,idatetime(8),kseg
      double precision retval

      character(10) dtday,dttime,dtzone

      twopi=twopi1

      open(newunit=lun,file="undumag.stat")
      write(lun,*)"1"
      flush(lun)
      close(lun)

      call undumag_greeter

      ! read undumag.nam
      call undumag_ini_namelists

      iwwork=abs(iundugeo)
      if(iwwork/1000.gt.0) then
        iwfct=1
        iwwork=iwwork-1000
      endif
      if(iwwork/100.gt.0) then
        iwvgeo=1
        iwwork=iwwork-100
      endif
      if(iwwork/10.gt.0) then
        iwgeo=1
        iwwork=iwwork-10
      endif
      if(iwwork.gt.0) then
        iwmag=1
      endif

      if (kseg.ne.0) then
        kechocalc=0
      endif

      ixsymo=ixsym
      iysymo=iysym
      izsymo=izsym

      ! initialize random generator
      call undumag_ini_random
c      call undumag_ini_displacement

      ! read undumag.clc
      call undumag_read_clc

      ! calculate variables
      call undumag_calc_new(kechocalc)

      nowarnugv=1

      if (perlen.eq.9999.0d0) then
        retval=undumag_variable_getval("PerLen")
        if (retval.ne.-9999.0d29) then
          perlen=retval
        else
          write(lun6,*)"*** Error in undumag_ini: Bad return from undumag_variable_getval for PerLen ***"
          write(lun6,*)"*** Setting PerLen = 100.0 ***"
          perlen=100.0d0
        endif
      endif

      retval=undumag_variable_getval("ixsym")
      if (retval.ne.-9999.0d29) ixsym=nint(retval)
      retval=undumag_variable_getval("iysym")
      if (retval.ne.-9999.0d29) iysym=nint(retval)
      retval=undumag_variable_getval("izsym")
      if (retval.ne.-9999.0d29) izsym=nint(retval)
      nowarnugv=0

      if (ixsym.ne.ixsymo.or.iysym.ne.iysymo.or.izsym.ne.izsymo) then
        print*,"*** Warning in undumag_ini: Symmetry operations of undumag.nam overwritten with values of undumag.clc ***"
      endif

      if (ixsym.lt.0.or.iysym.lt.0.or.izsym.lt.0) then
        print*,"*** Warning in undumag_ini: Hard symmetry operations, i.e. duplication of magnets not allowed ***"
        print*,"*** Switching to soft symmetry  ***"
        ixsym=abs(ixsym)
        iysym=abs(iysym)
        izsym=abs(izsym)
      endif

      call undumag_ini_materials

      call undumag_ini_magnets(kseg)
      if (kseg.ne.0) return

      if (irnmode.eq.1.or.irnmode.eq.2) then

        kundurun=0

        open(newunit=lundum,file="undumag.run",form='formatted',recl=512)
        read(lundum,*,end=197)kundurun
197     kundurun=kundurun+1
        close(lundum)

        if (irnmode.eq.2) irnseed(12)=irnseed(12)+kundurun
        call util_random_set_seed(irnsize,irnseed)

      else if (irnmode<0) then

        open(newunit=lunrn,file='undumag.seeds',status='old')
        read(lunrn,*) k
        do i=1,irnsize
          read(lunrn,*)k,irnseed(k)
        enddo
        close(lunrn)
        call util_random_set_seed(irnsize,irnseed)
      else
        call util_random_init(irnsize,irnseed)
      endif

      open(newunit=lundum,file="undumag.run",form='formatted',recl=512)

      read(lundum,*,end=97)kundurun
97    kundurun=kundurun+1

      rewind(lundum)

      call date_and_time(dtday,dttime,dtzone,idatetime)

      write(lundum,*) kundurun,trim(usercom),' ',
     &  dttime(1:2),':',dttime(3:4),':',dttime(5:6),' '
     &  ,dtday(7:8),'.',dtday(5:6),'.',dtday(3:4)
      flush(lundum)
      close(lundum)

      open(newunit=lundum,file="undumag.runs",form='formatted',recl=512,
     &  access='append')
      write(lundum,*) kundurun,trim(usercom),' ',
     &  dttime(1:2),':',dttime(3:4),':',dttime(5:6),' '
     &  ,dtday(7:8),'.',dtday(5:6),'.',dtday(3:4)
      close(lundum)

      open(newunit=lun,file='undumag.run',status='old')
      read(lun,'(a)')cundutit
      close(lun)
      cundutit(1:1)='*'

      ! write buffer file undumag.mag
      kunduplot_mode=iunduplot_mode
      if (iwmag.ne.0.or.iunduplot.ne.0) then
        call undumag_magfile
      endif

      ! write magnets, poles, and coils to undumag.geo
      if (iwmag.ne.0) call undumag_geo

      ! write interface to RADIA
      open(unit=99,file='undumag_proc.nb',status='old',iostat=i)
      if (i.eq.0) then
        close(99)
        call clcmag_to_radia
      endif

      ! write interface to RADIA for Python
      open(unit=99,file='undumag_proc.py',status='old',iostat=i)
      if (i.eq.0) then
        close(99)
        call clcmag_to_radia_python
      endif

      open(unit=99,file='undumag_proc_msh_radia.py',status='old',iostat=i)
      if (i.eq.0) then
        close(99)
        call clcmag_to_msh_radia
      endif

      if (iundugeo.lt.0) then
        open(newunit=lunst,file="undumag.stat")
        write(lunst,*)"0"
        flush(lunst)
        close(lunst)
        stop "--- Programm UNDUMAG terminated due to iundugeo < 0 ---"
      endif

      ! write magnets, poles, and coils to undumag.eps
      if (iunduplot.ne.0) call undumag_bpolyplot

      if (iunduplot.lt.0) then
        open(newunit=lunst,file="undumag.stat")
        write(lunst,*)"0"
        flush(lunst)
        close(lunst)
        stop "--- Programm UNDUMAG terminated due to iunduplot < 0 ---"
      endif


      ! write CAD file undumag.wrl of magnets and poles if ivrml.ne.0

      ivrmlo=ivrml
      ivrml=abs(ivrml)
      call undumag_to_vrml
      ivrml=ivrmlo

      if (ivrml.lt.0) then
        open(newunit=lunst,file="undumag.stat")
        write(lunst,*)"0"
        flush(lunst)
        close(lunst)
        stop "--- Programm UNDUMAG terminated due to ivrml < 0 ---"
      endif

      return
      end
