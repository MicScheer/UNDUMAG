*CMZ :  2.04/05 14/03/2023  19.31.25  by  Michael Scheer
*CMZ :  2.04/03 05/03/2023  15.03.22  by  Michael Scheer
*CMZ :  2.03/00 22/08/2022  12.27.43  by  Michael Scheer
*CMZ :  2.02/02 03/03/2022  11.56.47  by  Michael Scheer
*CMZ :  2.02/01 26/04/2021  07.33.54  by  Michael Scheer
*CMZ :  2.02/00 16/02/2021  14.20.30  by  Michael Scheer
*CMZ :  2.01/08 13/08/2020  11.30.15  by  Michael Scheer
*CMZ :  2.01/05 26/06/2020  14.58.35  by  Michael Scheer
*CMZ :  2.01/04 16/07/2019  14.49.37  by  Michael Scheer
*CMZ :  2.01/03 15/07/2019  15.06.29  by  Michael Scheer
*CMZ :  2.01/02 26/04/2018  12.28.16  by  Michael Scheer
*CMZ :  2.00/00 11/04/2018  13.52.25  by  Michael Scheer
*CMZ :  1.25/03 23/03/2018  15.53.14  by  Michael Scheer
*CMZ :  1.25/02 21/03/2018  10.11.25  by  Michael Scheer
*CMZ :  1.25/01 20/03/2018  13.49.06  by  Michael Scheer
*CMZ :  1.25/00 16/03/2018  13.28.25  by  Michael Scheer
*CMZ :  1.24/01 16/10/2017  09.19.11  by  Michael Scheer
*CMZ :  1.24/00 12/10/2017  08.36.08  by  Michael Scheer
*CMZ :  1.23/05 05/10/2017  16.45.51  by  Michael Scheer
*CMZ :  1.23/04 28/09/2017  13.54.36  by  Michael Scheer
*CMZ :  1.23/03 21/09/2017  14.46.49  by  Michael Scheer
*CMZ :  1.23/02 18/09/2017  14.00.28  by  Michael Scheer
*CMZ :  1.22/02 27/07/2017  09.16.11  by  Michael Scheer
*CMZ :  1.22/01 20/07/2017  12.02.40  by  Michael Scheer
*CMZ :  1.20/03 29/06/2017  10.53.36  by  Michael Scheer
*CMZ :  1.20/00 20/06/2017  17.32.50  by  Michael Scheer
*CMZ :  1.19/00 19/06/2017  18.04.00  by  Michael Scheer
*CMZ :  1.18/03 14/06/2017  09.16.03  by  Michael Scheer
*CMZ :  1.18/02 13/06/2017  12.18.33  by  Michael Scheer
*CMZ :  1.17/07 21/05/2017  18.28.26  by  Michael Scheer
*CMZ :  1.17/06 21/05/2017  12.01.23  by  Michael Scheer
*CMZ :  1.17/05 18/05/2017  09.20.21  by  Michael Scheer
*CMZ :  1.17/04 10/05/2017  11.17.06  by  Michael Scheer
*CMZ :  1.17/00 08/05/2017  13.25.33  by  Michael Scheer
*CMZ :  1.16/00 06/05/2017  12.55.04  by  Michael Scheer
*CMZ :  1.15/12 04/05/2017  15.51.52  by  Michael Scheer
*CMZ :  1.15/11 23/04/2017  10.38.05  by  Michael Scheer
*CMZ :  1.15/10 19/04/2017  12.19.13  by  Michael Scheer
*CMZ :  1.15/08 06/04/2017  09.03.14  by  Michael Scheer
*CMZ :  1.15/06 04/04/2017  13.28.20  by  Michael Scheer
*CMZ :  1.15/04 03/04/2017  11.21.37  by  Michael Scheer
*CMZ :  1.15/02 02/04/2017  09.38.33  by  Michael Scheer
*CMZ :  1.14/00 21/03/2017  16.23.04  by  Michael Scheer
*CMZ :  1.13/03 16/03/2017  09.37.22  by  Michael Scheer
*CMZ :  1.13/01 06/03/2017  10.14.22  by  Michael Scheer
*CMZ :  1.13/00 01/03/2017  09.19.24  by  Michael Scheer
*CMZ :  1.11/05 27/01/2017  09.42.57  by  Michael Scheer
*CMZ :  1.11/04 25/01/2017  16.52.23  by  Michael Scheer
*CMZ :  1.11/03 17/01/2017  14.50.07  by  Michael Scheer
*CMZ :  1.11/01 05/01/2017  14.35.46  by  Michael Scheer
*CMZ :  1.11/00 07/12/2016  12.38.34  by  Michael Scheer
*CMZ :  1.10/03 01/12/2016  14.58.46  by  Michael Scheer
*CMZ :  1.10/02 24/11/2016  10.20.40  by  Michael Scheer
*CMZ :  1.09/01 06/10/2016  09.05.14  by  Michael Scheer
*CMZ :  1.07/03 27/09/2016  13.44.47  by  Michael Scheer
*CMZ :  1.07/01 25/09/2016  11.38.45  by  Michael Scheer
*CMZ :  1.07/00 24/09/2016  14.27.14  by  Michael Scheer
*CMZ :  1.06/00 21/09/2016  11.55.19  by  Michael Scheer
*CMZ :  1.04/00 14/09/2016  10.45.46  by  Michael Scheer
*CMZ :  1.02/00 22/08/2016  17.13.11  by  Michael Scheer
*CMZ :  0.00/13 28/07/2016  09.47.14  by  Michael Scheer
*CMZ :  0.00/12 21/07/2016  09.03.35  by  Michael Scheer
*CMZ :  0.00/11 20/07/2016  11.39.48  by  Michael Scheer
*CMZ :  0.00/10 13/07/2016  14.56.05  by  Michael Scheer
*CMZ :  0.00/09 05/07/2016  16.04.35  by  Michael Scheer
*CMZ :  0.00/07 22/06/2016  14.09.40  by  Michael Scheer
*CMZ :  0.00/04 10/05/2016  09.06.41  by  Michael Scheer
*CMZ :  0.00/02 27/04/2016  09.26.25  by  Michael Scheer
*CMZ :  0.00/01 26/04/2016  14.57.22  by  Michael Scheer
*CMZ :  1.17/13 07/04/2016  14.37.11  by  Michael Scheer
*CMZ :  1.17/12 06/04/2016  12.17.38  by  Michael Scheer
*CMZ :  1.17/10 04/04/2016  13.37.17  by  Michael Scheer
*CMZ :  1.17/09 04/04/2016  09.08.54  by  Michael Scheer
*CMZ :  1.17/07 03/04/2016  13.18.15  by  Michael Scheer
*CMZ :  1.17/06 31/03/2016  09.17.56  by  Michael Scheer
*CMZ :  1.17/05 27/03/2016  09.00.04  by  Michael Scheer
*CMZ :  1.17/04 24/03/2016  16.12.04  by  Michael Scheer
*CMZ :  1.17/03 21/03/2016  09.38.56  by  Michael Scheer
*CMZ :  1.17/02 11/03/2016  16.56.25  by  Michael Scheer
*-- Author :    Michael Scheer   02/12/2003
      module undumagf90m

c +PATCH,//UNDUMAG/SEQ
c +DECK,UNDUMAGf90m,T=F77.

      implicit none

      integer nthreadp,nwitems
      parameter (nthreadp=1000,nwitems=11)

!      double precision, dimension (:,:,:,:), allocatable :: wwmatrix

      double precision, dimension (:,:,:), allocatable :: bcmat
      double precision, dimension (:,:), allocatable :: bc0,bc00,bpm,
     &  bpebc0,wire,race,wind,arc,carc,crace,rectbar,thickwire,brnmat

      double precision, dimension (:), allocatable ::
     &  feh1,feh2,feh3,fem1,fem2,fem3,ufespl1,
     &  fespl1,fewspl1,fewspl2,fewspl3,fewspl4,
     &  bxconvw,byconvw,bzconvw

      double precision, dimension (:,:), allocatable :: dipoles
      double precision, dimension (:,:,:), allocatable :: cornpoles

      real*4, dimension (:,:,:,:), allocatable :: wwmatrix4,convmat
c      real*4, dimension (:,:,:), allocatable :: wwmatrix

      integer, dimension (:), allocatable :: kspecmag,idamp8,ncornpoles
      integer, dimension(:,:), allocatable :: magcyl

      double precision
     &  unduplot_phi,unduplot_theta,traxyz_theta,traxyz_phi,permu,parmu,perksi,parksi,
     &  xmapmin,xmapmax,ymapmin,ymapmax,zmapmin,zmapmax,dxmap,
     &  xminpl,xmaxpl,yminpl,ymaxpl,zminpl,zmaxpl,
     &  xconvmin,xconvmax,dxconv,xconv(100),yconv,zconv,hconv,hconva,uwindow,xsym,
     &  xbeff,xbeffy,xbeffz,perlen,
     &  ebeam,zslit,xcenter,xmaxinf,xcentershift,xelec,yelec,zelec,
     &  vxelec,vyelec,vzelec,
     &  ds,xf,yf,zf,efx,efy,efz,xobsv,yobsv,zobsv,phelow,phehig,dampiron,dampi,
     &  ubfcenx,ubfceny,ubfcenz,ubflenx,ubfleny,ubflenz,
     &  utorqcenx,utorqceny,utorqcenz,
     &  fxdip,fydip,fzdip,
     &  txdip,tydip,tzdip,
     &  uservar(100),corrtiny,cuttiny,hulltiny,randos,randox,randoy,randoz
     &  ,dampfac,hconvbase,hconvexp,chicut,damp8,rcvthron,angmaprotx,
     &  cenmaprotxy,cenmaprotxz,zminprof,zmaxprof,
     &  bxex,byex,bzex,hresidiron,resiron,halt,dedgefb,coating

      real randoxa,randoya,randoza,randox10,randoy10,randoz10,
     &  randomx,randomy,randomz

      integer
     &  maxiter,maxiterrec,maxiteriron,nchiiron,ibulk,nchimax,kesti,
     &  ktetmesh,
     &  kiter,iterrectot,iterirontot,
     &  iunduplot,kcomment,krunnum,kdate,kplsym,nrec,niron,nxmap,intmaglis,noduplis,nymap,nzmap
     &  ,mode,ncornmax,nplanmax,ncornadd,nplanadd,niterrec,niteriron,niter,
     &  kconvrec,kconviron,kconv,lunconv,kdumpconv,nmatfiles,
     &  matmaps(4,1000),kpreset,matrix,
     &  magmatrix,nuthreads,
     &  ixsym,iysym,izsym,nspecmag,nxbeff,kbeffmode,
     &  ixsymo,iysymo,izsymo,
     &  ieneloss,ivelofield,nphener,nstep,kxcenter,kudebug,kcalcvars,isimpson,
     &  nxconv,kdisplace,kechocalc,knomagmap,knopolmap,isplinefm,
     &  iforce,ivrml,iundugeo,idipoles,iforcedip,iplforce,itorque,mbforcex,mbforcey,mbforcez,mfcolor,
     &  kmapmode,kmapnohead,knointmap,konv,iwarnsum,maxpoints,nmagpols,kallodip,
     &  nwarnbound, iwarnin,iwarn2pi,iwarnbound,ndipoles,killbadmag,irecrepl,kwarncom,irandmag,kshuffle,
     &  kforcemag,kurad,kbextern,kresiron,kprint,ndivfboxy,
     &  ncwires,nrace,nwind,ncrace,ncfila,narc,ncarc,nwcarc,nwrace,nwwind,
     &  nwcrace,nwarc,ncoil,newclc,
     &  nrbar,nwrbar,nthwir,nwthwir,nmagcyl,kwave,iforcegrid,modegui,nbrnmat

      character(256) unducomment
      character(512) cundutit
      character(16) chuvers

      character, dimension (:,:), allocatable :: chmags, chmoths,
     &  chmagsm,chmothsm,chmagsi,chmothsi,chmagpols,chmothso

      character(32) chmag,chmoth,chforcemag

      namelist/undumagn/
     &  maxiter,maxiterrec,maxiteriron,nchiiron,ibulk,iunduplot,kcomment,
     &  krunnum,kdate,ktetmesh,kesti,
     &  kplsym,nxmap,intmaglis,noduplis,nymap,nzmap
     &  ,mode,kdumpconv,dxmap,
     &  unduplot_phi,unduplot_theta,traxyz_theta,traxyz_phi,
     &  xmapmin,xmapmax,ymapmin,ymapmax,zmapmin,zmapmax,
     &  xconvmin,xconvmax,dxconv,nxconv,yconv,zconv,hconv,kpreset,uwindow,matrix,nuthreads,
     &  xminpl,xmaxpl,yminpl,ymaxpl,zminpl,zmaxpl,
     &  ixsym,iysym,izsym,xsym,
     &  xbeff,xbeffy,xbeffz,perlen,nxbeff,kbeffmode,kurad,ebeam,zslit,xcenter,
     &  xelec,yelec,zelec,vxelec,vyelec,vzelec,
     &  ds,xf,yf,zf,efx,efy,efz,xobsv,yobsv,zobsv,phelow,phehig,
     &  ieneloss,ivelofield,nphener,nstep,kxcenter,kcalcvars,
     &  dampiron,isimpson,isplinefm,kdisplace,kechocalc,knomagmap,knopolmap,
     &  kmapmode,kmapnohead,knointmap,
     &  iforce,ivrml,iundugeo,idipoles,iforcedip,iplforce,itorque,mbforcex,mbforcey,mbforcez,mfcolor,
     &  ubfcenx,ubfceny,ubfcenz,ubflenx,ubfleny,ubflenz,
     &  utorqcenx,utorqceny,utorqcenz,chforcemag,nwarnbound, iwarnin,iwarn2pi,
     &  killbadmag,corrtiny,cuttiny,hulltiny,randos,randox,randoy,randoz,irecrepl
     &  ,dampfac,hconvbase,hconvexp,chicut,irandmag,kshuffle,
     &  randomx,randomy,randomz,rcvthron,angmaprotx,cenmaprotxy,cenmaprotxz,
     &  bxex,byex,bzex,kbextern,kresiron,resiron,kprint,ndivfboxy,dedgefb,
     &  iforcegrid,kudebug,newclc

      end module undumagf90m
